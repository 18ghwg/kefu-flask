{% extends "service/base.html" %}

{% block title %}å®¢æœå·¥ä½œå° - èŠå¤©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/service/chat_inline.css') }}">
<style>
    /* âš¡ å†å²æ¶ˆæ¯åŠ è½½åŠ¨ç”» */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    
    /* âš¡ æ¶ˆæ¯å®¹å™¨æ— æ„ŸåŠ è½½ä¼˜åŒ– */
    @keyframes fadeInContent {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .chat-messages.loading {
        opacity: 0;
        transition: opacity 0.15s ease;
    }
    
    .chat-messages.loaded {
        animation: fadeInContent 0.15s ease;
    }
    
    /* éª¨æ¶å±æ•ˆæœ */
    @keyframes shimmer {
        0% { background-position: -468px 0; }
        100% { background-position: 468px 0; }
    }
    
    .message-skeleton {
        padding: 12px;
        margin: 8px 15px;
        border-radius: 8px;
        background: linear-gradient(to right, #f0f0f0 8%, #f8f8f8 18%, #f0f0f0 33%);
        background-size: 800px 104px;
        animation: shimmer 1.5s infinite linear;
    }
</style>
{% endblock %}

{% block content %}
<!-- ä¼šè¯åˆ—è¡¨é®ç½©å±‚ -->
<div class="sidebar-overlay" id="chatSidebarOverlay"></div>

<div class="chat-container">
    <!-- è®¿å®¢åˆ—è¡¨ä¾§è¾¹æ  -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
                <h2>ğŸ’¬ ä¼šè¯åˆ—è¡¨</h2>
                <div class="stats">
                    åœ¨çº¿è®¿å®¢: <span id="onlineCount">0</span> | 
                    å¾…å¤„ç†: <span id="pendingCount">0</span>
                </div>
                <div class="stats" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                    å½“å‰æ¥å¾…: <span id="currentWorkload" style="color: #10b981; font-weight: 600;">0</span><span id="maxWorkloadContainer"> / <span id="maxWorkload">5</span></span>
                    <span id="workloadStatus" style="margin-left: 8px; font-size: 12px; padding: 2px 8px; border-radius: 10px; background: #d1fae5; color: #059669;">ç©ºé—²</span>
                </div>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="ğŸ” æœç´¢è®¿å®¢..." id="searchInput">
            </div>

            <!-- Tabåˆ‡æ¢ -->
            <div class="chat-tabs">
                <div class="chat-tab active" onclick="switchTab('current')">
                    å½“å‰ä¼šè¯
                    <span class="chat-tab-badge" id="currentSessionCount">0</span>
                </div>
                <div class="chat-tab" onclick="switchTab('queue')">
                    æ’é˜Ÿåˆ—è¡¨
                    <span class="chat-tab-badge" id="queueCount">0</span>
                </div>
            </div>

            <!-- å½“å‰ä¼šè¯åˆ—è¡¨ -->
            <div class="visitor-list active" id="visitorList">
                <div class="empty-state">
                    <div style="font-size: 48px;">ğŸ‘¥</div>
                    <h3>æš‚æ— ä¼šè¯</h3>
                    <p>ç­‰å¾…è®¿å®¢æ¥å…¥...</p>
                </div>
            </div>
            
            <!-- è®¿å®¢åˆ—è¡¨åˆ†é¡µ -->
            <div id="visitorPagination" style="padding: 12px 15px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #6b7280;">
                    <span>å…± <strong id="visitorTotal">0</strong> ä¸ªè®¿å®¢</span>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="loadVisitorPage(currentVisitorPage - 1)" id="prevPageBtn" 
                                style="padding: 5px 10px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">
                            ä¸Šä¸€é¡µ
                        </button>
                        <span style="padding: 5px 10px;">
                            <span id="currentPageNum">1</span> / <span id="totalPages">1</span>
                        </span>
                        <button onclick="loadVisitorPage(currentVisitorPage + 1)" id="nextPageBtn"
                                style="padding: 5px 10px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer;">
                            ä¸‹ä¸€é¡µ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ’é˜Ÿåˆ—è¡¨ -->
            <div class="queue-list" id="queueList">
                <div class="empty-state">
                    <div style="font-size: 48px;">â³</div>
                    <h3>æš‚æ— æ’é˜Ÿ</h3>
                    <p>æ²¡æœ‰è®¿å®¢åœ¨æ’é˜Ÿ...</p>
                </div>
            </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <!-- ç§»åŠ¨ç«¯åˆ‡æ¢æŒ‰é’® - ç§»åˆ°å¤–å±‚ç¡®ä¿å§‹ç»ˆå¯è§ -->
            <button id="mobileToggle" class="mobile-toggle" style="display: none;">
                <i class="fas fa-bars" id="toggleIcon"></i>
            </button>
            
            <div id="chatContainer" class="empty-state">
                <div style="font-size: 64px;">ğŸ’¬</div>
                <h3>é€‰æ‹©ä¸€ä¸ªè®¿å®¢å¼€å§‹èŠå¤©</h3>
                <p>ä»å·¦ä¾§è®¿å®¢åˆ—è¡¨é€‰æ‹©è¦æ²Ÿé€šçš„è®¿å®¢</p>
            </div>

        <!-- èŠå¤©ç•Œé¢ï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
        <div id="chatInterface" style="display: none;">
                <div class="chat-header">
                    <div class="chat-visitor-info">
                        <div class="chat-visitor-avatar" id="currentVisitorAvatar">ğŸ‘¤</div>
                        <div class="chat-visitor-details">
                            <h3 id="currentVisitorName">è®¿å®¢</h3>
                            <p id="currentVisitorInfo">æ¥æº: ç½‘ç«™é¦–é¡µ</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="toggleVisitorInfo()">â„¹ï¸ ä¿¡æ¯</button>
                        <button class="action-btn" onclick="transferChat()">ğŸ”„ è½¬æ¥</button>
                        <button class="action-btn" onclick="endChat()">âœ“ ç»“æŸ</button>
                        <button class="action-btn" id="blacklistBtn" onclick="toggleBlacklist()" style="display:none;">
                            <span id="blacklistIcon">ğŸš«</span>
                            <span id="blacklistText">æ‹‰é»‘</span>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- âš¡ å†å²æ¶ˆæ¯åŠ è½½æŒ‡ç¤ºå™¨ -->
                    <div id="historyLoadingIndicator" style="display: none; padding: 15px; text-align: center; background: linear-gradient(to right, #f0f9ff, #e0f2fe); border-radius: 8px; margin: 10px; animation: fadeIn 0.3s;">
                        <div style="display: inline-block;">
                            <div class="loading-spinner" style="width: 20px; height: 20px; border: 3px solid #e0f2fe; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle;"></div>
                            <span id="loadingProgressText" style="margin-left: 10px; color: #3b82f6; font-size: 13px; vertical-align: middle;">æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...</span>
                        </div>
                    </div>
                    <!-- æ¶ˆæ¯åŠ¨æ€åŠ è½½ -->
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    è®¿å®¢æ­£åœ¨è¾“å…¥...
                </div>

                <div class="quick-replies">
                    <button class="quick-reply-btn" onclick="sendQuickReply('æ‚¨å¥½ï¼Œæˆ‘æ˜¯å®¢æœï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼')">ğŸ‘‹ æ¬¢è¿è¯­</button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('è¯·ç¨ç­‰ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ä¸€ä¸‹')">â±ï¸ ç¨ç­‰</button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼Œè¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ')">ğŸ’¯ æ„Ÿè°¢</button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('å¾ˆæŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿')">ğŸ˜… æŠ±æ­‰</button>
                </div>

                <div class="chat-input">
                    <div class="input-toolbar">
                    <button id="emojiBtn" class="toolbar-btn" title="è¡¨æƒ…">ğŸ˜Š</button>
                    <button id="imageBtn" class="toolbar-btn" title="å›¾ç‰‡">ğŸ“·</button>
                    <button id="fileBtn" class="toolbar-btn" title="æ–‡ä»¶">ğŸ“</button>
                        <button id="knowledgeBtn" class="toolbar-btn" title="çŸ¥è¯†åº“">ğŸ“š</button>
                    </div>
                    <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ç²˜è´´å›¾ç‰‡..." rows="1"></textarea>
                    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
                    </div>
                    
                    <!-- âœ… è½¬æ¥æç¤ºåŒºåŸŸï¼ˆç®¡ç†å‘˜ä¸“ç”¨ - è½¬æ¥åˆ°æˆ‘ï¼‰ -->
                    <div id="transferHint" style="display: none; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; margin-top: 8px; border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: #92400e; font-weight: 500;">
                                    âš ï¸ <span id="transferHintText">è¯¥è®¿å®¢æ­£ç”±å…¶ä»–å®¢æœæ¥å¾…</span>
                                </div>
                            </div>
                            <button id="transferToMeBtn" onclick="transferVisitorToMe()" 
                                    style="padding: 6px 16px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                ğŸ”„ è½¬æ¥åˆ°æˆ‘
                            </button>
                        </div>
                    </div>
                    
                <!-- æ–‡ä»¶è¾“å…¥ -->
                <input type="file" id="imageInput" style="display: none;" accept="image/*" />
                <input type="file" id="fileInputElem" style="display: none;" />
                <!-- ä¸Šä¼ è¿›åº¦ -->
                <div id="uploadProgress" style="display: none; padding: 10px 20px; background: #f9fafb;">
                    <div style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                        <div id="progressFill" style="height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <span id="progressText" style="font-size: 12px; color: #6b7280; margin-top: 4px; display: block;">ä¸Šä¼ ä¸­... 0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- çŸ¥è¯†åº“å¼¹çª— -->
    <div id="knowledgeModal" class="knowledge-modal" style="display: none;">
        <div class="knowledge-modal-content">
            <div class="knowledge-modal-header">
                <h3>ğŸ“š çŸ¥è¯†åº“å¿«é€ŸæŸ¥è¯¢</h3>
                <button class="close-btn" onclick="closeKnowledgeModal()">Ã—</button>
            </div>
            <div class="knowledge-modal-body">
                <div class="knowledge-search">
                    <input type="text" id="knowledgeSearch" placeholder="ğŸ” æœç´¢å…³é”®è¯..." onkeyup="searchKnowledge()" />
                </div>
                <div class="knowledge-list" id="knowledgeList">
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¿å®¢è¯¦ç»†ä¿¡æ¯ä¾§è¾¹æ  -->
    <div class="visitor-info-panel" id="visitorInfoPanel" style="display: none;">
        <div class="visitor-info-header">
            <h3>è®¿å®¢ä¿¡æ¯</h3>
            <button class="close-btn" onclick="toggleVisitorInfo()">âœ•</button>
        </div>
        <div class="visitor-info-content">
            <div class="info-section">
                <div class="info-item">
                    <span class="info-label">ğŸ‘¤ è®¿å®¢åç§°</span>
                    <span class="info-value" id="infoVisitorName">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ğŸ†” è®¿å®¢ID</span>
                    <span class="info-value" id="infoVisitorId">-</span>
                </div>
            </div>
            
                <div class="info-section">
                    <h4>ğŸŒ ç½‘ç»œä¿¡æ¯</h4>
                    <div class="info-item">
                        <span class="info-label">IPåœ°å€</span>
                        <span class="info-value" id="infoIP">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">åœ°ç†ä½ç½®</span>
                        <span class="info-value" id="infoLocation">-</span>
                    </div>
                </div>
            
            <div class="info-section">
                <h4>ğŸ’» è®¾å¤‡ä¿¡æ¯</h4>
                <div class="info-item">
                    <span class="info-label">æµè§ˆå™¨</span>
                    <span class="info-value" id="infoBrowser">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ“ä½œç³»ç»Ÿ</span>
                    <span class="info-value" id="infoOS">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è®¾å¤‡ç±»å‹</span>
                    <span class="info-value" id="infoDevice">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å±å¹•åˆ†è¾¨ç‡</span>
                    <span class="info-value" id="infoResolution">-</span>
                </div>
            </div>
            
            <div class="info-section">
                <h4>ğŸ“Š è®¿é—®ç»Ÿè®¡</h4>
                <div class="info-item">
                    <span class="info-label">è®¿é—®æ¬¡æ•°</span>
                    <span class="info-value" id="infoVisitCount">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¦–æ¬¡è®¿é—®</span>
                    <span class="info-value" id="infoFirstVisit">-</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <!-- Socket.IO å®¢æˆ·ç«¯ -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/emoji-picker.css') }}">
    <script src="{{ url_for('static', filename='js/vendor/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/emoji-picker.js') }}"></script>

<script>
    // ========== å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰å’Œæ¸…æ´ ==========
    
    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // HTMLæ¸…æ´å‡½æ•°ï¼ˆé˜²æ­¢XSSï¼Œä½†å…è®¸å®‰å…¨çš„HTMLæ ‡ç­¾ï¼‰
    // ğŸ›¡ï¸ å¢å¼ºç‰ˆï¼šæ”¯æŒå®‰å…¨çš„HTMLæ ‡ç­¾ç™½åå•ï¼ˆç”¨äºæœºå™¨äººæ¶ˆæ¯ï¼‰
    function sanitizeHtml(html) {
        if (!html) return '';
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // ç§»é™¤å±é™©æ ‡ç­¾ï¼ˆä¿ç•™å®‰å…¨æ ‡ç­¾ï¼ša, p, br, strong, em, u, b, iï¼‰
        temp.querySelectorAll('script, style, iframe, object, embed, form, input, button, link, meta').forEach(el => el.remove());
        
        // ç§»é™¤å±é™©å±æ€§ï¼ˆä¿ç•™å®‰å…¨å±æ€§ï¼šhref, title, target, styleçš„æŸäº›å®‰å…¨å±æ€§ï¼‰
        temp.querySelectorAll('*').forEach(el => {
            Array.from(el.attributes).forEach(attr => {
                // ç§»é™¤æ‰€æœ‰on*äº‹ä»¶å¤„ç†å™¨å’Œå±é™©å±æ€§
                if (attr.name.startsWith('on') || attr.name === 'formaction' || attr.name === 'form') {
                    el.removeAttribute(attr.name);
                }
            });
            
            // æ¸…ç†é“¾æ¥ï¼šåªå…è®¸http/https/mailtoåè®®
            if (el.tagName === 'A' && el.hasAttribute('href')) {
                const href = el.getAttribute('href');
                if (href && !href.match(/^(https?:|mailto:)/i)) {
                    el.removeAttribute('href');
                }
                // å¤–éƒ¨é“¾æ¥æ·»åŠ å®‰å…¨å±æ€§
                if (href && href.match(/^https?:/i)) {
                    el.setAttribute('target', '_blank');
                    el.setAttribute('rel', 'noopener noreferrer');
                }
            }
        });
        
        return temp.innerHTML;
    }
    
    // âš¡ æ¶ˆæ¯æ ¼å¼åŒ–ç¼“å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–2025-10-26ï¼‰
    const messageFormatCache = new Map();
    const MAX_CACHE_SIZE = 100;
    
    // æ ¼å¼åŒ–æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆå¤„ç†æ–‡ä»¶ã€å›¾ç‰‡ã€Emojiç­‰ç‰¹æ®Šç±»å‹ï¼‰
    function formatLastMessage(content) {
        if (!content) return '';
        
        // âš¡ æ£€æŸ¥ç¼“å­˜ï¼ˆé¿å…é‡å¤æ ¼å¼åŒ–ï¼‰
        if (messageFormatCache.has(content)) {
            return messageFormatCache.get(content);
        }
        
        let result = '';
        
        try {
            // å°è¯•è§£æJSONï¼ˆæ–‡ä»¶ã€å›¾ç‰‡ç­‰ï¼‰
            const parsed = JSON.parse(content);
            
            // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
            if (parsed.type === 'image') {
                result = '[å›¾ç‰‡]';
            } else if (parsed.type === 'file') {
                if (parsed.mime_type && parsed.mime_type.startsWith('image/')) {
                    result = '[å›¾ç‰‡]';
                } else {
                    result = '[æ–‡ä»¶]';
                }
            } else if (parsed.url) {
                if (parsed.mime_type) {
                    result = parsed.mime_type.startsWith('image/') ? '[å›¾ç‰‡]' : '[æ–‡ä»¶]';
                } else {
                    const url = parsed.url.toLowerCase();
                    const imageExts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
                    result = imageExts.some(ext => url.includes(ext)) ? '[å›¾ç‰‡]' : '[æ–‡ä»¶]';
                }
            } else {
                const jsonStr = JSON.stringify(parsed);
                result = jsonStr.length > 20 ? jsonStr.substring(0, 20) + '...' : jsonStr;
            }
        } catch (e) {
            // ä¸æ˜¯JSONæ ¼å¼ï¼Œå¤„ç†ä¸ºæ™®é€šæ–‡æœ¬
            let trimmedContent = content.trim();
            
            // âœ… ç§»é™¤HTMLæ ‡ç­¾ï¼ˆç‰¹åˆ«æ˜¯æœºå™¨äººå›å¤ä¸­çš„<p>æ ‡ç­¾ç­‰ï¼‰
            trimmedContent = trimmedContent.replace(/<[^>]+>/g, '').trim();
            
            // âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šåªå¯¹çŸ­æ–‡æœ¬è¿›è¡ŒEmojiæ£€æµ‹ï¼ˆé¿å…é•¿æ–‡æœ¬æ­£åˆ™åŒ¹é…è€—æ—¶ï¼‰
            const maxEmojiCheckLength = 50;
            if (trimmedContent.length <= maxEmojiCheckLength) {
                const emojiRegex = /^[\p{Emoji}\u200d]+$/u;
                if (emojiRegex.test(trimmedContent)) {
                    result = trimmedContent.length > 3 
                        ? trimmedContent.substring(0, 3) + '...' 
                        : trimmedContent;
                } else {
                    result = trimmedContent.length > 20 
                        ? trimmedContent.substring(0, 20) + '...' 
                        : trimmedContent;
                }
            } else {
                result = trimmedContent.substring(0, 20) + '...';
            }
        }
        
        // âš¡ ç¼“å­˜ç»“æœï¼ˆé™åˆ¶ç¼“å­˜å¤§å°ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        if (messageFormatCache.size >= MAX_CACHE_SIZE) {
            const firstKey = messageFormatCache.keys().next().value;
            messageFormatCache.delete(firstKey);
        }
        messageFormatCache.set(content, result);
        
        return result;
    }
    
    // å®¢æœä¿¡æ¯ï¼ˆä»Flaskæ¨¡æ¿æ³¨å…¥ï¼‰
    const serviceId = {{ current_user.service_id if current_user.service_id else 'null' }};
    const serviceName = '{{ current_user.nick_name }}';
    const userLevel = '{{ current_user.level }}';  // ç”¨æˆ·æƒé™çº§åˆ«
    let socket = null;
    let currentVisitorId = null;
    
    // âœ… éªŒè¯å®¢æœID
    if (!serviceId) {
        console.error('âŒ å½“å‰ç”¨æˆ·æ²¡æœ‰service_idï¼Œæ— æ³•ä½¿ç”¨å®¢æœå·¥ä½œå°');
        alert('å½“å‰è´¦å·ä¸æ˜¯å®¢æœè´¦å·ï¼Œæ— æ³•ä½¿ç”¨å®¢æœå·¥ä½œå°ã€‚è¯·ä½¿ç”¨å®¢æœè´¦å·ç™»å½•ã€‚');
    }
    let visitors = {}; // å­˜å‚¨è®¿å®¢ä¿¡æ¯
    let unreadCounts = {}; // âš¡ å­˜å‚¨æ¯ä¸ªè®¿å®¢çš„æœªè¯»æ¶ˆæ¯æ•°ï¼ˆæŒä¹…åŒ–ï¼Œä¸ä¼šå› ä¸ºåˆ—è¡¨åˆ·æ–°è€Œä¸¢å¤±ï¼‰
    let typingTimeout = null;
    
    // è®¿å®¢åˆ—è¡¨åˆ†é¡µç›¸å…³å˜é‡
    let currentVisitorPage = 1;
    let totalVisitorPages = 1;
    let visitorPerPage = 20;

        // âš¡ æœªè¯»æ¶ˆæ¯è½®è¯¢å®šæ—¶å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šæ›¿ä»£å®æ—¶æ¨é€ï¼‰
        let unreadPollingTimer = null;
        const UNREAD_POLLING_INTERVAL = 8000; // 8ç§’è½®è¯¢ä¸€æ¬¡
        
        // âš¡ è®¿å®¢åˆ—è¡¨è½®è¯¢å®šæ—¶å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šæ›¿ä»£äº‹ä»¶é©±åŠ¨åˆ·æ–°ï¼‰
        let visitorListPollingTimer = null;
        const VISITOR_LIST_POLLING_INTERVAL = 30000; // 30ç§’è½®è¯¢ä¸€æ¬¡
        let visitorListLoadPending = false; // é˜²æŠ–ï¼šæ˜¯å¦æœ‰å¾…å¤„ç†çš„åŠ è½½è¯·æ±‚

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            initInput();
            initChatScroll();  // âœ… åˆå§‹åŒ–èŠå¤©æ»šåŠ¨ç›‘å¬
            startUnreadMessagePolling();  // âš¡ å¯åŠ¨æœªè¯»æ¶ˆæ¯è½®è¯¢
            startVisitorListPolling();  // âš¡ å¯åŠ¨è®¿å®¢åˆ—è¡¨è½®è¯¢
            // âœ… è®¿å®¢åˆ—è¡¨åŠ è½½å»¶è¿Ÿåˆ°Socketè¿æ¥æˆåŠŸå
        });
        
        // âš¡ é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (unreadPollingTimer) {
                clearInterval(unreadPollingTimer);
            }
            if (visitorListPollingTimer) {
                clearInterval(visitorListPollingTimer);
            }
        });

    // âš¡ å¯åŠ¨æœªè¯»æ¶ˆæ¯è½®è¯¢ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šæ›¿ä»£å®æ—¶WebSocketæ¨é€ï¼‰
    function startUnreadMessagePolling() {
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        fetchUnreadMessages();
        
        // æ¯8ç§’è½®è¯¢ä¸€æ¬¡
        unreadPollingTimer = setInterval(function() {
            fetchUnreadMessages();
        }, UNREAD_POLLING_INTERVAL);
        
        console.log('âš¡ æœªè¯»æ¶ˆæ¯è½®è¯¢å·²å¯åŠ¨ (æ¯' + (UNREAD_POLLING_INTERVAL/1000) + 'ç§’)');
    }
    
    // âš¡ è·å–æœªè¯»æ¶ˆæ¯æ•°
    function fetchUnreadMessages() {
        fetch('/api/service/unread_messages', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 0) {
                const unreadCount = data.data.unread_count || 0;
                updateUnreadBadge(unreadCount);
                console.log('ğŸ“¬ æœªè¯»æ¶ˆæ¯æ•°å·²æ›´æ–°:', unreadCount);
            } else {
                console.error('âŒ è·å–æœªè¯»æ¶ˆæ¯æ•°å¤±è´¥:', data.msg);
            }
        })
        .catch(error => {
            console.error('âŒ æœªè¯»æ¶ˆæ¯è½®è¯¢å¤±è´¥:', error);
        });
    }
    
    // âš¡ æ›´æ–°å…¨å±€æœªè¯»æ¶ˆæ¯å¾½ç« æ˜¾ç¤ºï¼ˆä¸åŒ…æ‹¬è®¿å®¢åˆ—è¡¨é‡Œçš„æœªè¯»å¾½ç« ï¼‰
    function updateUnreadBadge(count) {
        // âš¡ ä¿®å¤ï¼šåªæ›´æ–°å¯¼èˆªæ çš„å…¨å±€æœªè¯»å¾½ç« ï¼Œä¸è¦å½±å“è®¿å®¢åˆ—è¡¨é‡Œçš„è®¿å®¢æœªè¯»å¾½ç« 
        // è®¿å®¢åˆ—è¡¨é‡Œçš„æœªè¯»å¾½ç« ç”± updateVisitorUnread() å‡½æ•°å•ç‹¬ç®¡ç†
        const globalBadge = document.getElementById('unreadMessageCount');
        
        if (globalBadge) {
            if (count > 0) {
                globalBadge.textContent = count > 99 ? '99+' : count;
                globalBadge.style.display = 'inline-block';
            } else {
                globalBadge.style.display = 'none';
            }
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
        if (count > 0) {
            if (!document.title.startsWith('(')) {
                document.title = `(${count > 99 ? '99+' : count}) ` + document.title;
            }
        } else {
            // ç§»é™¤æ ‡é¢˜ä¸­çš„æœªè¯»æ•°
            document.title = document.title.replace(/^\(\d+\+?\)\s*/, '');
        }
    }

    // åˆå§‹åŒ–Socket.IOè¿æ¥
    function initSocket() {
        socket = io({
            transports: ['websocket', 'polling']
        });

        socket.on('connect', function() {
            console.log('Socket connected:', socket.id);
            
            // âœ… åªæœ‰æœ‰æ•ˆçš„serviceIdæ‰å‘é€joinäº‹ä»¶
            if (serviceId) {
                console.log('âœ… å‘é€ service_join:', { service_id: serviceId, service_name: serviceName });
                socket.emit('service_join', {
                    service_id: serviceId,
                    service_name: serviceName
                });
            } else {
                console.error('âŒ serviceId æ— æ•ˆï¼Œè·³è¿‡ service_join');
            }
        });

        socket.on('join_success', function(data) {
            console.log('Join success:', data);
            
            // âœ… Socketè¿æ¥æˆåŠŸåï¼ŒåŠ è½½è®¿å®¢åˆ—è¡¨
            console.log('ğŸ”„ Socketè¿æ¥æˆåŠŸï¼Œå¼€å§‹åŠ è½½è®¿å®¢åˆ—è¡¨...');
            loadVisitorPage(1);
        });
        
        // âœ… ç›‘å¬æœªè¯»æ•°é‡æ›´æ–°äº‹ä»¶ï¼ˆå®¢æœå›å¤åç«‹å³æ¸…é›¶ï¼‰
        socket.on('unread_count_updated', function(data) {
            console.log('ğŸ“¬ æœªè¯»æ•°é‡æ›´æ–°:', data);
            const visitorId = data.visitor_id;
            const unreadCount = data.unread_count;
            
            // æ›´æ–°è®¿å®¢åˆ—è¡¨ä¸­çš„æœªè¯»è§’æ ‡
            const visitorItem = document.getElementById('visitor_' + visitorId);
            if (visitorItem) {
                const unreadBadge = visitorItem.querySelector('.unread-badge');
                if (unreadBadge) {
                    if (unreadCount > 0) {
                        unreadBadge.textContent = unreadCount;
                        unreadBadge.style.display = 'inline-block';
                    } else {
                        unreadBadge.style.display = 'none';
                    }
                    console.log(`âœ… å·²æ›´æ–°è®¿å®¢${visitorId}çš„æœªè¯»è§’æ ‡: ${unreadCount}`);
                }
            }
        });

        socket.on('new_visitor', function(data) {
            console.log('New visitor (å®Œæ•´æ•°æ®):', data);
            console.log('  - Browser:', data.browser);
            console.log('  - OS:', data.os);
            console.log('  - Device:', data.device);
            
            // âœ… æ–°è®¿å®¢æ¥å…¥æ—¶çš„å¤„ç†
            if (currentVisitorPage === 1) {
                // å¦‚æœå½“å‰åœ¨ç¬¬ä¸€é¡µï¼Œç›´æ¥æ·»åŠ åˆ°é¡¶éƒ¨
                addVisitorToList(data, true);  // trueè¡¨ç¤ºæ’å…¥åˆ°é¡¶éƒ¨
            } else {
                // å¦‚æœä¸åœ¨ç¬¬ä¸€é¡µï¼Œæç¤ºç”¨æˆ·å¹¶å¯é€‰æ‹©è·³è½¬
                console.log('ğŸ“Œ æ–°è®¿å®¢æ¥å…¥ï¼Œä½†å½“å‰ä¸åœ¨ç¬¬ä¸€é¡µ');
                // å¯é€‰ï¼šæ˜¾ç¤ºæç¤ºæˆ–è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€é¡µ
                // loadVisitorPage(1);
            }
            
            updateStats();
        });

        socket.on('receive_message', function(data) {
            console.log('ğŸ“¨ Received message:', data);
            
            // âœ… ç¡®å®šè®¿å®¢IDï¼ˆè®¿å®¢å‘é€æ—¶ç”¨from_idï¼Œæœºå™¨äºº/å®¢æœå‘é€æ—¶ç”¨to_idï¼‰
            const visitorId = data.from_type === 'visitor' ? data.from_id : data.to_id;
            console.log('  ğŸ“ Visitor ID:', visitorId);
            console.log('  ğŸ“ Current Visitor ID:', currentVisitorId);
            console.log('  ğŸ“ Message Type:', data.from_type);
            
            // å¦‚æœæ˜¯è®¿å®¢å‘æ¥çš„æ¶ˆæ¯ï¼Œè§¦å‘æç¤º
            if (data.from_type === 'visitor') {
                // æ’­æ”¾æç¤ºéŸ³
                playNotificationSound();
                
                // æ ‡é¢˜é—ªçƒ
                startTitleFlash(data.content);
                
                // âœ… è®¿å®¢ç½®é¡¶ï¼ˆå†å²è®¿å®¢å†æ¬¡å’¨è¯¢æ—¶ï¼‰
                bringVisitorToTop(visitorId);
                
                // æ¡Œé¢é€šçŸ¥ï¼ˆå¦‚æœä¸åœ¨å½“å‰èŠå¤©çª—å£ï¼‰
                if (!isPageVisible || currentVisitorId != visitorId) {
                    const visitorName = visitors[visitorId]?.visitor_name || data.from_name || 'è®¿å®¢';
                    const messagePreview = data.content.length > 30 ? data.content.substring(0, 30) + '...' : data.content;
                    showDesktopNotification(`æ–°æ¶ˆæ¯æ¥è‡ª ${visitorName}`, messagePreview);
                }
            }
            
            // å¦‚æœè®¿å®¢ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
            if (!visitors[visitorId] && data.from_type === 'visitor') {
                const newVisitor = {
                    visitor_id: visitorId,
                    visitor_name: data.from_name || 'è®¿å®¢' + visitorId.slice(-4),
                    is_active: true  // æ­£åœ¨å‘é€æ¶ˆæ¯çš„è®¿å®¢æ ‡è®°ä¸ºæ´»è·ƒ
                };
                // åªæœ‰åœ¨ç¬¬ä¸€é¡µæ—¶æ‰æ·»åŠ ï¼Œå¦åˆ™ä¼šç ´ååˆ†é¡µé€»è¾‘
                if (currentVisitorPage === 1) {
                    addVisitorToList(newVisitor, true);  // æ’å…¥åˆ°é¡¶éƒ¨
                }
            }
            
            // æ›´æ–°è®¿å®¢åˆ—è¡¨ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯
            const visitorItem = document.getElementById('visitor_' + visitorId);
            if (visitorItem) {
                const lastMsgEl = visitorItem.querySelector('.visitor-last-msg');
                if (lastMsgEl) {
                    // âš¡ æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¸¦é”™è¯¯ä¿æŠ¤ï¼‰
                    try {
                        let displayContent = formatLastMessage(data.content);
                        // âœ… å¦‚æœæ˜¯æœºå™¨äººæ¶ˆæ¯ï¼Œæ·»åŠ ğŸ¤–å›¾æ ‡
                        if (data.from_type === 'robot') {
                            displayContent = 'ğŸ¤– ' + displayContent;
                        }
                        lastMsgEl.textContent = displayContent;
                    } catch (e) {
                        console.error('æ ¼å¼åŒ–æ¶ˆæ¯å¤±è´¥:', e, data.content);
                        lastMsgEl.textContent = '[æ¶ˆæ¯æ ¼å¼é”™è¯¯]';
                    }
                }
            }
            
            // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„è®¿å®¢ï¼Œç›´æ¥æ˜¾ç¤ºæ¶ˆæ¯
            if (visitorId == currentVisitorId) {
                console.log('  âœ… æ˜¾ç¤ºæ¶ˆæ¯ç»™å½“å‰è®¿å®¢');
                // âœ… æ ¹æ®from_typeåˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ŒåŒ…æ‹¬æœºå™¨äºº
                if (data.from_type === 'robot') {
                    console.log('  ğŸ¤– æ¸²æŸ“æœºå™¨äººæ¶ˆæ¯');
                    addRobotMessage(data.content, data.timestamp);
                } else {
                    console.log('  ğŸ‘¤ æ¸²æŸ“æ™®é€šæ¶ˆæ¯');
                    const msgType = data.from_type === 'visitor' ? 'visitor' : 'service';
                    // âœ… ä¼ é€’è®¿å®¢åç§°
                    const fromName = data.from_type === 'visitor' ? data.from_name : null;
                    addMessage(data.content, msgType, data.timestamp, data.msg_type, fromName);
                }
            } else {
                console.log('  â­ï¸ ä¸æ˜¯å½“å‰è®¿å®¢ï¼Œåªæ›´æ–°æœªè¯»');
                // âš¡ åªæœ‰è®¿å®¢å‘é€çš„æ¶ˆæ¯æ‰å¢åŠ æœªè¯»æ•°
                if (data.from_type === 'visitor') {
                    updateVisitorUnread(visitorId);
                }
            }
        });

        socket.on('user_typing', function(data) {
            if (data.from_id == currentVisitorId) {
                const typingIndicator = document.getElementById('typingIndicator');
                if (data.is_typing) {
                    typingIndicator.classList.add('show');
                } else {
                    typingIndicator.classList.remove('show');
                }
            }
        });

        socket.on('user_offline', function(data) {
            if (data.user_type === 'visitor') {
                removeVisitorFromList(data.user_id);
                updateStats();
            }
        });

        socket.emit('get_online_users');
        socket.on('online_users_list', function(data) {
            console.log('Online users:', data);
            console.log('åœ¨çº¿è®¿å®¢æ•°é‡:', data.visitors ? data.visitors.length : 0);
            
            // âœ… ä¸å†è‡ªåŠ¨æ·»åŠ è®¿å®¢åˆ°åˆ—è¡¨ï¼Œè®¿å®¢åˆ—è¡¨ç”±åˆ†é¡µAPIç®¡ç†
            // åªæ›´æ–°åœ¨çº¿çŠ¶æ€å’Œç»Ÿè®¡æ•°æ®
            if (data.visitors) {
                // æ ‡è®°åœ¨çº¿è®¿å®¢ï¼ˆå¯é€‰ï¼šæ›´æ–°è®¿å®¢çš„åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºï¼‰
                data.visitors.forEach(visitor => {
                    if (visitors[visitor.visitor_id]) {
                        visitors[visitor.visitor_id].is_online = true;
                    }
                });
            }
            
            updateStats();
            
            // âœ… å¦‚æœè®¿å®¢åˆ—è¡¨ä¸ºç©ºï¼Œè§¦å‘åŠ è½½ç¬¬ä¸€é¡µ
            const visitorList = document.getElementById('visitorList');
            if (!visitorList.querySelector('.visitor-item')) {
                console.log('ğŸ“‹ è®¿å®¢åˆ—è¡¨ä¸ºç©ºï¼ŒåŠ è½½ç¬¬ä¸€é¡µ...');
                loadVisitorPage(1);
            }
        });
        
        // ç›‘å¬è®¿å®¢ä¿¡æ¯æ›´æ–°
        socket.on('visitor_info_updated', function(data) {
            console.log('è®¿å®¢ä¿¡æ¯å·²æ›´æ–°:', data);
            const visitorId = data.visitor_id;
            
            // æ›´æ–°visitorså¯¹è±¡ä¸­çš„ä¿¡æ¯
            if (visitors[visitorId]) {
                visitors[visitorId].ip = data.ip;
                visitors[visitorId].location = data.location;
                visitors[visitorId].country = data.country;
                visitors[visitorId].province = data.province;
                visitors[visitorId].city = data.city;
                visitors[visitorId].browser = data.browser;
                visitors[visitorId].os = data.os;
                visitors[visitorId].device = data.device;
                visitors[visitorId].screen_resolution = data.screen_resolution;
                
                console.log('å·²æ›´æ–°è®¿å®¢ä¿¡æ¯:', visitorId, visitors[visitorId]);
                
                // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥è®¿å®¢çš„ä¿¡æ¯é¢æ¿ï¼Œå®æ—¶æ›´æ–°æ˜¾ç¤º
                if (currentVisitorId === visitorId) {
                    const panel = document.getElementById('visitorInfoPanel');
                    if (panel && panel.style.display !== 'none') {
                        document.getElementById('infoIP').textContent = data.ip || '-';
                        document.getElementById('infoLocation').textContent = data.location || data.country || 'æœªçŸ¥';
                        document.getElementById('infoBrowser').textContent = data.browser || 'Unknown';
                        document.getElementById('infoOS').textContent = data.os || 'Unknown';
                        document.getElementById('infoDevice').textContent = data.device || 'Desktop';
                        document.getElementById('infoResolution').textContent = data.screen_resolution || '-';
                        console.log('è®¿å®¢ä¿¡æ¯é¢æ¿å·²å®æ—¶æ›´æ–°');
                    }
                }
            }
        });
        
        // ========== ç›‘å¬è®¿å®¢é‡æ–°åˆ†é…äº‹ä»¶ ==========
        socket.on('visitor_assignment_updated', function(data) {
            console.log('ğŸ”„ è®¿å®¢åˆ†é…çŠ¶æ€æ›´æ–°:', data);
            
            const visitorId = data.visitor_id;
            // âœ… æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœ new_service_id ç­‰äºå½“å‰å®¢æœIDï¼Œåˆ™åˆ†é…ç»™æˆ‘
            const assignedToMe = data.new_service_id === serviceId || data.assigned_to_me === true;
            const canReply = assignedToMe || (data.can_reply !== false);
            const serviceName = data.new_service_name || data.service_name;
            
            // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥è®¿å®¢çš„å¯¹è¯
            if (currentVisitorId === visitorId) {
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                
                if (assignedToMe && canReply) {
                    // è®¿å®¢åˆ†é…ç»™æˆ‘äº†ï¼Œè§£é”è¾“å…¥æ¡†
                    console.log('âœ… è®¿å®¢å·²åˆ†é…ç»™æˆ‘ï¼Œè§£é”è¾“å…¥æ¡†');
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                        messageInput.style.background = '';
                    }
                    if (sendBtn) {
                        sendBtn.disabled = false;
                    }
                    
                    // âœ… éšè—è½¬æ¥æç¤º
                    const transferHint = document.getElementById('transferHint');
                    if (transferHint) {
                        transferHint.style.display = 'none';
                    }
                    
                    // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                    addSystemMessage(`âœ… ${data.message || 'è®¿å®¢å·²åˆ†é…ç»™æ‚¨'}`);
                    
                    // æ’­æ”¾æç¤ºéŸ³
                    playNotificationSound();
                } else {
                    // è®¿å®¢è¢«åˆ†é…ç»™å…¶ä»–å®¢æœï¼Œé”å®šè¾“å…¥æ¡†
                    console.log('ğŸ”’ è®¿å®¢å·²åˆ†é…ç»™å…¶ä»–å®¢æœï¼Œé”å®šè¾“å…¥æ¡†');
                    if (messageInput) {
                        messageInput.disabled = true;
                        messageInput.placeholder = `è¯¥è®¿å®¢æ­£ç”±å®¢æœ ${serviceName} æ¥å¾…`;
                        messageInput.style.background = '#f5f5f5';
                    }
                    if (sendBtn) {
                        sendBtn.disabled = true;
                    }
                    
                    // âœ… ç®¡ç†å‘˜æ˜¾ç¤º"è½¬æ¥åˆ°æˆ‘"æŒ‰é’®
                    const isManager = {{ 'true' if current_user.level in ['super_manager', 'manager'] else 'false' }};
                    const transferHint = document.getElementById('transferHint');
                    const transferHintText = document.getElementById('transferHintText');
                    const transferToMeBtn = document.getElementById('transferToMeBtn');
                    
                    if (isManager && transferHint && transferHintText) {
                        transferHintText.textContent = `è¯¥è®¿å®¢æ­£ç”±å®¢æœ ${serviceName} æ¥å¾…`;
                        transferHint.style.display = 'block';
                        
                        // âœ… é‡ç½®æŒ‰é’®çŠ¶æ€ï¼ˆé˜²æ­¢ä¸Šæ¬¡è½¬æ¥åæŒ‰é’®è¿˜æ˜¯ç¦ç”¨çŠ¶æ€ï¼‰
                        if (transferToMeBtn) {
                            transferToMeBtn.disabled = false;
                            transferToMeBtn.textContent = 'ğŸ”„ è½¬æ¥åˆ°æˆ‘';
                        }
                        
                        console.log('âœ… ç®¡ç†å‘˜è½¬æ¥æŒ‰é’®å·²æ˜¾ç¤º');
                    }
                    
                    // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                    if (data.reason === 'reassigned_away') {
                        addSystemMessage(`âš ï¸ ${data.message || 'è®¿å®¢å·²è¢«é‡æ–°åˆ†é…'}`);
                    }
                }
                
                // é‡æ–°æ£€æŸ¥å›å¤æƒé™ï¼ˆç¡®ä¿çŠ¶æ€åŒæ­¥ï¼‰
                setTimeout(() => {
                    checkReplyPermission(visitorId);
                }, 500);
            }
            
            // æ›´æ–°è®¿å®¢åˆ—è¡¨ä¸­çš„åˆ†é…çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (data.visitor) {
                const visitorData = data.visitor;
                if (visitors[visitorId]) {
                    // æ›´æ–°è®¿å®¢å¯¹è±¡
                    Object.assign(visitors[visitorId], visitorData);
                }
            }
        });
        
        // ========== é˜Ÿåˆ—ç®¡ç†Socket.IOäº‹ä»¶ç›‘å¬ ==========
        
        // æ–°è®¿å®¢æ’é˜Ÿé€šçŸ¥
        socket.on('new_visitor_queued', function(data) {
            console.log('ğŸ”” æ–°è®¿å®¢æ’é˜Ÿ:', data);
            
            // æ’­æ”¾æç¤ºéŸ³
            playNotificationSound();
            
            // æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥
            showDesktopNotification(
                'æ–°è®¿å®¢æ’é˜Ÿ',
                `${data.visitor_name} (${data.priority_text}) å·²åŠ å…¥é˜Ÿåˆ—ï¼Œæ’é˜Ÿä½ç½® #${data.position}`
            );
            
            // åˆ·æ–°æ’é˜Ÿåˆ—è¡¨
            if (document.getElementById('queueList').style.display !== 'none') {
                loadQueueList();
            }
            
            // æ›´æ–°é˜Ÿåˆ—å¾½ç« 
            const queueCount = document.getElementById('queueCount');
            const currentCount = parseInt(queueCount.textContent) || 0;
            queueCount.textContent = currentCount + 1;
            
            // é—ªçƒæç¤º
            queueCount.style.animation = 'pulse 1s ease-in-out 3';
        });
        
        // é˜Ÿåˆ—æ›´æ–°äº‹ä»¶
        socket.on('queue_update', function(data) {
            console.log('ğŸ“Š é˜Ÿåˆ—æ›´æ–°:', data);
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            if (data.stats) {
                document.getElementById('pendingCount').textContent = data.stats.waiting_count || 0;
                document.getElementById('queueCount').textContent = data.stats.waiting_count || 0;
            }
            
            // å¦‚æœæ­£åœ¨æŸ¥çœ‹æ’é˜Ÿåˆ—è¡¨ï¼Œåˆ·æ–°
            if (document.getElementById('queueList').style.display !== 'none') {
                loadQueueList();
            }
            
            // ç›‘å¬é˜Ÿåˆ—æ›´æ–°ï¼ŒåŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”
            const newQueueSize = data.waiting_count || 0;
            if (newQueueSize !== currentQueueSize) {
                currentQueueSize = newQueueSize;
                startQueueStatusCheck(); // é‡å¯å®šæ—¶å™¨ï¼Œè°ƒæ•´é—´éš”
            }
        });
        
        // è®¿å®¢ä¼˜å…ˆçº§æ›´æ–°
        socket.on('priority_updated', function(data) {
            console.log('â­ ä¼˜å…ˆçº§æ›´æ–°:', data);
            
            // åˆ·æ–°æ’é˜Ÿåˆ—è¡¨
            if (document.getElementById('queueList').style.display !== 'none') {
                loadQueueList();
            }
        });
        
        // å®¢æœæ¥å…¥æˆåŠŸ
        socket.on('queue_accepted', function(data) {
            console.log('âœ… æ¥å…¥æˆåŠŸ:', data);
            
            // åˆ·æ–°å½“å‰ä¼šè¯åˆ—è¡¨
            loadVisitorList();
            
            // åˆ·æ–°æ’é˜Ÿåˆ—è¡¨
            if (document.getElementById('queueList').style.display !== 'none') {
                loadQueueList();
            }
            
            // æ˜¾ç¤ºæç¤º
            showToast('è®¿å®¢æ¥å…¥æˆåŠŸï¼', 'success');
        });
        
        // æ¥æ”¶ä¼šè¯è¶…æ—¶é€šçŸ¥
        socket.on('session_timeout', function(data) {
            console.log('â±ï¸ ä¼šè¯è¶…æ—¶:', data);
            
            // å¦‚æœæ˜¯å½“å‰è®¿å®¢çš„ä¼šè¯è¶…æ—¶
            if (data.visitor_id === currentVisitorId) {
                showToast('ä¼šè¯å·²è¶…æ—¶è‡ªåŠ¨ç»“æŸ', 'warning');
                addSystemMessage('ä¼šè¯å·²è¶…æ—¶');
                
                // ä»è®¿å®¢åˆ—è¡¨ç§»é™¤
                removeVisitorFromList(data.visitor_id);
                
                // æ¸…ç©ºå½“å‰è®¿å®¢
                currentVisitorId = null;
                document.getElementById('chatMessages').innerHTML = '';
            } else {
                // å…¶ä»–è®¿å®¢çš„ä¼šè¯è¶…æ—¶ï¼Œåªæ›´æ–°åˆ—è¡¨
                removeVisitorFromList(data.visitor_id);
            }
            
            // âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šä¸å†ç«‹å³åˆ·æ–°ï¼Œç­‰å¾…å®šæ—¶è½®è¯¢ï¼ˆ30ç§’ï¼‰è‡ªåŠ¨æ›´æ–°
            // loadVisitorPage(currentVisitorPage);
        });
        
        // æ¥æ”¶è®¿å®¢ç¦»çº¿é€šçŸ¥
        socket.on('visitor_offline', function(data) {
            console.log('ğŸ‘‹ è®¿å®¢ç¦»çº¿:', data);
            
            // å¦‚æœæ˜¯å½“å‰æ­£åœ¨èŠå¤©çš„è®¿å®¢
            if (data.visitor_id === currentVisitorId) {
                showToast('è®¿å®¢å·²ç¦»çº¿ï¼Œä¼šè¯è‡ªåŠ¨å…³é—­', 'info');
                addSystemMessage('è®¿å®¢å·²ç¦»çº¿');
                
                // ä»è®¿å®¢åˆ—è¡¨ç§»é™¤
                removeVisitorFromList(data.visitor_id);
                
                // æ¸…ç©ºå½“å‰è®¿å®¢
                currentVisitorId = null;
                document.getElementById('chatInterface').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
            } else {
                // å…¶ä»–è®¿å®¢ç¦»çº¿ï¼Œåªæ›´æ–°åˆ—è¡¨
                removeVisitorFromList(data.visitor_id);
            }
            
            // âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šä¸å†ç«‹å³åˆ·æ–°ï¼Œç­‰å¾…å®šæ—¶è½®è¯¢ï¼ˆ30ç§’ï¼‰è‡ªåŠ¨æ›´æ–°
            // loadVisitorPage(currentVisitorPage);
        });
        
        // ========== æƒé™è¢«æ‹’ç»äº‹ä»¶ ==========
        // ğŸ”¥ å®æ—¶è´Ÿè½½æ›´æ–°ç›‘å¬
        socket.on('workload_update', function(data) {
            console.log('ğŸ“Š å®æ—¶è´Ÿè½½æ›´æ–°:', data);
            if (data.current !== undefined && data.max !== undefined) {
                updateWorkloadDisplay(data.current, data.max);
            }
        });

        socket.on('permission_denied', function(data) {
            console.warn('â›” æƒé™è¢«æ‹’ç»:', data);
            
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const errorMsg = data.msg || 'æ‚¨æ— æƒå›å¤æ­¤è®¿å®¢';
            showToast(errorMsg, 'error');
            
            // ç¦ç”¨è¾“å…¥æ¡†
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            if (messageInput) {
                messageInput.disabled = true;
                messageInput.placeholder = errorMsg;
                messageInput.style.background = '#f5f5f5';
            }
            if (sendBtn) {
                sendBtn.disabled = true;
            }
            
            // å¦‚æœæœ‰åˆ†é…çš„å®¢æœä¿¡æ¯ï¼Œæ˜¾ç¤ºæç¤º
            if (data.assigned_service) {
                addSystemMessage(`è¯¥è®¿å®¢æ­£ç”±å®¢æœ ${data.assigned_service.nick_name} æ¥å¾…ï¼Œæ‚¨æ— æ³•å‘é€æ¶ˆæ¯`);
            }
        });
    }

    // åˆå§‹åŒ–è¾“å…¥æ¡†
    function initInput() {
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
            
            if (currentVisitorId) {
                clearTimeout(typingTimeout);
                
                socket.emit('typing', {
                    from_id: serviceId,
                    from_type: 'service',
                    from_name: serviceName,
                    to_id: currentVisitorId,
                    to_type: 'visitor',
                    is_typing: true
                });

                typingTimeout = setTimeout(function() {
                    socket.emit('typing', {
                        from_id: serviceId,
                        from_type: 'service',
                        to_id: currentVisitorId,
                        to_type: 'visitor',
                        is_typing: false
                    });
                }, 1000);
            }
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            const items = document.querySelectorAll('.visitor-item');
            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(keyword) ? 'flex' : 'none';
            });
        });
    }

    // âš¡ å¯åŠ¨è®¿å®¢åˆ—è¡¨å®šæ—¶è½®è¯¢ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šæ›¿ä»£é¢‘ç¹çš„äº‹ä»¶é©±åŠ¨åˆ·æ–°ï¼‰
    function startVisitorListPolling() {
        // ç«‹å³åŠ è½½ä¸€æ¬¡
        console.log('âš¡ è®¿å®¢åˆ—è¡¨è½®è¯¢å·²å¯åŠ¨ (æ¯30ç§’)');
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡å½“å‰é¡µ
        visitorListPollingTimer = setInterval(function() {
            if (currentVisitorPage >= 1 && !visitorListLoadPending) {
                console.log('ğŸ”„ å®šæ—¶åˆ·æ–°è®¿å®¢åˆ—è¡¨ï¼ˆç¬¬' + currentVisitorPage + 'é¡µï¼‰');
                loadVisitorPage(currentVisitorPage);
            }
        }, VISITOR_LIST_POLLING_INTERVAL);
    }
    
    // åŠ è½½è®¿å®¢åˆ—è¡¨ï¼ˆåˆ†é¡µï¼Œå¸¦é˜²æŠ–ï¼‰
    async function loadVisitorPage(page) {
        try {
            // âš¡ é˜²æŠ–ï¼šå¦‚æœæœ‰å¾…å¤„ç†çš„è¯·æ±‚ï¼Œè·³è¿‡
            if (visitorListLoadPending) {
                console.log('â­ï¸ è·³è¿‡é‡å¤çš„è®¿å®¢åˆ—è¡¨åŠ è½½è¯·æ±‚');
                return;
            }
            
            if (page < 1 || page > totalVisitorPages && totalVisitorPages > 0) {
                console.warn('é¡µç è¶…å‡ºèŒƒå›´:', page);
                return;
            }
            
            visitorListLoadPending = true; // è®¾ç½®é˜²æŠ–æ ‡è®°
            const response = await fetch(`/api/service/visitors/list?page=${page}&per_page=${visitorPerPage}`);
            const data = await response.json();
            
            if (data.code === 0) {
                currentVisitorPage = data.data.page;
                totalVisitorPages = data.data.pages;
                
                // æ¸…ç©ºå½“å‰åˆ—è¡¨
                const visitorList = document.getElementById('visitorList');
                visitorList.innerHTML = '';
                
                // æ·»åŠ è®¿å®¢
                const visitorData = data.data.visitors;
                console.log('ğŸ“ æ”¶åˆ°è®¿å®¢æ•°æ®:', visitorData);
                if (visitorData && visitorData.length > 0) {
                    visitorData.forEach((visitor, index) => {
                        console.log(`ğŸ“Œ æ·»åŠ è®¿å®¢ ${index + 1}/${visitorData.length}:`, visitor.visitor_name, visitor);
                        addVisitorToList(visitor);
                    });
                    
                    // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
                    document.getElementById('visitorPagination').style.display = 'block';
                    document.getElementById('visitorTotal').textContent = data.data.total;
                    document.getElementById('currentPageNum').textContent = currentVisitorPage;
                    document.getElementById('totalPages').textContent = totalVisitorPages;
                    
                    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
                    document.getElementById('prevPageBtn').disabled = currentVisitorPage <= 1;
                    document.getElementById('nextPageBtn').disabled = currentVisitorPage >= totalVisitorPages;
                    
                    console.log(`âœ… å®Œæˆæ·»åŠ ï¼Œå½“å‰åˆ—è¡¨ä¸­æœ‰ ${document.querySelectorAll('.visitor-item').length} ä¸ªè®¿å®¢å…ƒç´ `);
                } else {
                    // æ— è®¿å®¢æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
                    visitorList.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px;">ğŸ‘¥</div>
                            <h3>æš‚æ— ä¼šè¯</h3>
                            <p>ç­‰å¾…è®¿å®¢æ¥å…¥...</p>
                        </div>
                    `;
                    document.getElementById('visitorPagination').style.display = 'none';
                }
                
                console.log(`âœ… è®¿å®¢åˆ—è¡¨å·²åŠ è½½: ç¬¬${currentVisitorPage}é¡µï¼Œå…±${totalVisitorPages}é¡µï¼Œæ€»è®¡${data.data.total}ä¸ªè®¿å®¢`);
                console.log('ğŸ“‹ visitorList HTML:', document.getElementById('visitorList').innerHTML.substring(0, 500));
            } else {
                console.error('åŠ è½½è®¿å®¢åˆ—è¡¨å¤±è´¥:', data.msg);
            }
        } catch (error) {
            console.error('åŠ è½½è®¿å®¢åˆ—è¡¨å¼‚å¸¸:', error);
        } finally {
            visitorListLoadPending = false; // æ¸…é™¤é˜²æŠ–æ ‡è®°
        }
    }
    
    // âš¡ è®¿å®¢ç½®é¡¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šä»…é«˜äº®æ˜¾ç¤ºï¼Œä¸åˆ·æ–°åˆ—è¡¨ï¼‰
    function bringVisitorToTop(visitorId) {
        const visitorItem = document.getElementById('visitor_' + visitorId);
        
        if (visitorItem) {
            // å¦‚æœè®¿å®¢åœ¨å½“å‰é¡µé¢ï¼Œç›´æ¥é«˜äº®
            console.log(`ğŸ’¡ æ”¶åˆ°è®¿å®¢ ${visitorId} çš„æ–°æ¶ˆæ¯ï¼Œé«˜äº®æ˜¾ç¤º`);
            visitorItem.style.transition = 'background-color 0.5s';
            visitorItem.style.backgroundColor = '#fef3c7';  // æ·¡é»„è‰²é«˜äº®
            setTimeout(() => {
                visitorItem.style.backgroundColor = '';
            }, 2000);
        } else {
            // è®¿å®¢ä¸åœ¨å½“å‰é¡µï¼Œåªæ˜¾ç¤ºæç¤ºï¼ˆä¸åˆ·æ–°åˆ—è¡¨ï¼Œç­‰å¾…å®šæ—¶è½®è¯¢ï¼‰
            console.log(`ğŸ“ è®¿å®¢ ${visitorId} ä¸åœ¨å½“å‰é¡µï¼ˆç¬¬${currentVisitorPage}é¡µï¼‰ï¼Œå°†åœ¨ä¸‹æ¬¡è½®è¯¢æ—¶æ›´æ–°`);
            // showToast(`è®¿å®¢ "${visitors[visitorId]?.visitor_name || visitorId}" å‘æ¥æ–°æ¶ˆæ¯`, 'info');
        }
        
        // âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šä¸å†ç«‹å³åˆ·æ–°åˆ—è¡¨ï¼Œç­‰å¾…å®šæ—¶è½®è¯¢ï¼ˆ30ç§’ï¼‰è‡ªåŠ¨æ›´æ–°
        // è¿™æ ·å¯ä»¥é¿å…æ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯éƒ½è§¦å‘APIè°ƒç”¨ï¼Œå¤§å¹…æå‡æ€§èƒ½
    }

    // æ·»åŠ è®¿å®¢åˆ°åˆ—è¡¨
    function addVisitorToList(visitor, insertAtTop = false) {
        const visitorId = visitor.visitor_id;
        
        if (!visitorId) {
            console.warn('è®¿å®¢IDä¸å­˜åœ¨:', visitor);
            return;
        }
        
        if (document.getElementById('visitor_' + visitorId)) {
            console.log('è®¿å®¢å·²å­˜åœ¨ï¼Œæ›´æ–°ä¿¡æ¯:', visitorId);
            // æ›´æ–°ç°æœ‰è®¿å®¢ä¿¡æ¯
            visitors[visitorId] = Object.assign(visitors[visitorId] || {}, visitor);
            return;
        }

        const emptyState = document.querySelector('.visitor-list .empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        // ç¡®ä¿è®¿å®¢åç§°å­˜åœ¨
        const visitorName = visitor.visitor_name || visitor.name || 'è®¿å®¢' + visitorId.slice(-4);
        visitor.visitor_name = visitorName;
        
        console.log('ä¿å­˜è®¿å®¢ä¿¡æ¯åˆ°visitors[' + visitorId + ']:', visitor);
        visitors[visitorId] = visitor;

        // æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        let lastMsgText = 'ç­‰å¾…æ¥å…¥...';
        if (visitor.last_message) {
            // âš¡ æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¸¦é”™è¯¯ä¿æŠ¤ï¼‰
            try {
                lastMsgText = formatLastMessage(visitor.last_message);
            } catch (e) {
                console.error('æ ¼å¼åŒ–æ¶ˆæ¯å¤±è´¥:', e, visitor.last_message);
                lastMsgText = '[æ¶ˆæ¯æ ¼å¼é”™è¯¯]';
            }
        } else if (visitor.visit_count > 1) {
            lastMsgText = 'è€è®¿å®¢ï¼Œç‚¹å‡»æŸ¥çœ‹å†å²';
        }

        const visitorEl = document.createElement('div');
        visitorEl.className = 'visitor-item';
        visitorEl.id = 'visitor_' + visitorId;
        visitorEl.dataset.name = visitorName;
        visitorEl.onclick = function() { selectVisitor(visitorId); };
        
        // åŒºåˆ†è¿›è¡Œä¸­çš„ä¼šè¯å’Œå†å²ä¼šè¯
        const isActive = visitor.is_active !== false && visitor.queue_state !== 'closed' && visitor.queue_state !== 'timeout';
        const statusBadge = isActive ? '' : '<span style="font-size: 10px; padding: 2px 6px; background: #e5e7eb; color: #6b7280; border-radius: 10px; margin-left: 5px;">å·²ç»“æŸ</span>';
        const itemStyle = isActive ? '' : 'opacity: 0.6;';
        
        // âš¡ ä¿®å¤ï¼šå§‹ç»ˆä½¿ç”¨APIè¿”å›çš„æœ€æ–°æœªè¯»æ•°ï¼ˆè€Œä¸æ˜¯åªåœ¨é¦–æ¬¡åŠ è½½æ—¶åˆå§‹åŒ–ï¼‰
        // è¿™æ ·å¯ä»¥ç¡®ä¿å®¢æœæ ‡è®°å·²è¯»åï¼Œåˆ—è¡¨åˆ·æ–°æ—¶èƒ½æ­£ç¡®æ¸…é›¶æœªè¯»æ•°
        if (visitor.unread_count !== undefined) {
            unreadCounts[visitorId] = visitor.unread_count;
            console.log(`ğŸ“¬ æ›´æ–°è®¿å®¢ ${visitorId} çš„æœªè¯»æ•°: ${visitor.unread_count}`);
        }
        
        // âš¡ æ£€æŸ¥è¯¥è®¿å®¢çš„æœªè¯»æ•°
        const unreadCount = unreadCounts[visitorId] || 0;
        const unreadDisplay = unreadCount > 0 ? 'block' : 'none';
        
        visitorEl.style.cssText = itemStyle;
        visitorEl.innerHTML = `
            <div class="visitor-avatar" style="${isActive ? '' : 'background: #9ca3af;'}">${visitorName.charAt(0).toUpperCase()}</div>
            <div class="visitor-info">
                <div class="visitor-name">${visitorName}${statusBadge}</div>
                <div class="visitor-last-msg">${lastMsgText}</div>
            </div>
            <span class="unread-badge" style="display: ${unreadDisplay};">${unreadCount}</span>
        `;

        const visitorList = document.getElementById('visitorList');
        if (insertAtTop) {
            // æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨
            visitorList.insertBefore(visitorEl, visitorList.firstChild);
            console.log(`âœ… è®¿å®¢ ${visitorName} (${visitorId}) å·²æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨ï¼Œæœªè¯»æ•°: ${unreadCount}`);
        } else {
            // æ·»åŠ åˆ°åˆ—è¡¨åº•éƒ¨
            visitorList.appendChild(visitorEl);
            console.log(`âœ… è®¿å®¢ ${visitorName} (${visitorId}) å·²æ·»åŠ åˆ°åˆ—è¡¨åº•éƒ¨ï¼Œæœªè¯»æ•°: ${unreadCount}`);
        }
    }

    // ========== Tabåˆ‡æ¢åŠŸèƒ½ ==========
    let currentTab = 'current';  // 'current' æˆ– 'queue'
    
    // åˆ‡æ¢Tab
    function switchTab(tabName) {
        currentTab = tabName;
        
        // æ›´æ–°Tabæ ·å¼
        document.querySelectorAll('.chat-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.closest('.chat-tab').classList.add('active');
        
        // åˆ‡æ¢åˆ—è¡¨æ˜¾ç¤º
        const visitorList = document.getElementById('visitorList');
        const queueList = document.getElementById('queueList');
        
        if (tabName === 'current') {
            visitorList.style.display = 'block';
            queueList.style.display = 'none';
        } else {
            visitorList.style.display = 'none';
            queueList.style.display = 'block';
            loadQueueList();  // åŠ è½½æ’é˜Ÿåˆ—è¡¨
        }
    }
    
    // åŠ è½½æ’é˜Ÿåˆ—è¡¨
    async function loadQueueList() {
        try {
            const response = await fetch('/api/queue/list?status=waiting');
            const result = await response.json();
            
            if (result.code === 0) {
                const queueList = document.getElementById('queueList');
                queueList.innerHTML = '';
                
                const queues = result.data.list || [];
                document.getElementById('queueCount').textContent = queues.length;
                
                if (queues.length === 0) {
                    queueList.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px;">â³</div>
                            <h3>æš‚æ— æ’é˜Ÿ</h3>
                            <p>æ²¡æœ‰è®¿å®¢åœ¨æ’é˜Ÿ...</p>
                        </div>
                    `;
                    return;
                }
                
                queues.forEach((queue, index) => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'visitor-item queue-item';
                    
                    // ä¼˜å…ˆçº§æ ‡è¯†
                    let priorityBadge = '';
                    let priorityClass = '';
                    if (queue.priority === 2) {
                        priorityBadge = '<span class="priority-badge priority-urgent">ğŸ”´ ç´§æ€¥</span>';
                        priorityClass = 'priority-urgent-item';
                    } else if (queue.priority === 1) {
                        priorityBadge = '<span class="priority-badge priority-vip">â­ VIP</span>';
                        priorityClass = 'priority-vip-item';
                    }
                    
                    // é¢„è®¡ç­‰å¾…æ—¶é—´
                    const waitMinutes = Math.ceil((queue.estimated_wait_time || 0) / 60);
                    const waitTimeText = queue.estimated_wait_time > 0 
                        ? `é¢„è®¡ç­‰å¾… ${waitMinutes} åˆ†é’Ÿ` 
                        : 'å³å°†æ¥å…¥';
                    
                    // æ’é˜Ÿä½ç½®
                    const position = index + 1;
                    
                    queueItem.classList.add(priorityClass);
                    queueItem.innerHTML = `
                        <div class="visitor-avatar" style="background: ${queue.priority === 2 ? '#ef4444' : queue.priority === 1 ? '#f59e0b' : 'var(--primary-color)'}">
                            ${queue.visitor_name ? queue.visitor_name.charAt(0) : 'ğŸ‘¤'}
                        </div>
                        <div class="visitor-info">
                            <div class="visitor-name">
                                <span style="color: #9ca3af; font-size: 12px; margin-right: 4px;">#${position}</span>
                                ${queue.visitor_name || `è®¿å®¢${queue.visitor_id}`}
                                ${priorityBadge}
                            </div>
                            <div class="visitor-last-msg" style="display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-clock" style="font-size: 11px;"></i> ${waitTimeText}
                            </div>
                        </div>
                        <div class="visitor-status">
                            <button class="action-btn" onclick="acceptQueue(${queue.qid})" style="background: #10b981; color: white;">
                                <i class="fas fa-check"></i> æ¥å…¥
                            </button>
                        </div>
                    `;
                    queueList.appendChild(queueItem);
                });
            }
        } catch (error) {
            console.error('åŠ è½½æ’é˜Ÿåˆ—è¡¨å¤±è´¥:', error);
        }
    }
    
    // æ¥å…¥æ’é˜Ÿè®¿å®¢
    async function acceptQueue(queueId) {
        try {
            const response = await fetch('/api/queue/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    queue_id: queueId
                })
            });
            
            const result = await response.json();
            if (result.code === 0) {
                showToast('æ¥å…¥æˆåŠŸï¼', 'success');
                // åˆ·æ–°åˆ—è¡¨
                loadQueueList();
                switchTab('current');
            } else {
                showToast('æ¥å…¥å¤±è´¥: ' + result.msg, 'error');
            }
        } catch (error) {
            console.error('æ¥å…¥å¤±è´¥:', error);
            showToast('æ¥å…¥å¤±è´¥: ' + error.message, 'error');
        }
    }
    
    // âœ… ç®¡ç†å‘˜è½¬æ¥è®¿å®¢åˆ°è‡ªå·±
    async function transferVisitorToMe() {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        try {
            const transferBtn = document.getElementById('transferToMeBtn');
            if (transferBtn) {
                transferBtn.disabled = true;
                transferBtn.textContent = 'è½¬æ¥ä¸­...';
            }
            
            const response = await fetch('/api/service/queue/transfer-to-me', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    visitor_id: currentVisitorId
                })
            });
            
            const result = await response.json();
            
            if (result.code === 0) {
                showToast('âœ… è½¬æ¥æˆåŠŸï¼', 'success');
                
                // éšè—è½¬æ¥æç¤º
                const transferHint = document.getElementById('transferHint');
                if (transferHint) {
                    transferHint.style.display = 'none';
                }
                
                // è§£é”è¾“å…¥æ¡†
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                if (messageInput) {
                    messageInput.disabled = false;
                    messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                    messageInput.style.background = '';
                }
                if (sendBtn) {
                    sendBtn.disabled = false;
                }
                
                // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                addSystemMessage('âœ… è®¿å®¢å·²è½¬æ¥åˆ°æ‚¨');
                
                // æ’­æ”¾æç¤ºéŸ³
                playNotificationSound();
            } else {
                showToast('è½¬æ¥å¤±è´¥: ' + result.msg, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (transferBtn) {
                    transferBtn.disabled = false;
                    transferBtn.textContent = 'ğŸ”„ è½¬æ¥åˆ°æˆ‘';
                }
            }
            
        } catch (error) {
            console.error('è½¬æ¥å¤±è´¥:', error);
            showToast('è½¬æ¥å¤±è´¥: ' + error.message, 'error');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const transferBtn = document.getElementById('transferToMeBtn');
            if (transferBtn) {
                transferBtn.disabled = false;
                transferBtn.textContent = 'ğŸ”„ è½¬æ¥åˆ°æˆ‘';
            }
        }
    }
    
    // âœ… æ˜¾ç¤ºè½¬æ¥å¯¹è¯æ¡†ï¼ˆé€‰æ‹©å®¢æœï¼‰
    async function showTransferDialog() {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        try {
            // è·å–åœ¨çº¿å®¢æœåˆ—è¡¨
            const response = await fetch('/api/service/list?state=online');
            const result = await response.json();
            
            if (result.code !== 0) {
                showToast('è·å–å®¢æœåˆ—è¡¨å¤±è´¥', 'error');
                return;
            }
            
            const services = result.data || [];
            const currentServiceId = serviceId; // å½“å‰ç™»å½•çš„å®¢æœID
            
            // âœ… åªæ’é™¤è‡ªå·±ï¼Œä¿ç•™å…¶ä»–æ‰€æœ‰å®¢æœï¼ˆåŒ…æ‹¬å½“å‰æ¥å¾…è¯¥è®¿å®¢çš„å®¢æœï¼‰
            const currentVisitor = visitors[currentVisitorId];
            const currentAssignedId = currentVisitor?.service_id;
            
            const availableServices = services.filter(s => 
                s.service_id !== currentServiceId  // åªæ’é™¤è‡ªå·±
            );
            
            if (availableServices.length === 0) {
                showToast('æ²¡æœ‰å¯è½¬æ¥çš„å®¢æœ', 'warning');
                return;
            }
            
            // æ„å»ºé€‰é¡¹HTML
            let optionsHTML = '';
            availableServices.forEach(service => {
                const levelBadge = service.level === 'super_manager' ? 'ğŸ‘‘' : 
                                 service.level === 'manager' ? 'â­' : 'ğŸ‘¤';
                const statusColor = service.state === 'online' ? '#10b981' : '#9ca3af';
                
                // âœ… æ ‡è®°å½“å‰æ¥å¾…è¯¥è®¿å®¢çš„å®¢æœ
                const isCurrentHandler = service.service_id === currentAssignedId;
                const currentBadge = isCurrentHandler ? '<span style="font-size: 10px; padding: 2px 6px; background: #fbbf24; color: #92400e; border-radius: 10px; margin-left: 5px;">å½“å‰æ¥å¾…</span>' : '';
                
                optionsHTML += `
                    <div class="service-option" onclick="selectServiceForTransfer(${service.service_id}, '${service.nick_name}')" 
                         style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                            ${levelBadge}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937;">
                                ${service.nick_name}${currentBadge}
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">å½“å‰æ¥å¾…: ${service.current_chat_count || 0} äºº</div>
                        </div>
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></div>
                    </div>
                `;
            });
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.id = 'transferDialog';
            dialog.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1f2937;">é€‰æ‹©è½¬æ¥å®¢æœ</h3>
                        <div id="serviceOptions">
                            ${optionsHTML}
                        </div>
                        <button onclick="closeTransferDialog()" 
                                style="margin-top: 16px; width: 100%; padding: 10px; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
        } catch (error) {
            console.error('æ˜¾ç¤ºè½¬æ¥å¯¹è¯æ¡†å¤±è´¥:', error);
            showToast('æ˜¾ç¤ºè½¬æ¥å¯¹è¯æ¡†å¤±è´¥', 'error');
        }
    }
    
    // é€‰æ‹©å®¢æœè¿›è¡Œè½¬æ¥
    async function selectServiceForTransfer(toServiceId, toServiceName) {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        // å…³é—­å¯¹è¯æ¡†
        closeTransferDialog();
        
        try {
            // æŸ¥æ‰¾é˜Ÿåˆ—ID
            const currentVisitor = visitors[currentVisitorId];
            if (!currentVisitor) {
                showToast('è®¿å®¢ä¿¡æ¯ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // âœ… æ£€æŸ¥æ˜¯å¦è½¬æ¥ç»™å½“å‰å·²æ¥å¾…çš„å®¢æœ
            if (currentVisitor.service_id === toServiceId) {
                showToast(`è¯¥è®¿å®¢å·²ç”± ${toServiceName} æ¥å¾…`, 'info');
                return;
            }
            
            // è°ƒç”¨è½¬æ¥API
            const response = await fetch('/api/service/queue/transfer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    queue_id: currentVisitor.queue_id || 0,
                    to_service_id: toServiceId
                })
            });
            
            const result = await response.json();
            
            if (result.code === 0) {
                // âœ… åŒºåˆ†æ˜¯çœŸæ­£è½¬æ¥è¿˜æ˜¯å·²ç»ç”±ç›®æ ‡å®¢æœæ¥å¾…
                if (result.msg && result.msg.includes('å·²ç”±ç›®æ ‡å®¢æœæ¥å¾…')) {
                    showToast(`è¯¥è®¿å®¢å·²ç”± ${toServiceName} æ¥å¾…`, 'info');
                    return; // æ— éœ€æ‰§è¡Œåç»­çš„UIæ›´æ–°
                }
                
                showToast(`âœ… å·²è½¬æ¥ç»™ ${toServiceName}`, 'success');
                
                // éšè—è½¬æ¥æç¤º
                const transferHint = document.getElementById('transferHint');
                if (transferHint) {
                    transferHint.style.display = 'none';
                }
                
                // é”å®šè¾“å…¥æ¡†
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                if (messageInput) {
                    messageInput.disabled = true;
                    messageInput.placeholder = `è¯¥è®¿å®¢å·²è½¬æ¥ç»™ ${toServiceName}`;
                    messageInput.style.background = '#f5f5f5';
                }
                if (sendBtn) {
                    sendBtn.disabled = true;
                }
                
                // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                addSystemMessage(`âœ… è®¿å®¢å·²è½¬æ¥ç»™ ${toServiceName}`);
                
            } else {
                showToast('è½¬æ¥å¤±è´¥: ' + result.msg, 'error');
            }
            
        } catch (error) {
            console.error('è½¬æ¥å¤±è´¥:', error);
            showToast('è½¬æ¥å¤±è´¥: ' + error.message, 'error');
        }
    }
    
    // å…³é—­è½¬æ¥å¯¹è¯æ¡†
    function closeTransferDialog() {
        const dialog = document.getElementById('transferDialog');
        if (dialog) {
            dialog.remove();
        }
    }
    
    // æ ¼å¼åŒ–ç­‰å¾…æ—¶é—´
    function formatWaitTime(createdAt) {
        const now = new Date();
        const created = new Date(createdAt);
        const diffMs = now - created;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'åˆšåˆš';
        if (diffMins < 60) return `${diffMins}åˆ†é’Ÿ`;
        const diffHours = Math.floor(diffMins / 60);
        return `${diffHours}å°æ—¶${diffMins % 60}åˆ†é’Ÿ`;
    }
    
    // æ™ºèƒ½åˆ·æ–°é˜Ÿåˆ—æ•°æ®
    let queueListRefreshInterval = null;
    
    function startQueueListRefresh() {
        if (queueListRefreshInterval) {
            clearInterval(queueListRefreshInterval);
        }
        
        // æ™ºèƒ½é—´éš”ï¼šé˜Ÿåˆ—æ ‡ç­¾é¡µæ‰“å¼€ä¸”æœ‰é˜Ÿåˆ—æ—¶5ç§’ï¼Œå…¶ä»–æƒ…å†µ30ç§’
        const interval = (currentTab === 'queue' && currentQueueSize > 0) ? 5000 : 30000;
        
        console.log(`ğŸ”„ é˜Ÿåˆ—åˆ—è¡¨åˆ·æ–°ï¼ˆ${interval/1000}ç§’è½®è¯¢ï¼‰`);
        queueListRefreshInterval = setInterval(() => {
            if (currentTab === 'queue') {
                loadQueueList();
            }
            // âœ… æ›´æ–°æ‰€æœ‰ç»Ÿè®¡ï¼ˆåŒ…æ‹¬å½“å‰ä¼šè¯æ•°ã€åœ¨çº¿è®¿å®¢ã€å¾…å¤„ç†ç­‰ï¼‰
            updateStats();
        }, interval);
    }
    
    // å¯åŠ¨é˜Ÿåˆ—åˆ—è¡¨åˆ·æ–°
    startQueueListRefresh();
    
    // âœ… é¦–æ¬¡ç«‹å³æ›´æ–°æ‰€æœ‰ç»Ÿè®¡ï¼ˆæ›¿ä»£å•ç‹¬çš„ä¼šè¯æ•°æ›´æ–°ï¼‰
    updateStats();

    // é€‰æ‹©è®¿å®¢
    function selectVisitor(visitorId) {
        currentVisitorId = visitorId;
        const visitor = visitors[visitorId];
        
        // âœ… é‡ç½®åˆ†é¡µçŠ¶æ€
        chatOffset = 0;
        chatHasMore = false;
        isLoadingHistory = false;

        document.querySelectorAll('.visitor-item').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById('visitor_' + visitorId).classList.add('active');

        // âš¡ æ¸…é›¶å…¨å±€æœªè¯»è®¡æ•°
        unreadCounts[visitorId] = 0;
        
        const unreadBadge = document.querySelector('#visitor_' + visitorId + ' .unread-badge');
        if (unreadBadge) {
            unreadBadge.style.display = 'none';
            unreadBadge.textContent = '0';
        }
        
        console.log(`âœ… å·²é€‰æ‹©è®¿å®¢${visitorId}ï¼Œæœªè¯»æ•°å·²æ¸…é›¶`);

        document.getElementById('chatContainer').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'flex';

        document.getElementById('currentVisitorName').textContent = visitor.visitor_name;
        document.getElementById('currentVisitorAvatar').textContent = visitor.visitor_name.charAt(0).toUpperCase();
        document.getElementById('currentVisitorInfo').textContent = 'è®¿å®¢ID: ' + visitorId;

        document.getElementById('chatMessages').innerHTML = '';
        loadChatHistory(visitorId);
        
        // æ˜¾ç¤ºé»‘åå•æŒ‰é’®å¹¶æ£€æŸ¥çŠ¶æ€
        checkBlacklistStatus(visitorId);
        
        // âš¡ å¦‚æœè®¿å®¢ä¿¡æ¯é¢æ¿å·²æ‰“å¼€ï¼Œè‡ªåŠ¨æ›´æ–°å†…å®¹
        const infoPanel = document.getElementById('visitorInfoPanel');
        if (infoPanel && infoPanel.style.display === 'flex') {
            updateVisitorInfoPanel(visitorId);
        }
        
        // ========== æ£€æŸ¥å›å¤æƒé™ ==========
        checkReplyPermission(visitorId);
    }
    
    // æ£€æŸ¥å›å¤æƒé™
    async function checkReplyPermission(visitorId) {
        try {
            const response = await fetch('/api/assignment/check-reply-permission', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ visitor_id: visitorId })
            });
            
            const result = await response.json();
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (result.code === 0) {
                const { can_reply, reason, assigned_service } = result.data;
                
                if (!can_reply) {
                    // æ— æƒé™ï¼Œç¦ç”¨è¾“å…¥
                    console.warn('â›” æ— å›å¤æƒé™:', reason);
                    if (messageInput) {
                        messageInput.disabled = true;
                        messageInput.placeholder = reason || 'æ‚¨æ— æƒå›å¤æ­¤è®¿å®¢';
                        messageInput.style.background = '#f5f5f5';
                    }
                    if (sendBtn) {
                        sendBtn.disabled = true;
                    }
                    
                    // âœ… ç®¡ç†å‘˜æ˜¾ç¤º"è½¬æ¥åˆ°æˆ‘"æŒ‰é’®
                    const isManager = {{ 'true' if current_user.level in ['super_manager', 'manager'] else 'false' }};
                    const transferHint = document.getElementById('transferHint');
                    const transferHintText = document.getElementById('transferHintText');
                    const transferToMeBtn = document.getElementById('transferToMeBtn');
                    
                    if (isManager && transferHint && transferHintText && assigned_service) {
                        transferHintText.textContent = `è¯¥è®¿å®¢æ­£ç”±å®¢æœ ${assigned_service.nick_name} æ¥å¾…`;
                        transferHint.style.display = 'block';
                        
                        // âœ… é‡ç½®æŒ‰é’®çŠ¶æ€ï¼ˆé˜²æ­¢ä¸Šæ¬¡è½¬æ¥åæŒ‰é’®è¿˜æ˜¯ç¦ç”¨çŠ¶æ€ï¼‰
                        if (transferToMeBtn) {
                            transferToMeBtn.disabled = false;
                            transferToMeBtn.textContent = 'ğŸ”„ è½¬æ¥åˆ°æˆ‘';
                        }
                        
                        console.log('âœ… ç®¡ç†å‘˜è½¬æ¥æŒ‰é’®å·²æ˜¾ç¤ºï¼ˆcheckReplyPermissionï¼‰');
                    }
                    
                    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                    if (assigned_service) {
                        addSystemMessage(`âš ï¸ è¯¥è®¿å®¢æ­£ç”±å®¢æœ ${assigned_service.nick_name} æ¥å¾…ï¼Œæ‚¨åªèƒ½æŸ¥çœ‹ä¸èƒ½å›å¤`);
                    } else {
                        addSystemMessage(`âš ï¸ ${reason}`);
                    }
                } else {
                    // æœ‰æƒé™ï¼Œå¯ç”¨è¾“å…¥
                    console.log('âœ… æœ‰å›å¤æƒé™');
                    
                    // âœ… éšè—è½¬æ¥æç¤º
                    const transferHint = document.getElementById('transferHint');
                    if (transferHint) {
                        transferHint.style.display = 'none';
                    }
                    
                    // ========== æ¸…é™¤ä¹‹å‰çš„æƒé™é”™è¯¯æç¤ºæ¶ˆæ¯ ==========
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        const systemMessages = chatMessages.querySelectorAll('.system-message');
                        systemMessages.forEach(msg => {
                            const text = msg.textContent || '';
                            if (text.includes('æ— æƒå›å¤') || text.includes('åªèƒ½æŸ¥çœ‹') || 
                                text.includes('å·²åˆ†é…ç»™å…¶ä»–å®¢æœ') || text.includes('æ­£ç”±å®¢æœ')) {
                                msg.remove();
                                console.log('ğŸ—‘ï¸ å·²æ¸…é™¤æ—§çš„æƒé™é”™è¯¯æç¤º');
                            }
                        });
                    }
                    
                    if (messageInput) {
                        messageInput.disabled = false;
                        messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
                        messageInput.style.background = '#fff';
                    }
                    if (sendBtn) {
                        sendBtn.disabled = false;
                    }
                }
            }
        } catch (error) {
            console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
        }
    }

    // èŠå¤©è®°å½•åˆ†é¡µå˜é‡
    let chatOffset = 0;
    let chatHasMore = false;
    let isLoadingHistory = false;
    
    // âš¡ åˆ†æ‰¹æ¸²æŸ“é…ç½®
    const BATCH_SIZE = 10; // æ¯æ‰¹æ¸²æŸ“10æ¡æ¶ˆæ¯
    const BATCH_DELAY = 50; // æ¯æ‰¹å»¶è¿Ÿ50msï¼Œé¿å…é˜»å¡UI
    const HISTORY_LIMIT = 30; // å•æ¬¡åŠ è½½30æ¡ï¼ˆåŸ50æ¡ï¼‰
    const DEBUG_MODE = false; // ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•æ—¥å¿—
    
    // âš¡ æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
    function showHistoryLoading(progress = '') {
        const indicator = document.getElementById('historyLoadingIndicator');
        const progressText = document.getElementById('loadingProgressText');
        if (indicator) {
            indicator.style.display = 'block';
            if (progress) {
                progressText.textContent = progress;
            } else {
                progressText.textContent = 'æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...';
            }
        }
    }
    
    function hideHistoryLoading() {
        const indicator = document.getElementById('historyLoadingIndicator');
        if (indicator) {
            indicator.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                indicator.style.display = 'none';
                indicator.style.animation = '';
            }, 300);
        }
    }
    
    // âš¡ åˆ†æ‰¹æ¸²æŸ“æ¶ˆæ¯ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡DOMé€ æˆå¡é¡¿ï¼‰
    function renderMessagesInBatches(messages, container, insertAtTop = false) {
        return new Promise((resolve) => {
            const totalCount = messages.length;
            let currentIndex = 0;
            
            function renderBatch() {
                const batchEnd = Math.min(currentIndex + BATCH_SIZE, totalCount);
                const fragment = document.createDocumentFragment();
                
                // æ¸²æŸ“å½“å‰æ‰¹æ¬¡
                for (let i = currentIndex; i < batchEnd; i++) {
                    const msgEl = createMessageElement(messages[i]);
                    fragment.appendChild(msgEl);
                }
                
                // æ’å…¥DOM
                if (insertAtTop) {
                    container.insertBefore(fragment, container.firstChild.nextSibling); // æ’åœ¨åŠ è½½æŒ‡ç¤ºå™¨åé¢
                } else {
                    container.appendChild(fragment);
                }
                
                currentIndex = batchEnd;
                
                // æ›´æ–°è¿›åº¦
                showHistoryLoading(`æ­£åœ¨åŠ è½½ ${currentIndex}/${totalCount} æ¡æ¶ˆæ¯...`);
                
                // ç»§ç»­æ¸²æŸ“ä¸‹ä¸€æ‰¹ï¼Œæˆ–å®Œæˆ
                if (currentIndex < totalCount) {
                    // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ—¶æœº
                    requestAnimationFrame(() => {
                        setTimeout(renderBatch, BATCH_DELAY);
                    });
                } else {
                    hideHistoryLoading();
                    resolve();
                }
            }
            
            // å¼€å§‹æ¸²æŸ“ç¬¬ä¸€æ‰¹
            showHistoryLoading(`æ­£åœ¨åŠ è½½ 0/${totalCount} æ¡æ¶ˆæ¯...`);
            requestAnimationFrame(renderBatch);
        });
    }
    
    // âš¡ åŠ è½½èŠå¤©å†å²ï¼ˆä¼˜åŒ–ç‰ˆï¼šåˆ†æ‰¹æ¸²æŸ“ï¼ŒåŠ è½½åŠ¨ç”»ï¼‰
    async function loadChatHistory(visitorId, isLoadMore = false) {
        if (isLoadingHistory) return;
        isLoadingHistory = true;
        
        const messagesContainer = document.getElementById('chatMessages');
        const oldScrollHeight = messagesContainer.scrollHeight;
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        if (isLoadMore) {
            showHistoryLoading();
        }
        
        try {
            // âš¡ ä¼˜åŒ–ï¼šå‡å°‘å•æ¬¡åŠ è½½é‡ï¼ˆ50 â†’ 30æ¡ï¼‰
            const response = await fetch(`/api/service/chat/history?visitor_id=${visitorId}&limit=${HISTORY_LIMIT}&offset=${chatOffset}`);
            const data = await response.json();
            
            if (DEBUG_MODE) console.log('ğŸ“¥ å†å²æ¶ˆæ¯æ•°æ®:', data);
            
            if (data.code === 0 && data.data && data.data.length > 0) {
                chatHasMore = data.has_more || false;
                
                // å‡†å¤‡æ¶ˆæ¯æ•°æ®ï¼ˆæ·»åŠ æ—¥æœŸåˆ†éš”ç¬¦ï¼‰
                const messagesWithDates = [];
                let lastDate = null;
                
                data.data.forEach(msg => {
                    // æ·»åŠ æ—¥æœŸåˆ†éš”ç¬¦
                    const currentDate = formatDateOnly(msg.created_at || msg.timestamp);
                    if (currentDate && currentDate !== lastDate) {
                        messagesWithDates.push({
                            type: 'date-separator',
                            timestamp: msg.created_at || msg.timestamp
                        });
                        lastDate = currentDate;
                    }
                    messagesWithDates.push(msg);
                });
                
                if (isLoadMore) {
                    // âš¡ æ— æ„ŸåŠ è½½æ›´å¤šï¼šæ‰¹é‡æ¸²æŸ“åä¸€æ¬¡æ€§æ’å…¥
                    const fragment = document.createDocumentFragment();
                    
                    // æ‰¹é‡åˆ›å»ºæ‰€æœ‰æ¶ˆæ¯å…ƒç´ 
                    for (const msg of messagesWithDates) {
                        if (msg.type === 'date-separator') {
                            fragment.appendChild(createDateSeparator(msg.timestamp));
                        } else {
                            fragment.appendChild(createMessageElement(msg));
                        }
                    }
                    
                    // ä¸€æ¬¡æ€§æ’å…¥åˆ°é¡¶éƒ¨ï¼ˆåœ¨ç¬¬ä¸€ä¸ªå­å…ƒç´ ä¹‹å‰ï¼‰
                    const firstChild = messagesContainer.firstChild;
                    messagesContainer.insertBefore(fragment, firstChild);
                    
                    // âœ… ä¿æŒæ»šåŠ¨ä½ç½®
                    const newScrollHeight = messagesContainer.scrollHeight;
                    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;
                    
                    hideHistoryLoading();
                } else {
                    // åˆæ¬¡åŠ è½½ - é‡ç½®æ—¥æœŸè¿½è¸ª
                    lastMessageDate = null;
                    
                    // âš¡ æ— æ„Ÿæ¸²æŸ“ï¼šæ·»åŠ loadingç±»ï¼Œé¿å…çœ‹åˆ°æ¸²æŸ“è¿‡ç¨‹
                    messagesContainer.classList.add('loading');
                    
                    // ä½¿ç”¨ DocumentFragment æ‰¹é‡æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
                    const fragment = document.createDocumentFragment();
                    for (const msg of messagesWithDates) {
                        if (msg.type === 'date-separator') {
                            fragment.appendChild(createDateSeparator(msg.timestamp));
                        } else {
                            fragment.appendChild(createMessageElement(msg));
                        }
                    }
                    
                    // ä¸€æ¬¡æ€§æ’å…¥DOM
                    messagesContainer.appendChild(fragment);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æ¸²æŸ“å®Œæˆåå†æ˜¾ç¤º
                    requestAnimationFrame(() => {
                        messagesContainer.classList.remove('loading');
                        messagesContainer.classList.add('loaded');
                        setTimeout(() => messagesContainer.classList.remove('loaded'), 150);
                    });
                    
                    hideHistoryLoading();
                }
                
                chatOffset += data.data.length;
                if (DEBUG_MODE) console.log(`âœ… å·²åŠ è½½ ${data.data.length} æ¡æ¶ˆæ¯ï¼Œæ€»åç§»é‡: ${chatOffset}`);
            } else if (!isLoadMore) {
                // æ²¡æœ‰å†å²æ¶ˆæ¯
                addSystemMessage('ä¼šè¯å¼€å§‹');
                hideHistoryLoading();
            } else {
                hideHistoryLoading();
            }
            
        } catch (error) {
            console.error('âŒ åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error);
            if (!isLoadMore) {
                addSystemMessage('ä¼šè¯å¼€å§‹');
            }
            hideHistoryLoading();
        } finally {
            isLoadingHistory = false;
        }
    }
    
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼ˆä¸ç›´æ¥æ·»åŠ åˆ°DOMï¼‰- ç”¨äºåŠ è½½å†å²æ¶ˆæ¯
    function createMessageElement(msg) {
        // âš¡ æ”¯æŒæ—¥æœŸåˆ†éš”ç¬¦
        if (msg.type === 'date-separator') {
            return createDateSeparator(msg.timestamp);
        }
        
        const messageEl = document.createElement('div');
        const msgType = msg.from_type || (msg.direction === 'to_visitor' ? 'service' : 'visitor');
        messageEl.className = 'message ' + msgType;
        
        const time = formatTime(msg.created_at || msg.timestamp);
        let avatar, name = '';
        
        if (msgType === 'robot') {
            avatar = 'ğŸ¤–';
            name = '<div class="message-name">æ™ºèƒ½åŠ©æ‰‹</div>';
        } else if (msgType === 'service') {
            avatar = 'ğŸ‘¨â€ğŸ’¼';
            name = '';
        } else {
            // âœ… è®¿å®¢æ¶ˆæ¯æ˜¾ç¤ºæ˜µç§°
            avatar = 'ğŸ‘¤';
            const visitorName = msg.from_name || (currentVisitorId && visitors[currentVisitorId]?.visitor_name) || 'è®¿å®¢';
            name = `<div class="message-name" style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">${visitorName}</div>`;
        }
        
        // ğŸ†• ä¼˜å…ˆæ£€æŸ¥ msg_type å­—æ®µ
        let messageContent = msg.content;
        
        // âš¡ æ¡ä»¶åŒ–è°ƒè¯•æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
        if (DEBUG_MODE) {
            console.log('ğŸ“¨ æ¸²æŸ“å†å²æ¶ˆæ¯:', {
                id: msg.id,
                msg_type: msg.msg_type,
                content_preview: msg.content.substring(0, 100),
                from_type: msgType
            });
        }
        
        if (msg.msg_type === 'file') {
            // å¦‚æœmsg_typeæ˜¯fileï¼Œä¸€å®šè¦è§£æJSON
            if (DEBUG_MODE) console.log('âœ… æ£€æµ‹åˆ°æ–‡ä»¶æ¶ˆæ¯ï¼Œmsg_type=file');
            try {
                const parsedContent = JSON.parse(msg.content);
                if (DEBUG_MODE) console.log('ğŸ“¦ è§£æåçš„æ–‡ä»¶å†…å®¹:', parsedContent);
                if (parsedContent.url) {
                    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
                    if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                        // æ¸²æŸ“å›¾ç‰‡ï¼šç‚¹å‡»å¼¹å‡ºé¢„è§ˆçª—å£
                        if (DEBUG_MODE) console.log('ğŸ–¼ï¸ æ¸²æŸ“å›¾ç‰‡:', parsedContent.url);
                        messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                    } else {
                        // æ¸²æŸ“æ–‡ä»¶é“¾æ¥
                        if (DEBUG_MODE) console.log('ğŸ“ æ¸²æŸ“æ–‡ä»¶é“¾æ¥:', parsedContent.url);
                        const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                        messageContent = `
                            <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <div>
                                    <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                    ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                                </div>
                            </a>
                        `;
                    }
                }
            } catch (e) {
                console.error('âŒ è§£ææ–‡ä»¶æ¶ˆæ¯å¤±è´¥:', e, msg.content);
                messageContent = '[æ–‡ä»¶æ¶ˆæ¯è§£æå¤±è´¥]';
            }
        } else {
            // æ–‡æœ¬æ¶ˆæ¯ï¼Œå°è¯•è§£æJSONï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            try {
                const parsedContent = JSON.parse(msg.content);
                // ğŸ†• æ”¯æŒ type='file' å’Œ type='image' ä¸¤ç§æ ¼å¼
                if ((parsedContent.type === 'file' || parsedContent.type === 'image') && parsedContent.url) {
                    if (DEBUG_MODE) console.log('ğŸ”„ å…¼å®¹æ¨¡å¼ï¼šæ£€æµ‹åˆ°æ–‡ä»¶æ ¼å¼ï¼ˆæ— msg_typeï¼‰ï¼Œtype=' + parsedContent.type);
                    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
                    if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                        if (DEBUG_MODE) console.log('ğŸ–¼ï¸ æ¸²æŸ“å›¾ç‰‡ï¼ˆå…¼å®¹ï¼‰:', parsedContent.url);
                        messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                    } else {
                        if (DEBUG_MODE) console.log('ğŸ“ æ¸²æŸ“æ–‡ä»¶ï¼ˆå…¼å®¹ï¼‰:', parsedContent.url);
                        const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                        messageContent = `
                            <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <div>
                                    <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                    ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                                </div>
                            </a>
                        `;
                    }
                } else {
                    // ä¸æ˜¯æ–‡ä»¶æ ¼å¼çš„JSONï¼Œç›´æ¥è½¬ä¹‰æ˜¾ç¤º
                    messageContent = escapeHtml(msg.content);
                }
            } catch (e) {
                // ä¸æ˜¯JSONæ ¼å¼ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾
                if (/<[^>]+>/.test(msg.content)) {
                    // åŒ…å«HTMLæ ‡ç­¾ï¼Œä½¿ç”¨sanitizeHtmlæ¸…æ´åæ¸²æŸ“
                    messageContent = sanitizeHtml(msg.content);
                } else {
                    // æ™®é€šæ–‡æœ¬ï¼Œè½¬ä¹‰å¤„ç†
                    messageContent = escapeHtml(msg.content);
                }
            }
        }
        
        messageEl.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                ${name}
                <div class="message-bubble">${messageContent}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        
        return messageEl;
    }
    
    // æ¸²æŸ“æ¶ˆæ¯ï¼ˆhelperå‡½æ•°ï¼‰
    function renderMessage(msg) {
        // âš¡ ä¿®å¤ï¼šå¤„ç†æ—¥æœŸåˆ†éš”ç¬¦ç±»å‹
        if (msg.type === 'date-separator') {
            const messagesContainer = document.getElementById('chatMessages');
            const separator = createDateSeparator(msg.timestamp);
            messagesContainer.appendChild(separator);
            return;
        }
        
        const msgType = msg.from_type || (msg.direction === 'to_visitor' ? 'service' : 'visitor');
        
        if (msgType === 'robot') {
            addRobotMessage(msg.content, msg.created_at || msg.timestamp);
        } else {
            // ä¼ é€’ msg_type å‚æ•°ï¼Œç¡®ä¿æ–‡ä»¶æ¶ˆæ¯æ­£ç¡®æ¸²æŸ“
            addMessage(msg.content, msgType, msg.created_at || msg.timestamp, msg.msg_type);
        }
    }
    
    // åˆå§‹åŒ–èŠå¤©æ»šåŠ¨ç›‘å¬ï¼ˆéœ€è¦åœ¨DOMåŠ è½½åè°ƒç”¨ï¼‰
    function initChatScroll() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.addEventListener('scroll', function() {
                if (this.scrollTop === 0 && chatHasMore && !isLoadingHistory && currentVisitorId) {
                    loadChatHistory(currentVisitorId, true);
                }
            });
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content || !currentVisitorId) return;

        if (!socket || !socket.connected) {
            showToast('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'warning');
            return;
        }

        addMessage(content, 'service', new Date());

        socket.emit('send_message', {
            from_id: serviceId,
            from_type: 'service',
            from_name: serviceName,
            to_id: currentVisitorId,
            to_type: 'visitor',
            content: content,
            msg_type: 'text',
            timestamp: new Date().toISOString()
        });

        messageInput.value = '';
        messageInput.style.height = 'auto';
    }

    // å¿«æ·å›å¤
    function sendQuickReply(content) {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        document.getElementById('messageInput').value = content;
        sendMessage();
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(content, type, timestamp, msgType = null, fromName = null) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'message ' + type;
        
        const time = formatTime(timestamp);
        const avatar = type === 'service' ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¤';
        
        // âœ… è·å–è®¿å®¢æ˜µç§°ï¼ˆå¸¦IDï¼‰
        let visitorNameWithId = '';
        if (type === 'visitor') {
            if (fromName) {
                visitorNameWithId = fromName;
            } else if (currentVisitorId) {
                const visitor = visitors[currentVisitorId];
                visitorNameWithId = visitor?.visitor_name || 'è®¿å®¢';
            } else {
                visitorNameWithId = 'è®¿å®¢';
            }
        }
        
        // ğŸ†• ä¼˜å…ˆæ£€æŸ¥ msgType å‚æ•°ï¼ˆä»å†å²æ¶ˆæ¯ä¼ æ¥ï¼‰
        let messageContent = content;
        
        if (msgType === 'file') {
            // å¦‚æœæ˜¯æ–‡ä»¶ç±»å‹ï¼Œä¸€å®šè¦è§£æJSON
            try {
                const parsedContent = JSON.parse(content);
                if (parsedContent.url) {
                    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
                    if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                        // æ¸²æŸ“å›¾ç‰‡
                        messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                    } else {
                        // æ¸²æŸ“æ–‡ä»¶é“¾æ¥
                        const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                        messageContent = `
                            <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <div>
                                    <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                    ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                                </div>
                            </a>
                        `;
                    }
                }
            } catch (e) {
                console.error('è§£ææ–‡ä»¶æ¶ˆæ¯å¤±è´¥:', e);
                messageContent = '[æ–‡ä»¶æ¶ˆæ¯]';
            }
        } else {
            // å°è¯•è§£æJSONæ ¼å¼çš„å†…å®¹ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰- å…¼å®¹æ—§æ•°æ®
            try {
                const parsedContent = JSON.parse(content);
                // ğŸ†• æ”¯æŒ type='file' å’Œ type='image' ä¸¤ç§æ ¼å¼
                if ((parsedContent.type === 'file' || parsedContent.type === 'image') && parsedContent.url) {
                    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
                    if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                        // æ¸²æŸ“å›¾ç‰‡
                        messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                    } else {
                        // æ¸²æŸ“æ–‡ä»¶é“¾æ¥
                        const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                        messageContent = `
                            <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <div>
                                    <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                    ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                                </div>
                            </a>
                        `;
                    }
                } else {
                    // ä¸æ˜¯æ–‡ä»¶æ ¼å¼ï¼Œä¿æŒåŸå†…å®¹
                    messageContent = content;
                }
            } catch (e) {
                // ğŸ‘¤ ä¸æ˜¯JSONæ ¼å¼ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾
                // ç”¨æˆ·æ¶ˆæ¯ï¼ˆè®¿å®¢/å®¢æœï¼‰ï¼šåªæœ‰åŒ…å«HTMLæ—¶æ‰è½¬ä¹‰
                if (/<[^>]+>/.test(content)) {
                    // åŒ…å«HTMLæ ‡ç­¾ï¼Œè½¬ä¹‰å¤„ç†ï¼ˆä¸æ¸²æŸ“ï¼‰
                    messageContent = escapeHtml(content);
                    console.log('ğŸ‘¤ ç”¨æˆ·æ¶ˆæ¯å·²è½¬ä¹‰HTML');
                } else {
                    // æ™®é€šæ–‡æœ¬å†…å®¹ï¼Œä¿æŒåŸæ ·
                    messageContent = content;
                }
            }
        }
        
        // âœ… è®¿å®¢æ¶ˆæ¯æ˜¾ç¤ºæ˜µç§°
        if (type === 'visitor') {
            messageEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-name" style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">${visitorNameWithId}</div>
                    <div class="message-bubble">${messageContent}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        } else {
            messageEl.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${messageContent}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
        }

        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // æ·»åŠ æœºå™¨äººæ¶ˆæ¯
    function addRobotMessage(content, timestamp) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'message robot';
        
        const time = formatTime(timestamp);
        const avatar = 'ğŸ¤–';
        
        // å°è¯•è§£æJSONæ ¼å¼çš„å†…å®¹ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
        let messageContent = content;
        let isFile = false;
        
        try {
            const parsedContent = JSON.parse(content);
            if (parsedContent.type === 'file' && parsedContent.url) {
                isFile = true;
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶
                if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                    // æ¸²æŸ“å›¾ç‰‡
                    messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                } else {
                    // æ¸²æŸ“æ–‡ä»¶é“¾æ¥
                    const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                    messageContent = `
                        <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                            <span style="font-size: 24px;">ğŸ“</span>
                            <div>
                                <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                            </div>
                        </a>
                    `;
                }
            }
        } catch (e) {
            // ä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•è§£æå…¼å®¹æ¨¡å¼
            try {
                const parsedContent = JSON.parse(content);
                // ğŸ†• æ”¯æŒ type='file' å’Œ type='image' ä¸¤ç§æ ¼å¼
                if ((parsedContent.type === 'file' || parsedContent.type === 'image') && parsedContent.url) {
                    if (parsedContent.mime_type && parsedContent.mime_type.startsWith('image/')) {
                        messageContent = `<img src="${parsedContent.url}" alt="å›¾ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="showImagePreview('${parsedContent.url}')">`;
                    } else {
                        const fileSize = parsedContent.size ? formatFileSize(parsedContent.size) : '';
                        messageContent = `
                            <a href="${parsedContent.url}" target="_blank" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--primary-color);">
                                <span style="font-size: 24px;">ğŸ“</span>
                                <div>
                                    <div style="font-weight: 500;">æŸ¥çœ‹æ–‡ä»¶</div>
                                    ${fileSize ? `<div style="font-size: 12px; color: #9ca3af;">${fileSize}</div>` : ''}
                                </div>
                            </a>
                        `;
                    }
                } else {
                    messageContent = content;
                }
            } catch (e2) {
                // ğŸ¤– ä¸æ˜¯JSONæ ¼å¼ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾
                // æœºå™¨äººæ¶ˆæ¯å…è®¸æ¸²æŸ“å®‰å…¨çš„HTMLï¼ˆå¦‚è¶…é“¾æ¥ï¼‰
                if (/<[^>]+>/.test(content)) {
                    // åŒ…å«HTMLæ ‡ç­¾ï¼Œä½¿ç”¨sanitizeHtmlæ¸…æ´åæ¸²æŸ“
                    messageContent = sanitizeHtml(content);
                    console.log('ğŸ¤– æœºå™¨äººæ¶ˆæ¯å·²æ¸²æŸ“HTML:', messageContent.substring(0, 100));
                } else {
                    // æ™®é€šæ–‡æœ¬å†…å®¹
                    messageContent = content;
                }
            }
        }
        
        messageEl.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                <div class="message-name">æ™ºèƒ½åŠ©æ‰‹</div>
                <div class="message-bubble">${messageContent}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    function addSystemMessage(content) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = 'system-message';
        messageEl.textContent = content;
        messagesContainer.appendChild(messageEl);
    }

    // æ›´æ–°è®¿å®¢æœªè¯»æ•°
    function updateVisitorUnread(visitorId) {
        // âš¡ æ›´æ–°å…¨å±€æœªè¯»è®¡æ•°ï¼ˆæŒä¹…åŒ–ï¼‰
        unreadCounts[visitorId] = (unreadCounts[visitorId] || 0) + 1;
        console.log(`ğŸ“¬ è®¿å®¢${visitorId}æœªè¯»æ•°+1ï¼Œå½“å‰æœªè¯»: ${unreadCounts[visitorId]}`);
        
        // æ›´æ–°é¡µé¢ä¸Šçš„æ°”æ³¡ï¼ˆå¦‚æœè¯¥è®¿å®¢åœ¨å½“å‰åˆ—è¡¨ä¸­ï¼‰
        const unreadBadge = document.querySelector('#visitor_' + visitorId + ' .unread-badge');
        if (unreadBadge) {
            unreadBadge.textContent = unreadCounts[visitorId];
            unreadBadge.style.display = 'block';
        }
    }

    // ç§»é™¤è®¿å®¢
    function removeVisitorFromList(visitorId) {
        const el = document.getElementById('visitor_' + visitorId);
        if (el) {
            el.remove();
        }
        delete visitors[visitorId];

        if (currentVisitorId == visitorId) {
            currentVisitorId = null;
            document.getElementById('chatInterface').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
        }

        if (Object.keys(visitors).length === 0) {
            document.getElementById('visitorList').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px;">ğŸ‘¥</div>
                    <h3>æš‚æ— è®¿å®¢</h3>
                    <p>ç­‰å¾…è®¿å®¢æ¥å…¥...</p>
                </div>
            `;
        }
    }

    // âœ… æ›´æ–°æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»æœåŠ¡å™¨è·å–å‡†ç¡®æ•°æ®ï¼‰
    async function updateStats() {
        try {
            const response = await fetch('/api/queue/my-statistics');
            const result = await response.json();
            
            if (result.code === 0) {
                const stats = result.data;
                
                // æ›´æ–°åœ¨çº¿è®¿å®¢æ•°
                document.getElementById('onlineCount').textContent = stats.online_visitors || 0;
                
                // æ›´æ–°å¾…å¤„ç†æ•°
                document.getElementById('pendingCount').textContent = stats.pending_count || 0;
                
                // æ›´æ–°å½“å‰ä¼šè¯æ•°æ ‡ç­¾
                document.getElementById('currentSessionCount').textContent = stats.active_sessions || 0;
                
                // æ›´æ–°å½“å‰æ¥å¾…æ•°
                document.getElementById('currentWorkload').textContent = stats.active_sessions || 0;
                
                console.log(`ğŸ“Š ç»Ÿè®¡æ›´æ–°: åœ¨çº¿${stats.online_visitors} | å¾…å¤„ç†${stats.pending_count} | æ´»è·ƒ${stats.active_sessions}`);
            } else {
                console.warn('è·å–ç»Ÿè®¡å¤±è´¥:', result.msg);
            }
        } catch (error) {
            console.error('è·å–ç»Ÿè®¡å‡ºé”™:', error);
        }
        
        // åŒæ—¶æ›´æ–°å·¥ä½œè´Ÿè½½æ˜¾ç¤º
        updateWorkload();
    }
    
    // æ›´æ–°å·¥ä½œè´Ÿè½½æ˜¾ç¤ºï¼ˆæå–ä¸ºç‹¬ç«‹å‡½æ•°ï¼‰
    function updateWorkloadDisplay(currentCount, maxCount) {
        const utilization = maxCount > 0 ? (currentCount / maxCount * 100) : 0;
        
        // æ›´æ–°æ•°å­—æ˜¾ç¤º
        document.getElementById('currentWorkload').textContent = currentCount;
        
        // ç®¡ç†å‘˜ä¸æ˜¾ç¤ºä¸Šé™äººæ•°
        const isManager = {{ 'true' if current_user.level in ['super_manager', 'manager'] else 'false' }};
        const maxWorkloadContainer = document.getElementById('maxWorkloadContainer');
        if (isManager) {
            maxWorkloadContainer.style.display = 'none';
        } else {
            maxWorkloadContainer.style.display = '';
            document.getElementById('maxWorkload').textContent = maxCount;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        const statusEl = document.getElementById('workloadStatus');
        const currentEl = document.getElementById('currentWorkload');
        
        if (utilization === 0) {
            statusEl.textContent = 'ç©ºé—²';
            statusEl.style.background = '#d1fae5';
            statusEl.style.color = '#059669';
            currentEl.style.color = '#10b981';
        } else if (utilization < 60) {
            statusEl.textContent = 'æ­£å¸¸';
            statusEl.style.background = '#dbeafe';
            statusEl.style.color = '#1d4ed8';
            currentEl.style.color = '#3b82f6';
        } else if (utilization < 90) {
            statusEl.textContent = 'ç¹å¿™';
            statusEl.style.background = '#fed7aa';
            statusEl.style.color = '#c2410c';
            currentEl.style.color = '#f59e0b';
        } else {
            statusEl.textContent = 'æ»¡è½½';
            statusEl.style.background = '#fecaca';
            statusEl.style.color = '#b91c1c';
            currentEl.style.color = '#ef4444';
        }
        
        console.log(`ğŸ’¼ å·¥ä½œè´Ÿè½½æ›´æ–°: ${currentCount}${isManager ? '' : '/' + maxCount} (${utilization.toFixed(0)}%)`);
    }
    
    async function updateWorkload() {
        try {
            const response = await fetch(`/api/service/info/${serviceId}`);
            const data = await response.json();
            
            if (data.code === 0) {
                const service = data.data;
                const currentCount = service.current_chat_count || 0;
                const maxCount = service.max_concurrent_chats || 5;
                updateWorkloadDisplay(currentCount, maxCount);
            }
        } catch (error) {
            console.error('è·å–å·¥ä½œè´Ÿè½½å¤±è´¥:', error);
        }
    }

    // è½¬æ¥ä¼šè¯ï¼ˆè°ƒç”¨ç»Ÿä¸€çš„è½¬æ¥å¯¹è¯æ¡†ï¼‰
    function transferChat() {
        // ç›´æ¥è°ƒç”¨ç°ä»£åŒ–çš„è½¬æ¥å¯¹è¯æ¡†
        showTransferDialog();
    }

    // æ‰§è¡Œè½¬æ¥ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
    function performTransfer(toServiceId, toServiceName) {
        selectServiceForTransfer(toServiceId, toServiceName);
    }

    // ç»“æŸä¼šè¯
    function endChat() {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        // ä½¿ç”¨æ¨¡æ€ç¡®è®¤å¼¹çª—
        showConfirm('ç¡®å®šè¦ç»“æŸæ­¤ä¼šè¯å—ï¼Ÿ', function() {
            fetch('/api/queue/close', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    visitor_id: currentVisitorId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 0) {
                    addSystemMessage('ä¼šè¯å·²ç»“æŸ');
                    
                    if (socket && socket.connected) {
                        socket.emit('session_closed', {
                            visitor_id: currentVisitorId,
                            service_id: serviceId
                        });
                    }
                    
                    removeVisitorFromList(currentVisitorId);
                    showToast('ä¼šè¯å·²ç»“æŸ', 'success');
                } else {
                    showToast('ç»“æŸä¼šè¯å¤±è´¥: ' + data.msg, 'error');
                }
            })
            .catch(error => {
                console.error('ç»“æŸä¼šè¯å¤±è´¥:', error);
                showToast('ç»“æŸä¼šè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        });
    }

    // æ£€æŸ¥è®¿å®¢é»‘åå•çŠ¶æ€
    let currentBlacklistStatus = false;
    
    function checkBlacklistStatus(visitorId) {
        // é€šè¿‡APIæŸ¥è¯¢é»‘åå•çŠ¶æ€
        fetch(`/api/queue/blacklist/check/${visitorId}`, {
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 0) {
                currentBlacklistStatus = data.data.is_blacklisted;
                updateBlacklistButton(currentBlacklistStatus);
                
                // æ˜¾ç¤ºé»‘åå•æŒ‰é’®
                document.getElementById('blacklistBtn').style.display = 'inline-block';
            } else {
                console.error('æŸ¥è¯¢é»‘åå•çŠ¶æ€å¤±è´¥:', data.msg);
                // é»˜è®¤ä¸åœ¨é»‘åå•
                currentBlacklistStatus = false;
                updateBlacklistButton(false);
                document.getElementById('blacklistBtn').style.display = 'inline-block';
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥é»‘åå•çŠ¶æ€å¤±è´¥:', error);
            currentBlacklistStatus = false;
            updateBlacklistButton(false);
            document.getElementById('blacklistBtn').style.display = 'inline-block';
        });
    }
    
    function updateBlacklistButton(isBlacklisted) {
        const icon = document.getElementById('blacklistIcon');
        const text = document.getElementById('blacklistText');
        const btn = document.getElementById('blacklistBtn');
        
        if (isBlacklisted) {
            icon.textContent = 'âœ…';
            text.textContent = 'è§£é™¤';
            btn.style.backgroundColor = '#10b981';
        } else {
            icon.textContent = 'ğŸš«';
            text.textContent = 'æ‹‰é»‘';
            btn.style.backgroundColor = '#ef4444';
        }
    }
    
    // åˆ‡æ¢é»‘åå•çŠ¶æ€
    function toggleBlacklist() {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        const action = currentBlacklistStatus ? 'remove' : 'add';
        const actionText = currentBlacklistStatus ? 'ç§»å‡ºé»‘åå•' : 'åŠ å…¥é»‘åå•';
        
        showConfirm(`ç¡®å®šè¦å°†è¯¥è®¿å®¢${actionText}å—ï¼Ÿ`, () => {
            fetch(`/api/queue/blacklist/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    visitor_id: currentVisitorId,
                    reason: currentBlacklistStatus ? '' : 'å®¢æœæ‰‹åŠ¨æ‹‰é»‘'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 0) {
                    showToast(data.msg, 'success');
                    
                    // æ›´æ–°çŠ¶æ€
                    currentBlacklistStatus = !currentBlacklistStatus;
                    updateBlacklistButton(currentBlacklistStatus);
                    
                    // å¦‚æœæ˜¯æ‹‰é»‘æ“ä½œï¼Œä»è®¿å®¢åˆ—è¡¨ç§»é™¤
                    if (currentBlacklistStatus) {
                        removeVisitorFromList(currentVisitorId);
                        // æ¸…ç©ºèŠå¤©ç•Œé¢
                        document.getElementById('chatInterface').style.display = 'none';
                        document.getElementById('chatContainer').style.display = 'flex';
                        currentVisitorId = null;
                    }
                } else {
                    showToast(actionText + 'å¤±è´¥: ' + data.msg, 'error');
                }
            })
            .catch(error => {
                console.error(actionText + 'å¤±è´¥:', error);
                showToast(actionText + 'å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        });
    }

    // âš¡ æ›´æ–°è®¿å®¢ä¿¡æ¯é¢æ¿å†…å®¹ï¼ˆä¸å½±å“æ˜¾ç¤ºçŠ¶æ€ï¼‰
    function updateVisitorInfoPanel(visitorId) {
        const visitor = visitors[visitorId];
        if (!visitor) return;
        
        // æ›´æ–°é¢æ¿å†…å®¹
        document.getElementById('infoVisitorName').textContent = visitor.visitor_name || '-';
        document.getElementById('infoVisitorId').textContent = visitorId;
        document.getElementById('infoIP').textContent = visitor.ip || '-';
        document.getElementById('infoLocation').textContent = visitor.location || visitor.country || 'æœªçŸ¥';
        document.getElementById('infoBrowser').textContent = visitor.browser || 'Unknown';
        document.getElementById('infoOS').textContent = visitor.os || 'Unknown';
        document.getElementById('infoDevice').textContent = visitor.device || 'Desktop';
        document.getElementById('infoResolution').textContent = visitor.screen_resolution || '-';
        document.getElementById('infoVisitCount').textContent = (visitor.visit_count || 1) + ' æ¬¡';
        
        // æ ¼å¼åŒ–é¦–æ¬¡è®¿é—®æ—¶é—´
        if (visitor.first_visit) {
            const firstVisit = new Date(visitor.first_visit);
            document.getElementById('infoFirstVisit').textContent = 
                `${firstVisit.getFullYear()}-${String(firstVisit.getMonth() + 1).padStart(2, '0')}-${String(firstVisit.getDate()).padStart(2, '0')} ${String(firstVisit.getHours()).padStart(2, '0')}:${String(firstVisit.getMinutes()).padStart(2, '0')}`;
        } else {
            document.getElementById('infoFirstVisit').textContent = '-';
        }
    }
    
    // åˆ‡æ¢è®¿å®¢ä¿¡æ¯é¢æ¿
    function toggleVisitorInfo() {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        const panel = document.getElementById('visitorInfoPanel');
        const visitor = visitors[currentVisitorId];
        
        if (!visitor) {
            showToast('è®¿å®¢ä¿¡æ¯ä¸å­˜åœ¨', 'error');
            return;
        }
        
        // âš¡ æ€»æ˜¯å…ˆæ›´æ–°å†…å®¹ï¼ˆç¡®ä¿æ˜¾ç¤ºå½“å‰è®¿å®¢çš„ä¿¡æ¯ï¼‰
        updateVisitorInfoPanel(currentVisitorId);
        
        // åˆ‡æ¢æ˜¾ç¤º
        if (panel.style.display === 'none' || !panel.style.display) {
            panel.style.display = 'flex';
        } else {
            panel.style.display = 'none';
        }
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(date) {
        if (!date) return '';
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // âš¡ æ ¼å¼åŒ–æ—¥æœŸï¼ˆä»…æ—¥æœŸï¼Œä¸å«æ—¶é—´ï¼‰
    function formatDateOnly(date) {
        if (!date) return '';
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // âš¡ åˆ›å»ºæ—¥æœŸåˆ†éš”ç¬¦å…ƒç´ 
    function createDateSeparator(date) {
        const separator = document.createElement('div');
        separator.className = 'date-separator';
        
        const dateObj = new Date(date);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        let dateText;
        if (formatDateOnly(dateObj) === formatDateOnly(today)) {
            dateText = 'ä»Šå¤©';
        } else if (formatDateOnly(dateObj) === formatDateOnly(yesterday)) {
            dateText = 'æ˜¨å¤©';
        } else {
            dateText = formatDateOnly(date);
        }
        
        // âš¡ ä¿®å¤ï¼šæ·»åŠ .date-separator-textç±»åï¼Œç¡®ä¿CSSæ ·å¼æ­£ç¡®åº”ç”¨
        separator.innerHTML = `<span class="date-separator-text">${dateText}</span>`;
        return separator;
    }
    
    // ========== Emojiå’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ ==========
    
    let systemSettings = null; // ç³»ç»Ÿè®¾ç½®ï¼ˆæ–‡ä»¶é™åˆ¶ç­‰ï¼‰
    
    // è·å–ç³»ç»Ÿè®¾ç½®
    function loadSystemSettings() {
        // åªæœ‰ç®¡ç†å‘˜æ‰è°ƒç”¨APIï¼Œæ™®é€šå®¢æœç›´æ¥ä½¿ç”¨é»˜è®¤è®¾ç½®
        if (userLevel !== 'super_manager' && userLevel !== 'manager') {
            systemSettings = {
                upload_max_size: 10485760,  // 10MB
                upload_image_max_size: 5242880,  // 5MB
                upload_allowed_types: 'image,document,archive'
            };
            console.log('âœ… å®¢æœè´¦å·ä½¿ç”¨é»˜è®¤ç³»ç»Ÿè®¾ç½®');
            return;
        }
        
        // ç®¡ç†å‘˜æ‰è·å–ç³»ç»Ÿè®¾ç½®
        fetch('/api/admin/system-settings')
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç³»ç»Ÿè®¾ç½®å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 0) {
                    systemSettings = data.data;
                    console.log('âœ… ç³»ç»Ÿè®¾ç½®å·²åŠ è½½:', systemSettings);
                } else {
                    // ä½¿ç”¨é»˜è®¤è®¾ç½®
                    systemSettings = {
                        upload_max_size: 10485760,
                        upload_image_max_size: 5242880,
                        upload_allowed_types: 'image,document,archive'
                    };
                    console.log('âš ï¸ è·å–ç³»ç»Ÿè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
                }
            })
            .catch(error => {
                // é™é»˜å¤„ç†é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
                systemSettings = {
                    upload_max_size: 10485760,
                    upload_image_max_size: 5242880,
                    upload_allowed_types: 'image,document,archive'
                };
                console.log('âš ï¸ ç³»ç»Ÿè®¾ç½®åŠ è½½å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
            });
    }
    
    // åˆå§‹åŒ–Emojié€‰æ‹©å™¨
    function initEmojiPicker() {
        const emojiBtn = document.getElementById('emojiBtn');
        const messageInput = document.getElementById('messageInput');
        
        if (!emojiBtn || !messageInput) return;
        
        // ç»™emojiæŒ‰é’®æ·»åŠ è§¦å‘ç±»
        emojiBtn.classList.add('emoji-trigger');
        
        // ç‚¹å‡»emojiæŒ‰é’®æ˜¾ç¤ºé€‰æ‹©å™¨
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (window.emojiPicker) {
                window.emojiPicker.show(emojiBtn, messageInput, (emoji) => {
                    console.log('é€‰æ‹©äº†emoji:', emoji);
                });
            } else {
                console.error('EmojiPickeræœªåŠ è½½');
            }
        });
    }
    
    // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
    function initFileUpload() {
        const imageBtn = document.getElementById('imageBtn');
        const fileBtn = document.getElementById('fileBtn');
        const imageInput = document.getElementById('imageInput');
        const fileInput = document.getElementById('fileInputElem');
        const messageInput = document.getElementById('messageInput');
        
        // å›¾ç‰‡æŒ‰é’®
        if (imageBtn && imageInput) {
            imageBtn.addEventListener('click', () => {
                imageInput.click();
            });
            
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, 'image');
                }
                imageInput.value = ''; // é‡ç½®
            });
        }
        
        // æ–‡ä»¶æŒ‰é’®
        if (fileBtn && fileInput) {
            fileBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file, 'file');
                }
                fileInput.value = ''; // é‡ç½®
            });
        }
        
        // ç²˜è´´ä¸Šä¼ åŠŸèƒ½
        if (messageInput) {
            messageInput.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    // å¤„ç†å›¾ç‰‡ç²˜è´´
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            uploadFile(file, 'image');
                        }
                        break;
                    }
                }
            });
            
            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            messageInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                messageInput.style.background = '#f0f9ff';
            });
            
            messageInput.addEventListener('dragleave', (e) => {
                messageInput.style.background = '';
            });
            
            messageInput.addEventListener('drop', (e) => {
                e.preventDefault();
                messageInput.style.background = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const fileType = file.type.startsWith('image/') ? 'image' : 'file';
                    uploadFile(file, fileType);
                }
            });
        }
    }
    
    // æ–‡ä»¶ä¸Šä¼ å‡½æ•°
    function uploadFile(file, type) {
        if (!currentVisitorId) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¿å®¢', 'warning');
            return;
        }
        
        if (!systemSettings) {
            showToast('ç³»ç»Ÿè®¾ç½®æœªåŠ è½½ï¼Œè¯·ç¨å€™...', 'warning');
            return;
        }
        
        // éªŒè¯æ–‡ä»¶å¤§å°
        const maxSize = type === 'image' ? systemSettings.upload_image_max_size : systemSettings.upload_max_size;
        if (file.size > maxSize) {
            showToast(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§${formatFileSize(maxSize)})`, 'error');
            return;
        }
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const allowedTypes = systemSettings.upload_allowed_types.split(',');
        const fileExt = file.name.split('.').pop().toLowerCase();
        const fileCategory = getFileCategory(file.type, fileExt);
        
        if (!allowedTypes.includes(fileCategory)) {
            showToast(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š${fileCategory}`, 'error');
            return;
        }
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        uploadProgress.style.display = 'block';
        progressFill.style.width = '0%';
        progressText.textContent = 'ä¸Šä¼ ä¸­... 0%';
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('business_id', 1);
        
        // é€‰æ‹©ä¸Šä¼ æ¥å£
        const uploadUrl = type === 'image' ? '/api/upload/image' : '/api/upload/file';
        
        // ä½¿ç”¨XMLHttpRequestä»¥æ”¯æŒè¿›åº¦
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressFill.style.width = percent + '%';
                progressText.textContent = `ä¸Šä¼ ä¸­... ${percent}%`;
            }
        });
        
        xhr.addEventListener('load', () => {
            uploadProgress.style.display = 'none';
            
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.code === 0) {
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', response.data);
                    sendFileMessage(response.data);
                } else {
                    showToast('ä¸Šä¼ å¤±è´¥: ' + response.msg, 'error');
                }
            } else {
                showToast('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
        
        xhr.addEventListener('error', () => {
            uploadProgress.style.display = 'none';
            showToast('ä¸Šä¼ å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
        });
        
        xhr.open('POST', uploadUrl);
        
        // âœ… æ·»åŠ  CSRF Token åˆ°è¯·æ±‚å¤´
        if (window.CSRF && window.CSRF.getToken) {
            window.CSRF.getToken().then(token => {
                if (token) {
                    xhr.setRequestHeader('X-CSRFToken', token);
                }
                xhr.send(formData);
            }).catch(() => {
                // å¦‚æœè·å– token å¤±è´¥ï¼Œä»ç„¶å°è¯•å‘é€
                xhr.send(formData);
            });
        } else {
            xhr.send(formData);
        }
    }
    
    // å‘é€æ–‡ä»¶æ¶ˆæ¯
    function sendFileMessage(fileData) {
        if (!socket || !socket.connected) {
            showToast('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'warning');
            return;
        }
        
        const fileMessage = {
            type: 'file',
            url: fileData.url,
            name: fileData.filename,
            size: fileData.size,
            mime_type: fileData.mime_type
        };
        
        // åœ¨ç•Œé¢æ˜¾ç¤º
        addFileMessage(JSON.stringify(fileMessage), fileData.mime_type.startsWith('image/') ? 'image' : 'file', new Date());
        
        // å‘é€åˆ°æœåŠ¡å™¨
        socket.emit('send_message', {
            from_id: serviceId,
            from_type: 'service',
            from_name: serviceName,
            to_id: currentVisitorId,
            to_type: 'visitor',
            content: JSON.stringify(fileMessage),
            msg_type: 'file',
            timestamp: new Date().toISOString()
        });
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
    function addFileMessage(content, msgType, timestamp) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message service';
        
        let fileData;
        try {
            fileData = JSON.parse(content);
        } catch (e) {
            console.error('è§£ææ–‡ä»¶æ•°æ®å¤±è´¥:', e);
            return;
        }
        
        let fileContent = '';
        const isImage = msgType === 'image' || fileData.mime_type.startsWith('image/');
        
        if (isImage) {
            fileContent = `
                <div class="file-message image">
                    <img src="${fileData.url}" alt="${fileData.name}" style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;" onclick="window.open('${fileData.url}', '_blank')">
                    <div class="file-info">
                        <span class="file-name">${fileData.name}</span>
                        <span class="file-size">${formatFileSize(fileData.size)}</span>
                    </div>
                </div>
            `;
        } else {
            const icon = getFileIcon(fileData.mime_type);
            fileContent = `
                <div class="file-message">
                    <div class="file-icon">${icon}</div>
                    <div class="file-details">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${formatFileSize(fileData.size)}</div>
                    </div>
                    <a href="${fileData.url}" download="${fileData.name}" class="file-download">ğŸ“¥</a>
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">å®¢</div>
            <div class="message-content">
                ${fileContent}
                <div class="message-time">${formatTime(timestamp)}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // è·å–æ–‡ä»¶ç±»åˆ«
    function getFileCategory(mimeType, ext) {
        if (mimeType.startsWith('image/')) return 'image';
        if (mimeType.startsWith('video/')) return 'video';
        if (mimeType.startsWith('audio/')) return 'audio';
        
        const docExts = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'];
        if (docExts.includes(ext)) return 'document';
        
        const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz'];
        if (archiveExts.includes(ext)) return 'archive';
        
        return 'other';
    }
    
    // è·å–æ–‡ä»¶å›¾æ ‡
    function getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'ğŸ–¼ï¸';
        if (mimeType.startsWith('video/')) return 'ğŸ¥';
        if (mimeType.startsWith('audio/')) return 'ğŸµ';
        if (mimeType.includes('pdf')) return 'ğŸ“„';
        if (mimeType.includes('word') || mimeType.includes('document')) return 'ğŸ“';
        if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'ğŸ“Š';
        if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'ğŸ“Š';
        if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('archive')) return 'ğŸ“¦';
        return 'ğŸ“';
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // ========== æ¶ˆæ¯æç¤ºåŠŸèƒ½ ==========
    
    let originalTitle = document.title;
    let titleFlashInterval = null;
    let isPageVisible = true;
    let unreadCount = 0;
    let audioContext = null; // å…¨å±€AudioContextï¼Œé¿å…é‡å¤åˆ›å»º
    let audioContextInitialized = false;
    
    // ç›‘å¬é¡µé¢å¯è§æ€§
    document.addEventListener('visibilitychange', async () => {
        isPageVisible = !document.hidden;
        if (isPageVisible) {
            // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œåœæ­¢é—ªçƒå¹¶æ¢å¤æ ‡é¢˜
            stopTitleFlash();
            unreadCount = 0;
            
            // âœ… æ¢å¤AudioContextï¼ˆç¡®ä¿æç¤ºéŸ³å¯ä»¥æ’­æ”¾ï¼‰
            if (audioContext && audioContext.state === 'suspended') {
                try {
                    console.log('ğŸ”„ é¡µé¢å¯è§ï¼Œæ¢å¤AudioContext...');
                    await audioContext.resume();
                    console.log('âœ… AudioContextå·²æ¢å¤:', audioContext.state);
                } catch (error) {
                    console.error('âŒ AudioContextæ¢å¤å¤±è´¥:', error);
                }
            }
        }
    });
    
    // å¼€å§‹æ ‡é¢˜é—ªçƒ
    function startTitleFlash(message) {
        unreadCount++;
        
        // å¦‚æœé¡µé¢å¯è§ï¼Œä¸éœ€è¦é—ªçƒ
        if (isPageVisible) return;
        
        // å¦‚æœå·²ç»åœ¨é—ªçƒï¼Œåªæ›´æ–°æœªè¯»æ•°
        if (titleFlashInterval) {
            return;
        }
        
        let showNew = true;
        titleFlashInterval = setInterval(() => {
            if (showNew) {
                document.title = `(${unreadCount}æ¡æ–°æ¶ˆæ¯) ${originalTitle}`;
            } else {
                document.title = originalTitle;
            }
            showNew = !showNew;
        }, 1000);
    }
    
    // åœæ­¢æ ‡é¢˜é—ªçƒ
    function stopTitleFlash() {
        if (titleFlashInterval) {
            clearInterval(titleFlashInterval);
            titleFlashInterval = null;
        }
        document.title = originalTitle;
    }
    
    // åˆå§‹åŒ–AudioContextï¼ˆåœ¨ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶è°ƒç”¨ï¼‰
    async function initAudioContext() {
        if (!audioContextInitialized) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContextInitialized = true;
                console.log('âœ… AudioContextå·²åˆå§‹åŒ–ï¼ŒçŠ¶æ€:', audioContext.state);
                
                // âœ… ç«‹å³æ¢å¤AudioContextï¼ˆç¡®ä¿çŠ¶æ€ä¸ºrunningï¼‰
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('âœ… AudioContextå·²æ¢å¤åˆ°runningçŠ¶æ€:', audioContext.state);
                }
            } catch (error) {
                console.error('âŒ AudioContextåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    }
    
    // âœ… æ·»åŠ å…¨å±€äº¤äº’ç›‘å¬ï¼Œç¡®ä¿AudioContextèƒ½è¢«åˆå§‹åŒ–
    document.addEventListener('click', function initAudioOnClick() {
        initAudioContext();
    }, { once: true });
    
    document.addEventListener('keydown', function initAudioOnKeydown() {
        initAudioContext();
    }, { once: true });
    
    // æ’­æ”¾æç¤ºéŸ³ï¼ˆä½¿ç”¨é¢„åˆ›å»ºçš„AudioContextï¼‰
    async function playNotificationSound() {
        // âš ï¸ ä¸è¦åœ¨WebSocketå›è°ƒä¸­å°è¯•åˆå§‹åŒ–ï¼Œå¿…é¡»åœ¨çœŸå®ç”¨æˆ·äº¤äº’ä¸­åˆå§‹åŒ–
        if (!audioContext || !audioContextInitialized) {
            // åªåœ¨ç¬¬ä¸€æ¬¡æ—¶æ˜¾ç¤ºæç¤ºï¼ˆé¿å…åˆ·å±ï¼‰
            if (!window.audioInitHintShown) {
                console.log('ğŸ’¡ æç¤ºéŸ³éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾ï¼Œè¯·ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®');
                window.audioInitHintShown = true;
            }
            return;
        }
        
        try {
            // âœ… ç¡®ä¿AudioContextå¤„äºè¿è¡ŒçŠ¶æ€ï¼ˆå¼‚æ­¥ç­‰å¾…æ¢å¤å®Œæˆï¼‰
            if (audioContext.state === 'suspended') {
                console.log('ğŸ”„ AudioContextå·²æš‚åœï¼Œæ­£åœ¨æ¢å¤...');
                await audioContext.resume();
                console.log('âœ… AudioContextå·²æ¢å¤:', audioContext.state);
            }
            
            // å†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼Œç¡®ä¿å·²æ¢å¤
            if (audioContext.state !== 'running') {
                console.warn('âš ï¸ AudioContextçŠ¶æ€å¼‚å¸¸:', audioContext.state);
                return;
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // è®¾ç½®éŸ³è°ƒ
            oscillator.frequency.value = 800; // 800Hz
            oscillator.type = 'sine';
            
            // è®¾ç½®éŸ³é‡ï¼ˆæ·¡å…¥æ·¡å‡ºæ•ˆæœï¼‰- å¢å¼ºéŸ³é‡å’Œæ—¶é•¿
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.6, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
            
            // æ’­æ”¾
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            console.log('ğŸ”” æç¤ºéŸ³æ’­æ”¾æˆåŠŸ');
            
            // ç¬¬äºŒä¸ªéŸ³ï¼ˆç¨é«˜éŸ³è°ƒï¼‰
            setTimeout(() => {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                
                oscillator2.frequency.value = 1000; // 1000Hz
                oscillator2.type = 'sine';
                
                gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode2.gain.linearRampToValueAtTime(0.6, audioContext.currentTime + 0.01);
                gainNode2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator2.start(audioContext.currentTime);
                oscillator2.stop(audioContext.currentTime + 0.5);
            }, 150);
        } catch (error) {
            console.error('âŒ æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰
    function showDesktopNotification(title, body) {
        if (!("Notification" in window)) {
            console.log('æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥');
            return;
        }
        
        if (Notification.permission === "granted") {
            new Notification(title, {
                body: body,
                icon: '/static/favicon.svg',
                badge: '/static/favicon.svg',
                tag: 'new-message',
                requireInteraction: false
            });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification(title, {
                        body: body,
                        icon: '/static/favicon.svg'
                    });
                }
            });
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
        loadSystemSettings();
        initEmojiPicker();
        initFileUpload();
        
        // âœ… åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤ºï¼ˆåŒ…å«å·¥ä½œè´Ÿè½½ï¼‰
        updateStats();
        
        // âœ… å®šæ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => {
            updateStats();
        }, 30000);
        
        // è¯·æ±‚æ¡Œé¢é€šçŸ¥æƒé™
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }
    });
    
    // æ™ºèƒ½è½®è¯¢é˜Ÿåˆ—çŠ¶æ€
    let queueCheckInterval = null;
    let currentQueueSize = 0;
    
    function startQueueStatusCheck() {
        if (!socket) return; // âœ… ç¡®ä¿socketå·²åˆå§‹åŒ–
        
        if (queueCheckInterval) {
            clearInterval(queueCheckInterval);
        }
        
        // æ™ºèƒ½é—´éš”ï¼šé˜Ÿåˆ—æœ‰äººæ—¶5ç§’ï¼Œæ— äººæ—¶30ç§’
        const interval = currentQueueSize > 0 ? 5000 : 30000;
        
        console.log(`ğŸ”„ é˜Ÿåˆ—çŠ¶æ€æ£€æµ‹ï¼ˆ${interval/1000}ç§’è½®è¯¢ï¼‰`);
        queueCheckInterval = setInterval(function() {
            socket.emit('get_queue_status', { business_id: 1 });
        }, interval);
    }
    
    // å¯åŠ¨æ™ºèƒ½è½®è¯¢
    startQueueStatusCheck();
    
    // ========== çŸ¥è¯†åº“åŠŸèƒ½ ==========
    let knowledgeCache = [];
    let allKnowledge = [];
    
    // çŸ¥è¯†åº“æŒ‰é’®ç‚¹å‡»
    document.getElementById('knowledgeBtn').addEventListener('click', function() {
        openKnowledgeModal();
    });
    
    // æ‰“å¼€çŸ¥è¯†åº“å¼¹çª—
    async function openKnowledgeModal() {
        document.getElementById('knowledgeModal').style.display = 'flex';
        if (knowledgeCache.length === 0) {
            await loadKnowledgeBase();
        }
    }
    
    // å…³é—­çŸ¥è¯†åº“å¼¹çª—
    function closeKnowledgeModal() {
        document.getElementById('knowledgeModal').style.display = 'none';
        document.getElementById('knowledgeSearch').value = '';
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('knowledgeModal');
        if (event.target === modal) {
            closeKnowledgeModal();
        }
    });
    
    // åŠ è½½çŸ¥è¯†åº“
    async function loadKnowledgeBase() {
        try {
            const response = await fetch('/api/question/list?page=1&per_page=100');
            const result = await response.json();
            
            console.log('çŸ¥è¯†åº“APIå“åº”:', result);
            
            // æ¥å£è¿”å› data ç›´æ¥æ˜¯æ•°ç»„
            if (result.code === 0 && result.data && Array.isArray(result.data) && result.data.length > 0) {
                knowledgeCache = result.data;
                allKnowledge = result.data;
                renderKnowledgeList(knowledgeCache);
                console.log('âœ… çŸ¥è¯†åº“åŠ è½½æˆåŠŸï¼Œå…±', result.data.length, 'æ¡');
            } else {
                console.log('âŒ çŸ¥è¯†åº“æ•°æ®ä¸ºç©º');
                document.getElementById('knowledgeList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #9ca3af;">
                        æš‚æ— çŸ¥è¯†åº“æ•°æ®
                    </div>
                `;
            }
        } catch (error) {
            console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
            document.getElementById('knowledgeList').innerHTML = `
                <div style="text-align: center; padding: 20px; color: #ef4444;">
                    åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                </div>
            `;
        }
    }
    
    // æ¸²æŸ“çŸ¥è¯†åº“åˆ—è¡¨
    function renderKnowledgeList(list) {
        const container = document.getElementById('knowledgeList');
        
        if (!list || list.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #9ca3af;">
                    æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çŸ¥è¯†
                </div>
            `;
            return;
        }
        
        console.log('æ¸²æŸ“çŸ¥è¯†åº“åˆ—è¡¨ï¼Œå…±', list.length, 'æ¡');
        
        // ä½¿ç”¨ qid è€Œä¸æ˜¯ idï¼Œä½¿ç”¨ answer_text è€Œä¸æ˜¯ answer
        container.innerHTML = list.map(item => `
            <div class="knowledge-item" onclick="useKnowledge(${item.qid})">
                <div class="knowledge-item-title">Q: ${item.question}</div>
                <div class="knowledge-item-answer">A: ${item.answer_text || item.answer}</div>
            </div>
        `).join('');
    }
    
    // æœç´¢çŸ¥è¯†åº“
    function searchKnowledge() {
        const keyword = document.getElementById('knowledgeSearch').value.trim().toLowerCase();
        
        if (!keyword) {
            renderKnowledgeList(allKnowledge);
            return;
        }
        
        const filtered = allKnowledge.filter(item => {
            const answerText = item.answer_text || item.answer || '';
            return item.question.toLowerCase().includes(keyword) || 
                   answerText.toLowerCase().includes(keyword);
        });
        
        console.log('æœç´¢ç»“æœ:', filtered.length, 'æ¡');
        renderKnowledgeList(filtered);
    }
    
    // ä½¿ç”¨çŸ¥è¯†åº“ç­”æ¡ˆ
    function useKnowledge(qid) {
        console.log('é€‰æ‹©çŸ¥è¯†åº“é¡¹ï¼Œqid:', qid);
        const knowledge = allKnowledge.find(item => item.qid === qid);
        if (knowledge) {
            // ä½¿ç”¨ answer_textï¼ˆçº¯æ–‡æœ¬ï¼‰è€Œä¸æ˜¯ answerï¼ˆHTMLæ ¼å¼ï¼‰
            const answerText = knowledge.answer_text || knowledge.answer;
            document.getElementById('messageInput').value = answerText;
            closeKnowledgeModal();
            document.getElementById('messageInput').focus();
            console.log('âœ… å·²å¡«å……ç­”æ¡ˆ');
        } else {
            console.error('æœªæ‰¾åˆ°çŸ¥è¯†åº“é¡¹ï¼Œqid:', qid);
        }
    }
    
    // ==================== ç§»åŠ¨ç«¯å“åº”å¼æ§åˆ¶ ====================
    
    // æ£€æµ‹å±å¹•å®½åº¦å¹¶æ˜¾ç¤º/éšè—åˆ‡æ¢æŒ‰é’®
    function checkMobileView() {
        const mobileToggle = document.getElementById('mobileToggle');
        const isMobile = window.innerWidth <= 768;
        
        console.log('ğŸ” æ£€æµ‹ç§»åŠ¨ç«¯è§†å›¾:', isMobile, 'window.innerWidth:', window.innerWidth);
        
        if (mobileToggle) {
            mobileToggle.style.display = isMobile ? 'flex' : 'none';
            console.log('âœ… åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€:', mobileToggle.style.display);
        } else {
            console.error('âŒ æœªæ‰¾åˆ°åˆ‡æ¢æŒ‰é’®å…ƒç´  #mobileToggle');
        }
        
        // å¦‚æœä»ç§»åŠ¨ç«¯åˆ‡æ¢åˆ°æ¡Œé¢ç«¯ï¼Œç¡®ä¿ä¼šè¯åˆ—è¡¨æ˜¾ç¤º
        if (!isMobile) {
            const sidebar = document.getElementById('chatSidebar');
            const overlay = document.getElementById('chatSidebarOverlay');
            if (sidebar) sidebar.classList.remove('show');
            if (overlay) overlay.classList.remove('show');
        }
    }
    
    // åˆ‡æ¢ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ æ˜¾ç¤º/éšè—ï¼ˆé‡å‘½åé¿å…ä¸å…¨å±€åŠŸèƒ½èœå•å†²çªï¼‰
    function toggleChatSidebar(event) {
        console.log('ğŸ”˜ toggleChatSidebar è¢«è°ƒç”¨');
        
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const sidebar = document.getElementById('chatSidebar');
        const overlay = document.getElementById('chatSidebarOverlay');
        const toggle = document.getElementById('mobileToggle');
        const icon = document.getElementById('toggleIcon');
        
        if (!sidebar || !overlay) {
            console.error('âŒ æœªæ‰¾åˆ°ä¼šè¯åˆ—è¡¨æˆ–é®ç½©å±‚å…ƒç´ ');
            return;
        }
        
        const isShowing = sidebar.classList.contains('show');
        console.log('å½“å‰ä¼šè¯åˆ—è¡¨çŠ¶æ€:', isShowing ? 'æ˜¾ç¤º' : 'éšè—');
        
        if (isShowing) {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            if (toggle) toggle.classList.remove('active');
            // åˆ‡æ¢å›¾æ ‡ï¼šä»Ã—æ”¹å›â‰¡
            if (icon) {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
            console.log('âœ… å…³é—­ä¾§è¾¹æ ');
        } else {
            sidebar.classList.add('show');
            overlay.classList.add('show');
            if (toggle) toggle.classList.add('active');
            // åˆ‡æ¢å›¾æ ‡ï¼šä»â‰¡æ”¹ä¸ºÃ—
            if (icon) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            }
            console.log('âœ… æ‰“å¼€ä¾§è¾¹æ ');
        }
    }
    
    // åˆå§‹åŒ–ç§»åŠ¨ç«¯å“åº”å¼åŠŸèƒ½
    function initMobileResponsive() {
        console.log('ğŸš€ åˆå§‹åŒ–ç§»åŠ¨ç«¯å“åº”å¼åŠŸèƒ½');
        
        // åˆå§‹æ£€æŸ¥
        checkMobileView();
        
        // åˆ‡æ¢æŒ‰é’®äº‹ä»¶å’Œæ‹–æ‹½åŠŸèƒ½
        const mobileToggle = document.getElementById('mobileToggle');
        if (mobileToggle) {
            console.log('âœ… ç»‘å®šåˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶');
            
            // æ‹–æ‹½ç›¸å…³å˜é‡
            let isDragging = false;
            let hasMoved = false;
            let startX, startY, startLeft, startTop;
            
            // é¼ æ ‡/è§¦æ‘¸å¼€å§‹
            function handleDragStart(e) {
                const touch = e.type === 'touchstart' ? e.touches[0] : e;
                isDragging = true;
                hasMoved = false;
                startX = touch.clientX;
                startY = touch.clientY;
                
                const rect = mobileToggle.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                
                mobileToggle.style.transition = 'none';
                e.preventDefault();
            }
            
            // é¼ æ ‡/è§¦æ‘¸ç§»åŠ¨
            function handleDragMove(e) {
                if (!isDragging) return;
                
                const touch = e.type === 'touchmove' ? e.touches[0] : e;
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;
                
                // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡5pxï¼Œè®¤ä¸ºæ˜¯æ‹–æ‹½
                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }
                
                if (hasMoved) {
                    const newLeft = startLeft + deltaX;
                    const newTop = startTop + deltaY;
                    
                    // é™åˆ¶åœ¨è§†å£èŒƒå›´å†…
                    const maxX = window.innerWidth - mobileToggle.offsetWidth;
                    const maxY = window.innerHeight - mobileToggle.offsetHeight;
                    
                    mobileToggle.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
                    mobileToggle.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
                }
                
                e.preventDefault();
            }
            
            // é¼ æ ‡/è§¦æ‘¸ç»“æŸ
            function handleDragEnd(e) {
                if (!isDragging) return;
                
                isDragging = false;
                mobileToggle.style.transition = '';
                
                // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶
                if (!hasMoved) {
                    console.log('ğŸ–±ï¸ åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆæœªæ‹–åŠ¨ï¼‰');
                    toggleChatSidebar(e);
                } else {
                    console.log('âœ‹ æŒ‰é’®è¢«æ‹–åŠ¨åˆ°æ–°ä½ç½®');
                }
                
                e.preventDefault();
            }
            
            // ç»‘å®šé¼ æ ‡äº‹ä»¶
            mobileToggle.addEventListener('mousedown', handleDragStart);
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            
            // ç»‘å®šè§¦æ‘¸äº‹ä»¶
            mobileToggle.addEventListener('touchstart', handleDragStart, { passive: false });
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd, { passive: false });
        } else {
            console.error('âŒ æœªæ‰¾åˆ°åˆ‡æ¢æŒ‰é’®å…ƒç´  #mobileToggle');
        }
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¼šè¯åˆ—è¡¨
        const overlay = document.getElementById('chatSidebarOverlay');
        if (overlay) {
            console.log('âœ… ç»‘å®šé®ç½©å±‚ç‚¹å‡»äº‹ä»¶');
            overlay.addEventListener('click', toggleChatSidebar);
        } else {
            console.error('âŒ æœªæ‰¾åˆ°é®ç½©å±‚å…ƒç´  #chatSidebarOverlay');
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', checkMobileView);
        
        // ç§»åŠ¨ç«¯ç‚¹å‡»è®¿å®¢åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                if (e.target.closest('.queue-item') || e.target.closest('.visitor-item')) {
                    setTimeout(() => {
                        const sidebar = document.getElementById('chatSidebar');
                        const overlay = document.getElementById('chatSidebarOverlay');
                        const toggle = document.getElementById('mobileToggle');
                        const icon = document.getElementById('toggleIcon');
                        
                        if (sidebar && sidebar.classList.contains('show')) {
                            sidebar.classList.remove('show');
                            overlay.classList.remove('show');
                            if (toggle) toggle.classList.remove('active');
                            // æ¢å¤èœå•å›¾æ ‡
                            if (icon) {
                                icon.classList.remove('fa-times');
                                icon.classList.add('fa-bars');
                            }
                        }
                    }, 300);
                }
            }
        });
        
        console.log('âœ… ç§»åŠ¨ç«¯å“åº”å¼åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }
    
    // ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½ååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMobileResponsive);
    } else {
        // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–
        initMobileResponsive();
    }
    
    // ========== é€šç”¨å·¥å…·å‡½æ•° ==========
    
    // Toastæç¤º
    function showToast(message, type = 'info') {
        // ç§»é™¤å·²å­˜åœ¨çš„toast
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const toast = document.createElement('div');
        toast.className = `custom-toast custom-toast-${type}`;
        
        const iconMap = {
            'success': 'âœ“',
            'error': 'âœ•',
            'warning': 'âš ',
            'info': 'â„¹'
        };
        
        toast.innerHTML = `
            <span class="toast-icon">${iconMap[type] || 'â„¹'}</span>
            <span class="toast-message">${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // æ·»åŠ æ ·å¼
        if (!document.getElementById('toastStyles')) {
            const style = document.createElement('style');
            style.id = 'toastStyles';
            style.textContent = `
                .custom-toast {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
                
                .custom-toast-success {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
                }
                
                .custom-toast-error {
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                }
                
                .custom-toast-warning {
                    background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%);
                }
                
                .custom-toast-info {
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                }
                
                .toast-icon {
                    font-size: 18px;
                    font-weight: bold;
                }
                
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // ç¡®è®¤å¯¹è¯æ¡†
    function showConfirm(message, onConfirm, onCancel) {
        // ç§»é™¤å·²å­˜åœ¨çš„ç¡®è®¤æ¡†
        const existingConfirm = document.querySelector('.custom-confirm-overlay');
        if (existingConfirm) {
            existingConfirm.remove();
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'custom-confirm-overlay';
        
        overlay.innerHTML = `
            <div class="custom-confirm-dialog">
                <div class="confirm-header">
                    <h3>ç¡®è®¤æ“ä½œ</h3>
                </div>
                <div class="confirm-body">
                    <p>${message}</p>
                </div>
                <div class="confirm-footer">
                    <button class="confirm-btn confirm-btn-cancel">å–æ¶ˆ</button>
                    <button class="confirm-btn confirm-btn-ok">ç¡®å®š</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // æ·»åŠ æ ·å¼
        if (!document.getElementById('confirmStyles')) {
            const style = document.createElement('style');
            style.id = 'confirmStyles';
            style.textContent = `
                .custom-confirm-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                    animation: fadeIn 0.2s ease;
                }
                
                .custom-confirm-dialog {
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 400px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    animation: scaleIn 0.3s ease;
                }
                
                .confirm-header {
                    padding: 20px;
                    border-bottom: 1px solid #eee;
                }
                
                .confirm-header h3 {
                    margin: 0;
                    font-size: 18px;
                    color: #333;
                }
                
                .confirm-body {
                    padding: 20px;
                }
                
                .confirm-body p {
                    margin: 0;
                    color: #666;
                    line-height: 1.5;
                }
                
                .confirm-footer {
                    padding: 15px 20px;
                    border-top: 1px solid #eee;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }
                
                .confirm-btn {
                    padding: 8px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s;
                }
                
                .confirm-btn-cancel {
                    background: #f0f0f0;
                    color: #666;
                }
                
                .confirm-btn-cancel:hover {
                    background: #e0e0e0;
                }
                
                .confirm-btn-ok {
                    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
                    color: white;
                }
                
                .confirm-btn-ok:hover {
                    opacity: 0.9;
                    transform: translateY(-1px);
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes scaleIn {
                    from {
                        transform: scale(0.9);
                        opacity: 0;
                    }
                    to {
                        transform: scale(1);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // äº‹ä»¶å¤„ç†
        const cancelBtn = overlay.querySelector('.confirm-btn-cancel');
        const okBtn = overlay.querySelector('.confirm-btn-ok');
        
        function closeDialog() {
            overlay.style.animation = 'fadeOut 0.2s ease';
            setTimeout(() => overlay.remove(), 200);
        }
        
        cancelBtn.addEventListener('click', () => {
            if (onCancel) onCancel();
            closeDialog();
        });
        
        okBtn.addEventListener('click', () => {
            if (onConfirm) onConfirm();
            closeDialog();
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                if (onCancel) onCancel();
                closeDialog();
            }
        });
    }
    
    // ========== å›¾ç‰‡é¢„è§ˆåŠŸèƒ½ (Image Preview Lightbox) ==========
    
    /**
     * æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆå¼¹çª—
     * @param {string} imageUrl - å›¾ç‰‡URL
     */
    function showImagePreview(imageUrl) {
        // åˆ›å»ºé¢„è§ˆå®¹å™¨
        const previewContainer = document.createElement('div');
        previewContainer.id = 'imagePreviewModal';
        previewContainer.className = 'image-preview-modal';
        
        previewContainer.innerHTML = `
            <div class="image-preview-backdrop" onclick="closeImagePreview()"></div>
            <div class="image-preview-content">
                <button class="image-preview-close" onclick="closeImagePreview()" title="å…³é—­ (ESC)">
                    âœ•
                </button>
                <img src="${imageUrl}" alt="å›¾ç‰‡é¢„è§ˆ" class="image-preview-img">
            </div>
        `;
        
        document.body.appendChild(previewContainer);
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(() => {
            previewContainer.classList.add('show');
        }, 10);
        
        // ç›‘å¬ESCé”®å…³é—­
        document.addEventListener('keydown', handleImagePreviewEscape);
    }
    
    /**
     * å…³é—­å›¾ç‰‡é¢„è§ˆå¼¹çª—
     */
    function closeImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.classList.remove('show');
            
            // ç­‰å¾…åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
        
        // ç§»é™¤ESCç›‘å¬
        document.removeEventListener('keydown', handleImagePreviewEscape);
    }
    
    /**
     * å¤„ç†ESCé”®æŒ‰ä¸‹äº‹ä»¶
     */
    function handleImagePreviewEscape(e) {
        if (e.key === 'Escape') {
            closeImagePreview();
        }
    }
    
</script>
{% endblock %}

