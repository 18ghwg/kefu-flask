{%extends "admin/base.html" %}

{%block title %}访客详情{%endblock %}

{%block nav_visitors %}active{%endblock %}

{%block breadcrumb %}
<span><i class="fas fa-user"></i> <i class="fas fa-chevron-right"></i> 访客管理 / 访客详情</span>
{%endblock %}

{%block extra_css %}
<style>
    .page-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        color: #374151;
        text-decoration: none;
        margin-bottom: 20px;
        transition: all 0.2s;
        font-size: 14px;
    }

    .back-btn:hover {
        background: #f9fafb;
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateX(-2px);
    }

    .detail-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .detail-header {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 30px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
        color: white;
    }

    .visitor-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.2);
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }

    .visitor-avatar img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
    }

    .visitor-avatar .avatar-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        color: white;
        font-size: 32px;
        font-weight: 600;
        position: relative;
        z-index: 0;
    }

    .visitor-info h1 {
        margin: 0 0 8px 0;
        font-size: 24px;
        font-weight: 600;
    }

    .visitor-info p {
        margin: 0 0 12px 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-online {
        background: #d1fae5;
        color: #065f46;
    }

    .status-offline {
        background: #fee2e2;
        color: #991b1b;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 20px 30px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 18px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 30px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .info-item label {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }

    .info-item .value {
        font-size: 15px;
        color: #1f2937;
        word-break: break-all;
    }

    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .tag {
        padding: 4px 12px;
        background: #ede9fe;
        color: #6d28d9;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .page-container {
            padding: 15px;
        }

        .detail-header {
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        .visitor-info h1 {
            font-size: 20px;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 20px;
        }

        .section-title {
            padding: 15px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
<div class="container">
        <a href="/admin/visitors" class="back-btn">
            <i class="fas fa-arrow-left"></i> 返回访客列表
        </a>

        <div class="detail-card">
            <div class="detail-header" id="visitorHeader">
                <!-- 动态加载 -->
            </div>

            <div class="section-title">
                <i class="fas fa-info-circle"></i> 基本信息
            </div>
            <div class="info-grid" id="basicInfo">
                <!-- 动态加载 -->
            </div>
        </div>

        <div class="detail-card">
            <div class="section-title">
                <i class="fas fa-globe"></i> 来源信息
            </div>
            <div class="info-grid" id="sourceInfo">
                <!-- 动态加载 -->
            </div>
        </div>

        <div class="detail-card">
            <div class="section-title">
                <i class="fas fa-laptop"></i> 设备信息
            </div>
            <div class="info-grid" id="deviceInfo">
                <!-- 动态加载 -->
            </div>
        </div>

        <div class="detail-card">
            <div class="section-title">
                <i class="fas fa-chart-line"></i> 统计信息
            </div>
            <div class="info-grid" id="statsInfo">
                <!-- 动态加载 -->
            </div>
        </div>
    </div>

    <script>
        const visitorId = window.location.pathname.split('/').pop();

        async function loadVisitorDetail() {
            try {
                const response = await fetch(`/api/visitor/detail/${visitorId}`);
                const result = await response.json();
                
                if (result.code === 0) {
                    renderDetail(result.data);
                } else {
                    modal.error('加载失败：' + result.msg);
                }
            } catch (error) {
                modal.error('加载失败：' + error.message);
            }
        }

        function renderDetail(visitor) {
            // 渲染头像
            const firstLetter = visitor.visitor_name.charAt(0).toUpperCase();
            const avatarHtml = visitor.avatar && visitor.avatar !== '/static/img/default-avatar.svg' && visitor.avatar.startsWith('http') 
                ? `<span class="avatar-placeholder">${firstLetter}</span><img src="${visitor.avatar}" alt="" onerror="this.style.display='none';">`
                : `<span class="avatar-placeholder">${firstLetter}</span>`;
            
            // 头部
            document.getElementById('visitorHeader').innerHTML = `
                <div class="visitor-avatar">
                    ${avatarHtml}
                </div>
                <div class="visitor-info">
                    <h1>${visitor.visitor_name}</h1>
                    <p>访客ID: ${visitor.visitor_id}</p>
                    <span class="status-badge status-${visitor.state}">
                        ${visitor.state === 'online' ? '在线' : '离线'}
                    </span>
                    ${visitor.is_blacklist ? '<span class="status-badge" style="background:#fee2e2;color:#991b1b;margin-left:5px;">黑名单</span>' : ''}
                </div>
            `;

            // 基本信息
            document.getElementById('basicInfo').innerHTML = `
                <div class="info-item">
                    <label>真实姓名</label>
                    <div class="value">${visitor.name || '-'}</div>
                </div>
                <div class="info-item">
                    <label>联系电话</label>
                    <div class="value">${visitor.tel || '-'}</div>
                </div>
                <div class="info-item">
                    <label>联系方式</label>
                    <div class="value">${visitor.connect || '-'}</div>
                </div>
                <div class="info-item">
                    <label>备注</label>
                    <div class="value">${visitor.comment || '-'}</div>
                </div>
                <div class="info-item">
                    <label>标签</label>
                    <div class="tags">
                        ${visitor.tags && visitor.tags.length ? visitor.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '<span class="value">-</span>'}
                    </div>
                </div>
            `;

            // 来源信息
            document.getElementById('sourceInfo').innerHTML = `
                <div class="info-item">
                    <label>IP地址</label>
                    <div class="value">${visitor.ip}</div>
                </div>
                <div class="info-item">
                    <label>来源页面</label>
                    <div class="value">${visitor.from_url || '-'}</div>
                </div>
                <div class="info-item">
                    <label>引荐来源</label>
                    <div class="value">${visitor.referrer || '-'}</div>
                </div>
                <div class="info-item">
                    <label>UTM来源</label>
                    <div class="value">${visitor.utm_source || '-'}</div>
                </div>
                <div class="info-item">
                    <label>UTM媒介</label>
                    <div class="value">${visitor.utm_medium || '-'}</div>
                </div>
                <div class="info-item">
                    <label>UTM活动</label>
                    <div class="value">${visitor.utm_campaign || '-'}</div>
                </div>
            `;

            // 设备信息
            document.getElementById('deviceInfo').innerHTML = `
                <div class="info-item">
                    <label>设备类型</label>
                    <div class="value">${visitor.device || '-'}</div>
                </div>
                <div class="info-item">
                    <label>操作系统</label>
                    <div class="value">${visitor.os || '-'}</div>
                </div>
                <div class="info-item">
                    <label>浏览器</label>
                    <div class="value">${visitor.browser || '-'}</div>
                </div>
            `;

            // 统计信息
            document.getElementById('statsInfo').innerHTML = `
                <div class="info-item">
                    <label>访问次数</label>
                    <div class="value">${visitor.login_times} 次</div>
                </div>
                <div class="info-item">
                    <label>聊天记录数</label>
                    <div class="value">${visitor.chat_count || 0} 条</div>
                </div>
                <div class="info-item">
                    <label>首次访问</label>
                    <div class="value">${visitor.first_visit_time ? new Date(visitor.first_visit_time).toLocaleString('zh-CN') : '-'}</div>
                </div>
                <div class="info-item">
                    <label>最后访问</label>
                    <div class="value">${visitor.last_visit_time ? new Date(visitor.last_visit_time).toLocaleString('zh-CN') : '-'}</div>
                </div>
                <div class="info-item">
                    <label>最后消息时间</label>
                    <div class="value">${visitor.msg_time ? new Date(visitor.msg_time).toLocaleString('zh-CN') : '-'}</div>
                </div>
                <div class="info-item">
                    <label>创建时间</label>
                    <div class="value">${visitor.created_at ? new Date(visitor.created_at).toLocaleString('zh-CN') : '-'}</div>
                </div>
            `;
        }

        window.addEventListener('DOMContentLoaded', loadVisitorDetail);
    </script>
</div>
{% endblock %}

{% block extra_js %}
{% endblock %}
