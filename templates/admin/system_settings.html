{% extends "admin/base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - å®¢æœç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ CSS -->
<link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet">

<style>
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .settings-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-description {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 25px;
    }

    .setting-item {
        padding: 20px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .setting-label {
        font-size: 15px;
        font-weight: 500;
        color: #374151;
    }

    .setting-help {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 10px;
    }

    .setting-control {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .input-field {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .select-field {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 28px;
        background: #d1d5db;
        border-radius: 14px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle-switch.active {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        transition: left 0.3s;
    }

    .toggle-switch.active::after {
        left: 25px;
    }

    .save-btn {
        padding: 12px 32px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
    }

    .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .reset-btn {
        padding: 12px 32px;
        background: white;
        color: #6b7280;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 10px;
    }

    .reset-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .actions {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
    <p>é…ç½®ç³»ç»Ÿå‚æ•°å’ŒåŠŸèƒ½å¼€å…³</p>
</div>

<div class="settings-container">
    <!-- åŸºæœ¬è®¾ç½® -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ¢</span>
            <span>åŸºæœ¬è®¾ç½®</span>
        </div>
        <div class="section-description">é…ç½®å•†æˆ·åŸºæœ¬ä¿¡æ¯</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">å•†æˆ·åç§°</div>
            </div>
            <div class="setting-help">æ˜¾ç¤ºåœ¨å®¢æœç³»ç»Ÿä¸­çš„å•†æˆ·åç§°</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="businessName" placeholder="è¯·è¾“å…¥å•†æˆ·åç§°">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ç‰ˆæƒä¿¡æ¯</div>
            </div>
            <div class="setting-help">æ˜¾ç¤ºåœ¨é¡µé¢åº•éƒ¨çš„ç‰ˆæƒä¿¡æ¯</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="copyright" placeholder="Â© 2025 Your Company">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ç³»ç»Ÿè¯­è¨€</div>
            </div>
            <div class="setting-help">é€‰æ‹©ç³»ç»Ÿä½¿ç”¨çš„è¯­è¨€</div>
            <div class="setting-control">
                <select class="select-field" id="lang">
                    <option value="cn">ç®€ä½“ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="tw">ç¹é«”ä¸­æ–‡</option>
                </select>
            </div>
        </div>
    </div>

    <!-- åˆ†é…è§„åˆ™ -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ¯</span>
            <span>åˆ†é…è§„åˆ™</span>
        </div>
        <div class="section-description">é…ç½®è®¿å®¢åˆ†é…ç»™å®¢æœçš„è§„åˆ™</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">åˆ†é…æ–¹å¼</div>
            </div>
            <div class="setting-help">é€‰æ‹©è®¿å®¢å¦‚ä½•åˆ†é…ç»™å®¢æœ</div>
            <div class="setting-control">
                <select class="select-field" id="distributionRule">
                    <option value="auto">è‡ªåŠ¨åˆ†é…ï¼ˆæ™ºèƒ½è´Ÿè½½å‡è¡¡ï¼‰</option>
                    <option value="claim">æ‰‹åŠ¨è®¤é¢†ï¼ˆå®¢æœä¸»åŠ¨æ¥å…¥ï¼‰</option>
                </select>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½å¼€å…³ -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ›ï¸</span>
            <span>åŠŸèƒ½å¼€å…³</span>
        </div>
        <div class="section-description">å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šåŠŸèƒ½</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">è¯­éŸ³æç¤º</div>
                <div class="toggle-switch" id="voiceState" onclick="toggleSwitch('voiceState')"></div>
            </div>
            <div class="setting-help">æ–°æ¶ˆæ¯æ—¶æ’­æ”¾æç¤ºéŸ³</div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">è§†é¢‘é€šè¯</div>
                <div class="toggle-switch" id="videoState" onclick="toggleSwitch('videoState')"></div>
            </div>
            <div class="setting-help">å¯ç”¨è§†é¢‘é€šè¯åŠŸèƒ½</div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">éŸ³é¢‘é€šè¯</div>
                <div class="toggle-switch" id="audioState" onclick="toggleSwitch('audioState')"></div>
            </div>
            <div class="setting-help">å¯ç”¨éŸ³é¢‘é€šè¯åŠŸèƒ½</div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æ¨¡æ¿æ¶ˆæ¯</div>
                <div class="toggle-switch" id="templateState" onclick="toggleSwitch('templateState')"></div>
            </div>
            <div class="setting-help">å¯ç”¨å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¨é€</div>
        </div>
    </div>

    <!-- é€šçŸ¥è®¾ç½® -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ””</span>
            <span>é€šçŸ¥è®¾ç½®</span>
        </div>
        <div class="section-description">é…ç½®ç³»ç»Ÿé€šçŸ¥ç›¸å…³è®¾ç½®</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æç¤ºéŸ³åœ°å€</div>
            </div>
            <div class="setting-help">æ–°æ¶ˆæ¯æç¤ºéŸ³çš„URLåœ°å€</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="voiceAddress" placeholder="/static/voice/default.mp3">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æ¨é€URL</div>
            </div>
            <div class="setting-help">ç¬¬ä¸‰æ–¹æ¨é€æœåŠ¡çš„Webhookåœ°å€</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="pushUrl" placeholder="https://api.example.com/webhook">
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ è®¾ç½® -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ“</span>
            <span>æ–‡ä»¶ä¸Šä¼ è®¾ç½®</span>
        </div>
        <div class="section-description">é…ç½®æ–‡ä»¶ä¸Šä¼ çš„é™åˆ¶å’Œå®‰å…¨é€‰é¡¹</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æœ€å¤§æ–‡ä»¶å¤§å°</div>
            </div>
            <div class="setting-help">å•ä¸ªæ–‡ä»¶çš„æœ€å¤§ä¸Šä¼ å¤§å°ï¼ˆMBï¼‰</div>
            <div class="setting-control">
                <input type="number" class="input-field" id="uploadMaxSize" placeholder="10" min="1" max="100">
                <span style="margin-left: 10px;">MB</span>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æœ€å¤§å›¾ç‰‡å¤§å°</div>
            </div>
            <div class="setting-help">å•ä¸ªå›¾ç‰‡çš„æœ€å¤§ä¸Šä¼ å¤§å°ï¼ˆMBï¼‰</div>
            <div class="setting-control">
                <input type="number" class="input-field" id="uploadImageMaxSize" placeholder="5" min="1" max="50">
                <span style="margin-left: 10px;">MB</span>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">å…è®¸çš„æ–‡ä»¶ç±»å‹</div>
            </div>
            <div class="setting-help">é€‰æ‹©å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹ï¼ˆå¤šé€‰ï¼‰</div>
            <div class="setting-control" style="flex-direction: column; align-items: flex-start;">
                <label style="margin: 5px 0;">
                    <input type="checkbox" class="file-type-checkbox" value="image"> å›¾ç‰‡ï¼ˆpng, jpg, jpeg, gifç­‰ï¼‰
                </label>
                <label style="margin: 5px 0;">
                    <input type="checkbox" class="file-type-checkbox" value="document"> æ–‡æ¡£ï¼ˆpdf, doc, docx, xls, xlsx, ppt, pptx, txtï¼‰
                </label>
                <label style="margin: 5px 0;">
                    <input type="checkbox" class="file-type-checkbox" value="archive"> å‹ç¼©åŒ…ï¼ˆzip, rar, 7z, tar, gzï¼‰
                </label>
                <label style="margin: 5px 0;">
                    <input type="checkbox" class="file-type-checkbox" value="video"> è§†é¢‘ï¼ˆmp4, avi, mov, wmvç­‰ï¼‰
                </label>
                <label style="margin: 5px 0;">
                    <input type="checkbox" class="file-type-checkbox" value="audio"> éŸ³é¢‘ï¼ˆmp3, wav, ogg, aacç­‰ï¼‰
                </label>
            </div>
        </div>
    </div>

    <!-- èŠå¤©è®¾ç½® -->
    <div class="settings-section">
        <div class="section-title">
            <span>ğŸ’¬</span>
            <span>èŠå¤©è®¾ç½®</span>
        </div>
        <div class="section-description">é…ç½®èŠå¤©ç›¸å…³çš„æ–‡æœ¬å’Œè¶…æ—¶æ—¶é—´</div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ğŸ¤– è‡ªåŠ¨é—®å€™è¯­</div>
            </div>
            <div class="setting-help">è®¿å®¢è¿›å…¥èŠå¤©æ—¶æœºå™¨äººè‡ªåŠ¨å‘é€çš„é—®å€™æ¶ˆæ¯ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ï¼‰</div>
            <div class="setting-control" style="flex-direction: column; align-items: stretch;">
                <div id="greetingEditor" style="height: 200px; border: 1px solid #d1d5db; border-radius: 8px;"></div>
                <textarea id="greetingMessage" style="display: none;"></textarea>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ğŸ‘¥ é»˜è®¤æœ€å¤§æ¥å¾…æ•°</div>
            </div>
            <div class="setting-help">æ–°å»ºå®¢æœè´¦å·æ—¶çš„é»˜è®¤æœ€å¤§åŒæ—¶æ¥å¾…è®¿å®¢æ•°é‡ï¼ˆç®¡ç†å‘˜ä¸å—æ­¤é™åˆ¶ï¼‰</div>
            <div class="setting-control">
                <input type="number" class="input-field" id="defaultMaxConcurrentChats" placeholder="5" min="1" max="100" style="width: 150px;">
                <span style="margin-left: 10px; color: #6b7280;">äºº/å®¢æœ</span>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ğŸ¤– æœºå™¨äººå›å¤æ¨¡å¼</div>
            </div>
            <div class="setting-help">æ§åˆ¶æœºå™¨äººæ™ºèƒ½å…³é”®è¯è‡ªåŠ¨å›å¤çš„è§¦å‘æ¡ä»¶</div>
            <div class="setting-control">
                <select id="robotReplyMode" class="input-field" style="width: auto; min-width: 300px;">
                    <option value="offline_only">ä»…åœ¨å®¢æœç¦»çº¿æ—¶å›å¤ï¼ˆæ¨èï¼‰</option>
                    <option value="always">å§‹ç»ˆè‡ªåŠ¨å›å¤</option>
                </select>
                <div style="margin-top: 8px; padding: 12px; background: #f3f4f6; border-radius: 6px; font-size: 13px; color: #6b7280;">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    â€¢ <strong>ä»…ç¦»çº¿æ—¶å›å¤</strong>ï¼šå®¢æœåœ¨çº¿æ—¶ä¸å¹²æ‰°ï¼Œç”±äººå·¥å¤„ç†ï¼›å®¢æœç¦»çº¿æ—¶è‡ªåŠ¨å›å¤ï¼Œä¿è¯æœåŠ¡è¿ç»­æ€§<br>
                    â€¢ <strong>å§‹ç»ˆå›å¤</strong>ï¼šæ— è®ºå®¢æœåœ¨çº¿æˆ–ç¦»çº¿éƒ½å›å¤ï¼Œé€‚åˆå¿«é€Ÿè§£ç­”å¸¸è§é—®é¢˜çš„åœºæ™¯
                </div>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æ¬¢è¿è¯­</div>
            </div>
            <div class="setting-help">è®¿å®¢è¿›å…¥èŠå¤©æ—¶æ˜¾ç¤ºçš„æ¬¢è¿æ¶ˆæ¯</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="chatWelcomeText" placeholder="æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ç¦»çº¿æç¤º</div>
            </div>
            <div class="setting-help">å½“å‰æ²¡æœ‰å®¢æœåœ¨çº¿æ—¶çš„æç¤ºæ¶ˆæ¯</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="chatOfflineText" placeholder="å½“å‰å®¢æœä¸åœ¨çº¿ï¼Œè¯·ç•™è¨€">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">æ’é˜Ÿæç¤º</div>
            </div>
            <div class="setting-help">è®¿å®¢éœ€è¦æ’é˜Ÿç­‰å¾…æ—¶çš„æç¤ºæ¶ˆæ¯</div>
            <div class="setting-control">
                <input type="text" class="input-field" id="chatQueueText" placeholder="å½“å‰æ’é˜Ÿäººæ•°è¾ƒå¤šï¼Œè¯·ç¨å€™">
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">ä¼šè¯è¶…æ—¶æ—¶é—´</div>
            </div>
            <div class="setting-help">è®¿å®¢æ— æ“ä½œå¤šä¹…åä¼šè¯è¶…æ—¶ï¼ˆåˆ†é’Ÿï¼‰</div>
            <div class="setting-control">
                <input type="number" class="input-field" id="sessionTimeout" placeholder="30" min="1" max="120">
                <span style="margin-left: 10px;">åˆ†é’Ÿ</span>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-header">
                <div class="setting-label">è‡ªåŠ¨å…³é—­è¶…æ—¶</div>
            </div>
            <div class="setting-help">ä¼šè¯ç»“æŸåå¤šä¹…è‡ªåŠ¨å…³é—­ï¼ˆåˆ†é’Ÿï¼‰</div>
            <div class="setting-control">
                <input type="number" class="input-field" id="autoCloseTimeout" placeholder="5" min="1" max="60">
                <span style="margin-left: 10px;">åˆ†é’Ÿ</span>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="actions">
        <button class="save-btn" onclick="saveSettings()">
            <span>ğŸ’¾</span>
            <span>ä¿å­˜è®¾ç½®</span>
        </button>
        <button class="reset-btn" onclick="loadSettings()">
            <span>ğŸ”„</span>
            <span>é‡ç½®</span>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ JS -->
<script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>

<script>
    // åˆå§‹åŒ–Quillç¼–è¾‘å™¨
    let greetingQuill;
    
    // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰è®¾ç½®
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        greetingQuill = new Quill('#greetingEditor', {
            theme: 'snow',
            placeholder: 'è¾“å…¥è®¿å®¢è¿›å…¥æ—¶çš„è‡ªåŠ¨é—®å€™è¯­...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link'],
                    ['clean']
                ]
            }
        });
        
        loadSettings();
    });

    // åŠ è½½è®¾ç½®
    function loadSettings() {
        // åŠ è½½å•†æˆ·åŸºæœ¬ä¿¡æ¯
        fetch('/api/admin/business-info')
            .then(response => response.json())
            .then(data => {
                if (data.code === 0) {
                    const business = data.data;
                    
                    // åŸºæœ¬è®¾ç½®
                    document.getElementById('businessName').value = business.business_name || '';
                    document.getElementById('copyright').value = business.copyright || '';
                    document.getElementById('lang').value = business.lang || 'cn';
                    
                    // åˆ†é…è§„åˆ™
                    document.getElementById('distributionRule').value = business.distribution_rule || 'auto';
                    
                    // åŠŸèƒ½å¼€å…³
                    setToggleState('voiceState', business.voice_state === 'open');
                    setToggleState('videoState', business.video_state === 'open');
                    setToggleState('audioState', business.audio_state === 'open');
                    setToggleState('templateState', business.template_state === 'open');
                    
                    // é€šçŸ¥è®¾ç½®
                    document.getElementById('voiceAddress').value = business.voice_address || '';
                    document.getElementById('pushUrl').value = business.push_url || '';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å•†æˆ·ä¿¡æ¯å¤±è´¥:', error);
            });
        
        // åŠ è½½ç³»ç»Ÿè®¾ç½®
        fetch('/api/admin/system-settings')
            .then(response => {
                if (response.status === 403) {
                    // æƒé™ä¸è¶³
                    throw new Error('æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿè®¾ç½®');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 0) {
                    const settings = data.data;
                    
                    // æ–‡ä»¶ä¸Šä¼ è®¾ç½®
                    document.getElementById('uploadMaxSize').value = (settings.upload_max_size / 1048576).toFixed(0);  // å­—èŠ‚è½¬MB
                    document.getElementById('uploadImageMaxSize').value = (settings.upload_image_max_size / 1048576).toFixed(0);
                    
                    // å…è®¸çš„æ–‡ä»¶ç±»å‹
                    const allowedTypes = settings.upload_allowed_types ? settings.upload_allowed_types.split(',') : [];
                    document.querySelectorAll('.file-type-checkbox').forEach(checkbox => {
                        checkbox.checked = allowedTypes.includes(checkbox.value);
                    });
                    
                    // èŠå¤©è®¾ç½®
                    if (settings.greeting_message) {
                        greetingQuill.root.innerHTML = settings.greeting_message;
                    }
                    document.getElementById('defaultMaxConcurrentChats').value = settings.default_max_concurrent_chats || 5;
                    document.getElementById('robotReplyMode').value = settings.robot_reply_mode || 'offline_only';
                    document.getElementById('chatWelcomeText').value = settings.chat_welcome_text || '';
                    document.getElementById('chatOfflineText').value = settings.chat_offline_text || '';
                    document.getElementById('chatQueueText').value = settings.chat_queue_text || '';
                    document.getElementById('sessionTimeout').value = (settings.session_timeout / 60).toFixed(0);  // ç§’è½¬åˆ†é’Ÿ
                    document.getElementById('autoCloseTimeout').value = (settings.auto_close_timeout / 60).toFixed(0);
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
            });
    }

    // ä¿å­˜è®¾ç½®
    function saveSettings() {
        // ä¿å­˜å•†æˆ·åŸºæœ¬ä¿¡æ¯
        const businessSettings = {
            business_name: document.getElementById('businessName').value,
            copyright: document.getElementById('copyright').value,
            lang: document.getElementById('lang').value,
            distribution_rule: document.getElementById('distributionRule').value,
            voice_state: getToggleState('voiceState') ? 'open' : 'close',
            video_state: getToggleState('videoState') ? 'open' : 'close',
            audio_state: getToggleState('audioState') ? 'open' : 'close',
            template_state: getToggleState('templateState') ? 'open' : 'close',
            voice_address: document.getElementById('voiceAddress').value,
            push_url: document.getElementById('pushUrl').value
        };

        // ä¿å­˜ç³»ç»Ÿè®¾ç½®
        const allowedTypes = Array.from(document.querySelectorAll('.file-type-checkbox:checked'))
            .map(cb => cb.value)
            .join(',');
        
        const systemSettings = {
            upload_max_size: parseInt(document.getElementById('uploadMaxSize').value) * 1048576,  // MBè½¬å­—èŠ‚
            upload_image_max_size: parseInt(document.getElementById('uploadImageMaxSize').value) * 1048576,
            upload_allowed_types: allowedTypes,
            default_max_concurrent_chats: parseInt(document.getElementById('defaultMaxConcurrentChats').value) || 5,
            greeting_message: greetingQuill.root.innerHTML,  // è·å–å¯Œæ–‡æœ¬å†…å®¹
            robot_reply_mode: document.getElementById('robotReplyMode').value,  // æœºå™¨äººå›å¤æ¨¡å¼
            chat_welcome_text: document.getElementById('chatWelcomeText').value,
            chat_offline_text: document.getElementById('chatOfflineText').value,
            chat_queue_text: document.getElementById('chatQueueText').value,
            session_timeout: parseInt(document.getElementById('sessionTimeout').value) * 60,  // åˆ†é’Ÿè½¬ç§’
            auto_close_timeout: parseInt(document.getElementById('autoCloseTimeout').value) * 60
        };

        // å¹¶è¡Œä¿å­˜ä¸¤ä¸ªè®¾ç½®
        Promise.all([
            fetch('/api/admin/business-info', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(businessSettings)
            }),
            fetch('/api/admin/system-settings', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(systemSettings)
            })
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            const [businessResult, systemResult] = results;
            if (businessResult.code === 0 && systemResult.code === 0) {
                showSuccess();
            } else {
                modal.error('ä¿å­˜å¤±è´¥: ' + (businessResult.msg || systemResult.msg));
            }
        })
        .catch(error => {
            console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
            modal.error('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }

    // åˆ‡æ¢å¼€å…³
    function toggleSwitch(id) {
        const element = document.getElementById(id);
        element.classList.toggle('active');
    }

    // è®¾ç½®å¼€å…³çŠ¶æ€
    function setToggleState(id, isActive) {
        const element = document.getElementById(id);
        if (isActive) {
            element.classList.add('active');
        } else {
            element.classList.remove('active');
        }
    }

    // è·å–å¼€å…³çŠ¶æ€
    function getToggleState(id) {
        return document.getElementById(id).classList.contains('active');
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess() {
        modal.success('è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼');
    }
</script>
{% endblock %}

