{% extends "admin/base.html" %}

{% block title %}å¸¸è§é—®é¢˜è®¾ç½®{% endblock %}

{% block extra_css %}
<!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .search-box input {
        flex: 1;
        max-width: 300px;
    }
    
    .faq-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .faq-table th {
        background: #f5f5f5;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
    }
    
    .faq-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .faq-table tr:hover {
        background: #fafafa;
    }
    
    .answer-preview {
        max-width: 400px;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .status-active {
        background: #e7f4e7;
        color: #2d7a2d;
    }
    
    .status-inactive {
        background: #f5f5f5;
        color: #666;
    }
    
    .action-btn {
        padding: 5px 10px;
        margin: 0 3px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-edit {
        background: #409eff;
        color: white;
    }
    
    .btn-delete {
        background: #f56c6c;
        color: white;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .faq-modal-overlay {
        display: none !important;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .faq-modal-overlay.active {
        display: flex !important;
    }
    
    .modal-container {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
    }
    
    .modal-close:hover {
        color: #333;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-label .required {
        color: #f56c6c;
    }
    
    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #409eff;
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
    }
    
    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .editor-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }
    
    #editor {
        height: 300px;
        background: white;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-primary {
        background: #409eff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #66b1ff;
    }
    
    .btn-secondary {
        background: #f5f5f5;
        color: #333;
    }
    
    .btn-secondary:hover {
        background: #e0e0e0;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“‹ å¸¸è§é—®é¢˜è®¾ç½®</h2>
    <button class="btn btn-primary" onclick="openAddModal()">
        <i class="fas fa-plus"></i> æ·»åŠ é—®é¢˜
    </button>
</div>

<div class="search-box">
    <input type="text" id="searchKeyword" class="form-input" placeholder="æœç´¢å…³é”®è¯..." onkeyup="handleSearch()">
    <button class="btn btn-secondary" onclick="loadQuestions()">
        <i class="fas fa-sync"></i> åˆ·æ–°
    </button>
</div>

<div id="tableContainer">
    <table class="faq-table">
        <thead>
            <tr>
                <th width="8%">ID</th>
                <th width="30%">é—®é¢˜</th>
                <th width="40%">ç­”æ¡ˆ</th>
                <th width="8%">æ’åº</th>
                <th width="8%">çŠ¶æ€</th>
                <th width="14%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="faqTableBody">
            <!-- æ•°æ®é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
        </tbody>
    </table>
</div>

<!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="faq-modal-overlay" id="faqModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">æ·»åŠ å¸¸è§é—®é¢˜</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editQid">
            
            <div class="form-group">
                <label class="form-label">
                    <span class="required">*</span> å¸¸è§é—®é¢˜
                </label>
                <input type="text" id="question" class="form-input" placeholder="è¯·è¾“å…¥å¸¸è§é—®é¢˜ï¼Œå¦‚ï¼šå¦‚ä½•é€€è´§ï¼Ÿå”®åæœåŠ¡æ—¶é—´ï¼Ÿ" maxlength="200">
                <small style="color: #999;">æç¤ºï¼šé—®é¢˜å°†æ˜¾ç¤ºåœ¨è®¿å®¢èŠå¤©ç•Œé¢çš„FAQæ°”æ³¡ä¸­</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ’åº</label>
                <input type="number" id="sort" class="form-input" value="0" min="0" placeholder="æ•°å­—è¶Šå¤§è¶Šé å‰">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="required">*</span> æ˜¯å¦æ˜¾ç¤º
                </label>
                <select id="status" class="form-select">
                    <option value="1">æ˜¾ç¤º</option>
                    <option value="0">ä¸æ˜¾ç¤º</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span class="required">*</span> é—®é¢˜å›ç­”
                </label>
                <div class="editor-container">
                    <div id="editor"></div>
                </div>
                <small style="color: #999;">æç¤ºï¼šæ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼ï¼Œå¯æ’å…¥é“¾æ¥ã€å›¾ç‰‡ç­‰</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveFaq()">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    let quill;
    let currentEditId = null;
    
    // åˆå§‹åŒ–Quillç¼–è¾‘å™¨
    function initQuillEditor() {
        quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'è¯·è¾“å…¥é—®é¢˜çš„ç­”æ¡ˆ...'
        });
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initQuillEditor();
        loadQuestions();
    });
    
    // åŠ è½½é—®é¢˜åˆ—è¡¨
    function loadQuestions(keyword = '') {
        let url = '/api/question/list';
        if (keyword) {
            url += `?keyword=${encodeURIComponent(keyword)}`;
        }
        
        fetch(url)
            .then(res => res.json())
            .then(result => {
                if (result.code === 0) {
                    renderTable(result.data);
                } else {
                    showError('åŠ è½½å¤±è´¥ï¼š' + result.msg);
                }
            })
            .catch(err => {
                showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
            });
    }
    
    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(questions) {
        const tbody = document.getElementById('faqTableBody');
        
        if (!questions || questions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>æš‚æ— å¸¸è§é—®é¢˜ï¼Œç‚¹å‡»å³ä¸Šè§’"æ·»åŠ é—®é¢˜"æŒ‰é’®æ·»åŠ </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = questions.map(q => `
            <tr>
                <td>${q.qid}</td>
                <td><strong>${escapeHtml(q.question)}</strong></td>
                <td>
                    <div class="answer-preview">${q.answer_text || stripHtml(q.answer)}</div>
                </td>
                <td>${q.sort || 0}</td>
                <td>
                    <span class="status-badge ${q.status === 1 ? 'status-active' : 'status-inactive'}">
                        ${q.status === 1 ? 'æ˜¾ç¤º' : 'ä¸æ˜¾ç¤º'}
                    </span>
                </td>
                <td>
                    <button class="action-btn btn-edit" onclick="editFaq(${q.qid})">ç¼–è¾‘</button>
                    <button class="action-btn btn-delete" onclick="deleteFaq(${q.qid})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
    }
    
    // æœç´¢å¤„ç†
    function handleSearch() {
        const keyword = document.getElementById('searchKeyword').value.trim();
        loadQuestions(keyword);
    }
    
    // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
    function openAddModal() {
        console.log('æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†');
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'æ·»åŠ å¸¸è§é—®é¢˜';
        document.getElementById('editQid').value = '';
        document.getElementById('question').value = '';
        document.getElementById('sort').value = '0';
        document.getElementById('status').value = '1';
        
        // æ¸…ç©ºQuillç¼–è¾‘å™¨
        if (quill) {
            quill.root.innerHTML = '';
        }
        
        const modal = document.getElementById('faqModal');
        console.log('æ¨¡æ€æ¡†å…ƒç´ :', modal);
        if (modal) {
            modal.classList.add('active');
            console.log('å·²æ·»åŠ activeç±»');
        } else {
            console.error('æ‰¾ä¸åˆ°faqModalå…ƒç´ ');
        }
    }
    
    // ç¼–è¾‘é—®é¢˜
    function editFaq(qid) {
        currentEditId = qid;
        
        // è·å–é—®é¢˜è¯¦æƒ…
        fetch(`/api/question/list`)
            .then(res => res.json())
            .then(result => {
                if (result.code === 0) {
                    const question = result.data.find(q => q.qid === qid);
                    if (question) {
                        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¸¸è§é—®é¢˜';
                        document.getElementById('editQid').value = question.qid;
                        document.getElementById('question').value = question.question;
                        document.getElementById('sort').value = question.sort || 0;
                        document.getElementById('status').value = question.status;
                        quill.root.innerHTML = question.answer || '';
                        
                        document.getElementById('faqModal').classList.add('active');
                    }
                }
            });
    }
    
    // åˆ é™¤é—®é¢˜
    function deleteFaq(qid) {
        modal.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸¸è§é—®é¢˜å—ï¼Ÿ', () => {
            fetch(`/api/question/delete/${qid}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(result => {
                if (result.code === 0) {
                    showSuccess('åˆ é™¤æˆåŠŸ');
                    loadQuestions();
                } else {
                    showError('åˆ é™¤å¤±è´¥ï¼š' + result.msg);
                }
            })
            .catch(err => {
                showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
            });
        });
    }
    
    // ä¿å­˜é—®é¢˜
    function saveFaq() {
        const question = document.getElementById('question').value.trim();
        const sort = parseInt(document.getElementById('sort').value) || 0;
        const status = parseInt(document.getElementById('status').value);
        const answerHtml = quill.root.innerHTML;
        const answerText = quill.getText().trim();
        
        // éªŒè¯
        if (!question) {
            showError('è¯·è¾“å…¥å¸¸è§é—®é¢˜');
            return;
        }
        
        if (!answerText) {
            showError('è¯·è¾“å…¥é—®é¢˜ç­”æ¡ˆ');
            return;
        }
        
        const data = {
            question: question,
            answer: answerHtml,
            answer_text: answerText,
            sort: sort,
            status: status
        };
        
        const isEdit = currentEditId !== null;
        const url = isEdit ? `/api/question/update/${currentEditId}` : '/api/question/create';
        const method = isEdit ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(result => {
            if (result.code === 0) {
                showSuccess(isEdit ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                closeModal();
                loadQuestions();
            } else {
                showError((isEdit ? 'æ›´æ–°' : 'æ·»åŠ ') + 'å¤±è´¥ï¼š' + result.msg);
            }
        })
        .catch(err => {
            showError('ç½‘ç»œé”™è¯¯ï¼š' + err.message);
        });
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        document.getElementById('faqModal').classList.remove('active');
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function stripHtml(html) {
        if (!html) return '';
        const div = document.createElement('div');
        div.innerHTML = html;
        return div.textContent.substring(0, 100) + '...';
    }
    
    function showSuccess(msg) {
        modal.success(msg);
    }
    
    function showError(msg) {
        modal.error(msg);
    }
</script>
{% endblock %}

