{% extends "admin/base.html" %}

{% block title %}é—®å€™è¯­è®¾ç½® - å®¢æœç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ CSS -->
<link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet">

<style>
    .greeting-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .greeting-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f3f4f6;
    }

    .card-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .card-title {
        flex: 1;
    }

    .card-title h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        color: #1f2937;
    }

    .card-title p {
        margin: 5px 0 0 0;
        font-size: 14px;
        color: #6b7280;
    }

    .editor-container {
        margin-top: 30px;
    }

    .editor-label {
        font-size: 15px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        display: block;
    }

    .editor-help {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 15px;
        display: block;
    }

    #greetingEditor {
        height: 400px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
    }

    .actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: flex-start;
    }

    .save-btn {
        padding: 12px 32px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .preview-btn {
        padding: 12px 32px;
        background: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .preview-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .reset-btn {
        padding: 12px 32px;
        background: white;
        color: #6b7280;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .reset-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .success-alert {
        background: #d1fae5;
        color: #065f46;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        align-items: center;
        gap: 10px;
        animation: slideDown 0.3s ease-out;
    }

    .success-alert.show {
        display: flex;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .preview-modal.show {
        display: flex;
    }

    .preview-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        position: relative;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }

    .preview-header h3 {
        margin: 0;
        font-size: 20px;
        color: #1f2937;
    }

    .close-preview {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .close-preview:hover {
        background: #f3f4f6;
        color: #1f2937;
    }

    .preview-body {
        padding: 20px;
        background: #f9fafb;
        border-radius: 8px;
        min-height: 200px;
    }

    /* Quillç¼–è¾‘å™¨å·¥å…·æ ä¼˜åŒ– */
    .ql-toolbar.ql-snow {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        background: #f9fafb;
    }

    .ql-container.ql-snow {
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ’¬ é—®å€™è¯­è®¾ç½®</h1>
    <p>é…ç½®è®¿å®¢è¿›å…¥èŠå¤©æ—¶æœºå™¨äººè‡ªåŠ¨å‘é€çš„é—®å€™æ¶ˆæ¯</p>
</div>

<div class="greeting-container">
    <div class="success-alert" id="successAlert">
        <i class="fas fa-check-circle" style="font-size: 20px;"></i>
        <span>é—®å€™è¯­å·²ä¿å­˜æˆåŠŸï¼</span>
    </div>

    <div class="greeting-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="card-title">
                <h2>è‡ªåŠ¨é—®å€™è¯­</h2>
                <p>è®¿å®¢è¿›å…¥èŠå¤©ç•Œé¢æ—¶ï¼Œæœºå™¨äººä¼šè‡ªåŠ¨å‘é€æ­¤é—®å€™æ¶ˆæ¯</p>
            </div>
        </div>

        <div class="editor-container">
            <label class="editor-label">
                <i class="fas fa-edit"></i> é—®å€™è¯­å†…å®¹
            </label>
            <span class="editor-help">
                æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼ï¼šç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€é¢œè‰²ã€å¯¹é½ã€é“¾æ¥ç­‰ã€‚é—®å€™è¯­å°†åœ¨è®¿å®¢è¿æ¥æˆåŠŸ1ç§’åè‡ªåŠ¨æ˜¾ç¤ºã€‚
            </span>
            
            <div id="greetingEditor"></div>
        </div>

        <div class="actions">
            <button class="save-btn" onclick="saveGreeting()">
                <i class="fas fa-save"></i>
                <span>ä¿å­˜é—®å€™è¯­</span>
            </button>
            <button class="preview-btn" onclick="previewGreeting()">
                <i class="fas fa-eye"></i>
                <span>é¢„è§ˆæ•ˆæœ</span>
            </button>
            <button class="reset-btn" onclick="loadGreeting()">
                <i class="fas fa-undo"></i>
                <span>é‡ç½®</span>
            </button>
        </div>
    </div>
</div>

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="preview-modal" id="previewModal" onclick="closePreview()">
    <div class="preview-content" onclick="event.stopPropagation()">
        <div class="preview-header">
            <h3><i class="fas fa-eye"></i> é—®å€™è¯­é¢„è§ˆ</h3>
            <button class="close-preview" onclick="closePreview()">Ã—</button>
        </div>
        <div class="preview-body" id="previewBody">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ JS -->
<script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>

<script>
    let greetingQuill;
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        greetingQuill = new Quill('#greetingEditor', {
            theme: 'snow',
            placeholder: 'è¾“å…¥è®¿å®¢è¿›å…¥æ—¶çš„è‡ªåŠ¨é—®å€™è¯­...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link'],
                    ['clean']
                ]
            }
        });
        
        // åŠ è½½é—®å€™è¯­
        loadGreeting();
    });

    // åŠ è½½é—®å€™è¯­
    async function loadGreeting() {
        try {
            const response = await fetch('/api/admin/system-settings');
            
            if (response.status === 403) {
                modal.error('æƒé™ä¸è¶³ï¼æ­¤é¡µé¢ä»…é™ç®¡ç†å‘˜è®¿é—®ã€‚');
                return;
            }
            
            const result = await response.json();
            
            if (result.code === 0 && result.data.greeting_message) {
                greetingQuill.root.innerHTML = result.data.greeting_message;
            } else {
                // è®¾ç½®é»˜è®¤é—®å€™è¯­
                greetingQuill.root.innerHTML = `<p><strong>æ¬¢è¿æ‚¨å…‰ä¸´æœ¬åº—ï¼</strong></p>
<p><br></p>
<p>å°Šæ•¬çš„å°ä¸»ï¼Œæ¬¢è¿å…‰ä¸´æœ¬åº—ï¼</p>
<p><strong>ã€å°æ–°æ•™è‚²ã€‘</strong>ä¸“ä¸šå›¢é˜Ÿæ—¶åˆ»å‡†å¤‡ä¸ºæ‚¨æä¾›æ›´ä¼˜æœåŠ¡ï¼ å¿«é€Ÿæåˆ†å¤‡è€ƒï¼Œå°±é€‰å°æ–°æ•™è‚²ï¼</p>
<p><br></p>
<p>è€ƒå‰è§£æè¯·ç‚¹å‡»å·¦ä¸‹è§’"äººå·¥å’¨è¯¢"è¯´æ˜ï¼ˆåœ°åŒº+æ—¶é—´ï¼‰åè‡ªåŠ©è´­ä¹°</p>
<p><br></p>
<p style="color: #e74c3c;">ç¥æ‚¨2025"æ­¥æ­¥é«˜å‡ï¼Œé‡‘æ¦œé¢˜å"</p>`;
            }
        } catch (error) {
            console.error('åŠ è½½é—®å€™è¯­å¤±è´¥:', error);
            modal.error('åŠ è½½å¤±è´¥ï¼š' + error.message);
        }
    }

    // ä¿å­˜é—®å€™è¯­
    async function saveGreeting() {
        try {
            const greetingMessage = greetingQuill.root.innerHTML;
            
            // éªŒè¯å†…å®¹ä¸ä¸ºç©º
            if (!greetingMessage.trim() || greetingMessage === '<p><br></p>') {
                modal.warning('è¯·è¾“å…¥é—®å€™è¯­å†…å®¹');
                return;
            }
            
            const response = await fetch('/api/admin/system-settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    greeting_message: greetingMessage
                })
            });
            
            if (response.status === 403) {
                modal.error('æƒé™ä¸è¶³ï¼æ— æ³•ä¿å­˜è®¾ç½®ã€‚');
                return;
            }
            
            const result = await response.json();
            
            if (result.code === 0) {
                showSuccess();
                modal.success('é—®å€™è¯­ä¿å­˜æˆåŠŸï¼');
            } else {
                modal.error('ä¿å­˜å¤±è´¥ï¼š' + result.msg);
            }
        } catch (error) {
            console.error('ä¿å­˜é—®å€™è¯­å¤±è´¥:', error);
            modal.error('ä¿å­˜å¤±è´¥ï¼š' + error.message);
        }
    }

    // é¢„è§ˆé—®å€™è¯­
    function previewGreeting() {
        const content = greetingQuill.root.innerHTML;
        document.getElementById('previewBody').innerHTML = content;
        document.getElementById('previewModal').classList.add('show');
    }

    // å…³é—­é¢„è§ˆ
    function closePreview() {
        document.getElementById('previewModal').classList.remove('show');
    }

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    function showSuccess() {
        const alert = document.getElementById('successAlert');
        alert.classList.add('show');
        setTimeout(() => {
            alert.classList.remove('show');
        }, 3000);
    }

    // ESCé”®å…³é—­é¢„è§ˆ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreview();
        }
    });
</script>
{% endblock %}

