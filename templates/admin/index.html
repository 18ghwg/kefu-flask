{% extends "admin/base.html" %}

{% block title %}ç®¡ç†åå°é¦–é¡µ{% endblock %}

{% block breadcrumb %}
<span><i class="fas fa-home"></i> <i class="fas fa-chevron-right"></i> æ§åˆ¶é¢æ¿</span>
{% endblock %}

{% block extra_css %}
<style>
    .welcome-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover-color) 100%);
        border-radius: 16px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        box-shadow: var(--shadow-heavy);
    }

    .welcome-section h1 {
        font-size: 32px;
        margin-bottom: 10px;
    }

    .welcome-section p {
        font-size: 16px;
        opacity: 0.95;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .action-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .action-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .action-card h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--text-color-dark);
    }

    .action-card p {
        font-size: 14px;
        color: var(--text-color-light);
        line-height: 1.6;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-color-light);
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-color-dark);
    }

    .stat-trend {
        font-size: 13px;
        margin-top: 8px;
    }

    .stat-trend.up {
        color: #10b981;
    }

    .stat-trend.down {
        color: #ef4444;
    }

    .system-info {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .system-info h2 {
        font-size: 20px;
        margin-bottom: 20px;
        color: var(--text-color-dark);
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        color: var(--text-color-light);
        font-size: 14px;
    }

    .info-value {
        color: var(--text-color-dark);
        font-weight: 600;
        font-size: 14px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.online {
        background: #d1fae5;
        color: #065f46;
    }
</style>
{% endblock %}

{% block content %}
<!-- æ¬¢è¿åŒºåŸŸ -->
<div class="welcome-section">
    <h1>ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ{{ current_user.nick_name }}ï¼</h1>
    <p>å½“å‰æ—¶é—´ï¼š{{ now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }} | æƒé™ç­‰çº§ï¼š{{ current_user.level }}</p>
</div>

<!-- ç»Ÿè®¡æ•°æ® -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">ğŸ“Š æ€»è®¿å®¢æ•°</div>
        <div class="stat-value" id="totalVisitors">{{ realtime.total_visitors }}</div>
        <div class="stat-trend">ç´¯è®¡è®¿é—®</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ğŸ’¬ æ­£åœ¨å’¨è¯¢</div>
        <div class="stat-value" id="activeChats">{{ realtime.chatting_count }}</div>
        <div class="stat-trend">å®æ—¶æ•°æ®</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ğŸ‘¥ åœ¨çº¿å®¢æœ</div>
        <div class="stat-value" id="onlineServices">{{ realtime.online_services }}</div>
        <div class="stat-trend">å®æ—¶çŠ¶æ€</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">â±ï¸ æ’é˜Ÿäººæ•°</div>
        <div class="stat-value" id="waitingCount">{{ realtime.waiting_count }}</div>
        <div class="stat-trend">{{ 'ç­‰å¾…ä¸­' if realtime.waiting_count > 0 else 'æ— æ’é˜Ÿ' }}</div>
    </div>
</div>

<!-- å¿«æ·æ“ä½œ -->
<div class="quick-actions">
    <a href="/service/chat" class="action-card">
        <div class="action-icon">ğŸ’¬</div>
        <h3>å®¢æœå·¥ä½œå°</h3>
        <p>è¿›å…¥å®¢æœèŠå¤©ç•Œé¢ï¼Œå¼€å§‹æ¥å¾…è®¿å®¢</p>
    </a>

    <a href="/admin/visitors" class="action-card">
        <div class="action-icon">ğŸ‘¥</div>
        <h3>è®¿å®¢ç®¡ç†</h3>
        <p>æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è®¿å®¢ä¿¡æ¯</p>
    </a>

    <a href="/admin/dashboard" class="action-card">
        <div class="action-icon">ğŸ“Š</div>
        <h3>æ•°æ®çœ‹æ¿</h3>
        <p>æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡æ•°æ®å’Œå›¾è¡¨åˆ†æ</p>
    </a>

    <a href="/admin/knowledge" class="action-card">
        <div class="action-icon">ğŸ“š</div>
        <h3>çŸ¥è¯†åº“</h3>
        <p>ç®¡ç†æ™ºèƒ½æœºå™¨äººçš„é—®ç­”çŸ¥è¯†</p>
    </a>

    <a href="/admin/services" class="action-card">
        <div class="action-icon">ğŸ‘¨â€ğŸ’¼</div>
        <h3>å®¢æœç®¡ç†</h3>
        <p>æ·»åŠ ã€ç¼–è¾‘å’Œç®¡ç†å®¢æœäººå‘˜</p>
    </a>

    <a href="/admin/queue-management" class="action-card">
        <div class="action-icon">ğŸ“‹</div>
        <h3>é˜Ÿåˆ—ç®¡ç†</h3>
        <p>å®æ—¶ç›‘æ§æ’é˜Ÿå’Œä¼šè¯åˆ†é…</p>
    </a>

    <a href="/admin/comments" class="action-card">
        <div class="action-icon">â­</div>
        <h3>è¯„ä»·ç®¡ç†</h3>
        <p>æŸ¥çœ‹è®¿å®¢å¯¹æœåŠ¡çš„è¯„ä»·åé¦ˆ</p>
    </a>

    <a href="/admin/system-settings" class="action-card">
        <div class="action-icon">âš™ï¸</div>
        <h3>ç³»ç»Ÿè®¾ç½®</h3>
        <p>é…ç½®ç³»ç»Ÿå‚æ•°å’ŒåŠŸèƒ½å¼€å…³</p>
    </a>
</div>

<!-- ç³»ç»Ÿä¿¡æ¯ -->
<div class="system-info">
    <h2>ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</h2>
    <div class="info-item">
        <span class="info-label">ç³»ç»ŸçŠ¶æ€</span>
        <span class="info-value">
            <span class="status-badge online">â— è¿è¡Œä¸­</span>
        </span>
    </div>
    <div class="info-item">
        <span class="info-label">ç³»ç»Ÿç‰ˆæœ¬</span>
        <span class="info-value">v1.0-beta</span>
    </div>
    <div class="info-item">
        <span class="info-label">æ•°æ®åº“</span>
        <span class="info-value">MySQL 8.0</span>
    </div>
    <div class="info-item">
        <span class="info-label">ç¼“å­˜</span>
        <span class="info-value">Redis 6.0</span>
    </div>
    <div class="info-item">
        <span class="info-label">Webæ¡†æ¶</span>
        <span class="info-value">Flask 2.3</span>
    </div>
    <div class="info-item">
        <span class="info-label">å®æ—¶é€šä¿¡</span>
        <span class="info-value">Socket.IO 5.0</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    // Socket.IOè¿æ¥ï¼ˆç”¨äºå®æ—¶æ›´æ–°ï¼‰
    let socket = null;
    
    // åˆå§‹åŒ–Socket.IOè¿æ¥
    function initSocketIO() {
        socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });
        
        socket.on('connect', function() {
            console.log('âœ… Socket.IOè¿æ¥æˆåŠŸ');
            
            // ç®¡ç†å‘˜åŠ å…¥ç®¡ç†å‘˜æˆ¿é—´ä»¥æ¥æ”¶ç»Ÿè®¡æ›´æ–°
            socket.emit('admin_join', {
                service_id: '{{ current_user.service_id }}',
                service_name: '{{ current_user.nick_name }}'
            });
        });
        
        socket.on('disconnect', function() {
            console.log('âŒ Socket.IOæ–­å¼€è¿æ¥');
        });
        
        // ç›‘å¬å®æ—¶ç»Ÿè®¡æ•°æ®æ›´æ–°
        socket.on('statistics_update', function(data) {
            console.log('ğŸ“Š æ”¶åˆ°ç»Ÿè®¡æ•°æ®æ›´æ–°:', data);
            updateDashboardStats(data);
        });
        
        // ç›‘å¬ä¼šè¯çŠ¶æ€å˜åŒ–ï¼ˆæ–°ä¼šè¯ã€ä¼šè¯ç»“æŸç­‰ï¼‰
        socket.on('session_created', function(data) {
            console.log('ğŸ†• æ–°ä¼šè¯åˆ›å»º');
            loadDashboardData(); // åˆ·æ–°æ•°æ®
        });
        
        socket.on('session_ended', function(data) {
            console.log('âœ… ä¼šè¯ç»“æŸ');
            loadDashboardData(); // åˆ·æ–°æ•°æ®
        });
        
        socket.on('error', function(error) {
            console.error('Socket.IOé”™è¯¯:', error);
        });
    }
    
    // æ›´æ–°ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®
    function updateDashboardStats(data) {
        if (data.total_visitors !== undefined) {
            document.getElementById('totalVisitors').textContent = data.total_visitors;
        }
        
        if (data.chatting_count !== undefined) {
            document.getElementById('activeChats').textContent = data.chatting_count;
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            const element = document.getElementById('activeChats');
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }
        
        if (data.online_services !== undefined) {
            document.getElementById('onlineServices').textContent = data.online_services;
        }
        
        if (data.waiting_count !== undefined) {
            document.getElementById('waitingCount').textContent = data.waiting_count;
        }
    }
    
    // åŠ è½½å®æ—¶æ•°æ®ï¼ˆå¤‡ç”¨/åˆå§‹åŒ–ï¼‰
    function loadDashboardData() {
        // è·å–ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨ç®¡ç†åå°ä¸“ç”¨çš„APIï¼‰
        fetch('/api/admin/statistics/overview?days=1')
            .then(response => response.json())
            .then(result => {
                if (result.code === 0) {
                    const data = result.data;
                    
                    // æ›´æ–°è®¿å®¢æ•°
                    if (data.visitors && data.visitors.total !== undefined) {
                        document.getElementById('totalVisitors').textContent = data.visitors.total;
                    }
                    
                    // æ›´æ–°åœ¨çº¿å®¢æœæ•°
                    if (data.services && data.services.online !== undefined) {
                        document.getElementById('onlineServices').textContent = data.services.online;
                    }
                    
                    // âš ï¸ æ³¨æ„ï¼š"æ­£åœ¨å’¨è¯¢"æ•°é‡ç”±Socket.IOå®æ—¶æ›´æ–°ï¼Œè¿™é‡Œä¸æ›´æ–°
                    // é¿å…ä½¿ç”¨å‘¨æœŸä¼šè¯æ•°ï¼ˆperiodï¼‰è¦†ç›–å®æ—¶æ•°æ®
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŠ è½½æ•°æ®
        loadDashboardData();
        
        // åˆå§‹åŒ–WebSocketè¿æ¥å®æ—¶æ›´æ–°
        initSocketIO();
        
        // æ¯60ç§’å¤‡ä»½åˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼ˆé˜²æ­¢WebSocketæ–­å¼€ï¼‰
        setInterval(loadDashboardData, 60000);
    });
</script>
{% endblock %}
