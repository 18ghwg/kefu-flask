<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}ç®¡ç†åå°{% endblock %} - å®¢æœç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/font-awesome/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-switcher.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    {% include 'includes/navbar.html' %}

    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    {% include 'includes/sidebar.html' %}

    <!-- é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="mainContent">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="breadcrumb">
            <a href="/admin"><i class="fas fa-home"></i> é¦–é¡µ</a>
            {% block breadcrumb %}{% endblock %}
        </div>
        
        <!-- é¡µé¢å†…å®¹ -->
        {% block content %}{% endblock %}
    </main>

    <!-- å…¨å±€åº•éƒ¨æ  -->
    {% include 'includes/footer.html' %}

    <!-- Socket.IOå®¢æˆ·ç«¯ -->
    <script src="{{ url_for('static', filename='js/vendor/socket.io.min.js') }}"></script>
    
    <!-- ä¸»é¢˜ç®¡ç†å™¨ -->
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    
    <!-- CSRFä¿æŠ¤ -->
    <script src="{{ url_for('static', filename='js/csrf_handler.js') }}"></script>
    
    <!-- é€šç”¨æ¨¡æ€å¼¹çª— -->
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    
    <!-- åŸºç¡€è„šæœ¬ -->
    <script>
        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('show');
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ç”¨æˆ·èœå•
        window.addEventListener('click', function(e) {
            if (!e.target.matches('.nav-link') && !e.target.closest('.dropdown')) {
                const menu = document.getElementById('userMenu');
                if (menu && menu.classList.contains('show')) {
                    menu.classList.remove('show');
                }
            }
        });

        // åˆ‡æ¢å­èœå•
        function toggleSubmenu(element) {
            const menuItem = element.parentElement;
            const submenu = menuItem.querySelector('.submenu');
            const arrow = element.querySelector('.submenu-arrow');
            
            // å…³é—­å…¶ä»–å­èœå•
            document.querySelectorAll('.menu-item.has-submenu').forEach(item => {
                if (item !== menuItem) {
                    item.classList.remove('open');
                }
            });
            
            // åˆ‡æ¢å½“å‰å­èœå•
            menuItem.classList.toggle('open');
        }

        // å“åº”å¼ä¾§è¾¹æ 
        let userToggledSidebar = false; // æ ‡è®°ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨åˆ‡æ¢è¿‡
        
        // ä¿å­˜åŸå§‹çš„ toggleSidebar å‡½æ•°
        const originalToggleSidebar = toggleSidebar;
        
        // é‡æ–°å®šä¹‰ toggleSidebar ä¸ºåŒ…è£…å‡½æ•°
        toggleSidebar = function() {
            userToggledSidebar = true; // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('sidebarOverlay');
            
            // åˆ‡æ¢çŠ¶æ€
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            
            // ç§»åŠ¨ç«¯æ§åˆ¶é®ç½©å±‚
            if (window.innerWidth <= 768 && overlay) {
                overlay.classList.toggle('show');
            }
            
            console.log('ğŸ“± ä¾§è¾¹æ åˆ‡æ¢:', sidebar.classList.contains('collapsed') ? 'æ”¶èµ·' : 'å±•å¼€');
        };
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('sidebarOverlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                });
            }
            
            // ç§»åŠ¨ç«¯ç‚¹å‡»èœå•é“¾æ¥åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
            const menuLinks = document.querySelectorAll('.menu-link[href], .submenu-link[href]');
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // åªåœ¨ç§»åŠ¨ç«¯ä¸”ä¾§è¾¹æ å±•å¼€æ—¶å…³é—­
                    if (window.innerWidth <= 768) {
                        const sidebar = document.getElementById('sidebar');
                        if (!sidebar.classList.contains('collapsed')) {
                            console.log('ğŸ“± ç§»åŠ¨ç«¯ï¼šç‚¹å‡»èœå•ï¼Œè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ ');
                            toggleSidebar();
                        }
                    }
                });
            });
        });
        
        function checkScreenSize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.getElementById('sidebarOverlay');
            
            // å¦‚æœç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢è¿‡ï¼Œå°±ä¸å†è‡ªåŠ¨è°ƒæ•´
            if (userToggledSidebar) {
                console.log('â¸ï¸ ç”¨æˆ·å·²æ‰‹åŠ¨æ“ä½œï¼Œè·³è¿‡è‡ªåŠ¨è°ƒæ•´');
                return;
            }
            
            if (window.innerWidth <= 768) {
                // ç§»åŠ¨ç«¯é»˜è®¤æ”¶èµ·
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                if (overlay) overlay.classList.remove('show');
                console.log('ğŸ“± ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ è‡ªåŠ¨æ”¶èµ·');
            } else {
                // æ¡Œé¢ç«¯é»˜è®¤å±•å¼€
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                if (overlay) overlay.classList.remove('show');
                console.log('ğŸ’» æ¡Œé¢ç«¯ï¼šä¾§è¾¹æ è‡ªåŠ¨å±•å¼€');
            }
        }

        window.addEventListener('resize', checkScreenSize);
        checkScreenSize();
    </script>
    
    <!-- å…¨å±€Socket.IOè¿æ¥å’Œæ¶ˆæ¯é€šçŸ¥ -->
    <script src="{{ url_for('static', filename='js/admin/global_socket.js') }}"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

